<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Plateforme CCTP — Domaines & Jeux (A/B)</title>
<style>
  :root{
    --primary:#0a74da;--primary-dark:#095aba;--bg:#f4f7fb;--card:#fff;--text:#22324a;
    --muted:#64748b;--ok:#0f7a31;--soft:#e9eef5
  }
  *{box-sizing:border-box}
  body{font-family:Arial,Helvetica,sans-serif;margin:0;background:var(--bg);color:var(--text);overflow-x:hidden}
  .container{max-width:1100px;margin:0 auto;padding:clamp(16px,4vw,32px)}
  .screen{display:none;animation:fade .25s ease} .active{display:block}
  @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
  h1,h2,h3{margin:0 0 .8rem}
  .muted{color:var(--muted)}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem}
  .card{background:#fff;border-radius:14px;box-shadow:0 10px 26px rgba(0,0,0,.08);padding:1rem}
  .btn{padding:.7rem 1.1rem;background:var(--primary);color:#fff;border:none;border-radius:10px;font-weight:700;cursor:pointer}
  .btn:hover{background:var(--primary-dark)}
  .btn.secondary{background:var(--soft);color:#1b304a}
  .hero{width:100%;max-width:980px;border-radius:16px;box-shadow:0 10px 26px rgba(0,0,0,.08);display:block;margin:0 auto 12px;object-fit:contain;max-height:60vh}
  .map{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem;margin-top:1rem}
  .location{background:#fff;padding:1rem;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.06);text-align:center;cursor:pointer;transition:transform .15s ease,box-shadow .2s ease}
  .location:hover{transform:translateY(-2px);box-shadow:0 10px 22px rgba(0,0,0,.08)}
  .location img{width:48px;height:48px;margin-bottom:.5rem}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:999}
  .overlay.active{display:block}
  .modal{position:fixed;top:5%;left:50%;transform:translateX(-50%);background:#fff;padding:clamp(16px,3vw,24px);border-radius:14px;box-shadow:0 18px 50px rgba(0,0,0,.25);display:none;z-index:1000;width:min(92vw,820px);max-height:90vh;overflow:auto}
  .modal.active{display:block}
  .modal img{max-width:100%;max-height:40vh;object-fit:contain;display:block;margin:0 auto .6rem}
  .modal p{white-space:pre-wrap;line-height:1.4}
  .info-log{margin-top:.6rem;color:var(--ok)}
  .notice{background:#f8fafc;border:1px solid #d1d5db;border-radius:12px;padding:1rem;margin-top:1rem;display:none}

  /* Builder (QCM) */
  .tabs{display:flex;flex-wrap:wrap;gap:.5rem;margin-bottom:.8rem;}
  .tab-btn{padding:.45rem .7rem;border-radius:10px;border:1px solid #d8e0ea;background:#fff;cursor:pointer;font-size:.92rem;color:#213347;}
  .tab-btn.active{background:#0a74da;color:#fff;border-color:#0a74da;}
  .tab-panel{display:none;background:#fff;padding:1rem;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.06);}
  .tab-panel.active{display:block;}
  .progress{height:10px;background:#e9eef5;border-radius:999px;overflow:hidden;margin:10px 0 18px;}
  .progress>span{display:block;height:100%;background:#0a74da;width:0%;transition:width .25s ease;}
  .option-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:.75rem;margin-top:.75rem;}
  .option{border:1px solid #e6e6e6;border-radius:10px;padding:.75rem;background:#fafafa;}
  .option label{display:block;cursor:pointer;line-height:1.35;}
  .helper{font-size:.92rem;color:#526479;margin:.4rem 0 .1rem}
  .warn{color:#b54708;background:#fff7ed;padding:.5rem .75rem;border-radius:8px;border:1px solid #fde68a;display:none;margin-top:.5rem;}
  .summary{background:#fff;padding:1rem;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.06);}
  .score{margin-top:12px;background:#f0f9ff;border:1px solid #bae6fd;color:#0c4a6e;padding:.75rem 1rem;border-radius:12px;font-weight:600;display:none;}
  .badge{display:inline-block;padding:.35rem .6rem;border-radius:999px;font-size:.9rem;font-weight:700;margin-left:.5rem;}
  .badge.debutant{background:#fff7ed;color:#b45309;border:1px solid #fed7aa;}
  .badge.avance{background:#eff6ff;color:#1d4ed8;border:1px solid #93c5fd;}
  .badge.expert{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0;}
  .badge.genie{background:#f5f3ff;color:#6d28d9;border:1px solid #ddd6fe;}
  .errors{margin-top:10px;background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:.75rem 1rem;display:none;}
  .errors h4{margin:.2rem 0 .4rem;}
  .errors ul{margin:.2rem 0 0 1rem;}
  .toggle{margin-top:8px;background:#e9eef5;color:#22324a;}
</style>
</head>
<body>

<script>
/* -------- Router simple (hash) -------- */
(function () {
  function show(id) {
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
    const el = document.getElementById(id) || document.getElementById('home');
    if (el) el.classList.add('active');
    try { window.scrollTo(0, 0); } catch(e) {}
  }
  window.goTo = function (id) {
    show(id);
    try { history.replaceState(null, '', '#' + id); } catch (e) { location.hash = id; }
  };
  window.addEventListener('hashchange', function () {
    show((location.hash || '#home').slice(1));
  });
  show((location.hash || '#home').slice(1) || 'home');
})();
</script>

<!-- ACCUEIL -->
<div id="home" class="screen active">
  <div class="container">
    <img class="hero" src="images/accueil_salle_formation.png" alt="Salle de formation moderne en Guyane">
    <h2>Choisissez votre domaine</h2>
    <div class="grid">
      <div class="card">
        <h3>Jeux de l'entreprise LESATI (Thermique, Hydraulique, Smart Grids)</h3>
        <div class="muted" style="margin-bottom:.5rem">Domaine Production</div>
        <button class="btn" onclick="goTo('domain_production')">Accéder</button>
      </div>
      <div class="card">
        <h3>Jeux de l'entreprise COPAYA (Réseaux & Exploitation)</h3>
        <div class="muted" style="margin-bottom:.5rem">Domaine Réseau</div>
        <button class="btn" onclick="goTo('domain_reseau')">Accéder</button>
      </div>
      <div class="card">
        <h3>Jeux de l'entreprise TILESA (Tertiaire et Telecom)</h3>
        <div class="muted" style="margin-bottom:.5rem">Domaine Tertiaire</div>
        <button class="btn" onclick="goTo('domain_tertiaire')">Accéder</button>
      </div>
    </div>
  </div>
</div>

<!-- DOMAINES -->
<div id="domain_production" class="screen"><div class="container">
  <h2>Domaine Production — LESATI</h2>
  <div class="grid">
    <div class="card">
      <h3>Jeu A — Centrale Thermique (Léa)</h3>
      <p class="muted">Centrale Thermique : explorez les services de la centrale thermique, puis rédigez le cahier des charges.</p>
      <button class="btn" onclick="goTo('game2_intro')">Lancer le Jeu A</button>
    </div>
    <div class="card">
      <h3>Jeu B — Centrale Hydraulique (Léon)</h3>
      <p class="muted">Centrale Hydraulique : explorez les services de la centrale hydraulique, puis rédigez le cahier des charges.</p>
      <button class="btn" onclick="goTo('game3_intro')">Lancer le Jeu B</button>
    </div>
  </div>
  <button class="btn secondary" onclick="goTo('home')">⬅ Retour accueil</button>
</div></div>

<div id="domain_reseau" class="screen"><div class="container">
  <h2>Domaine Réseau — COPAYA</h2>
  <div class="grid">
    <div class="card">
      <h3>Jeu A — Élagage (Sylvie)</h3>
      <p class="muted">Élagage : explorez les services, puis rédigez le cahier des charges.</p>
      <button class="btn" onclick="goTo('game4_intro')">Lancer le Jeu A</button>
    </div>
    <div class="card">
      <h3>Jeu B — Raccordement HTA (Carl)</h3>
      <p class="muted">Raccordement HTA : explorez les services, puis rédigez le cahier des charges.</p>
      <button class="btn" onclick="goTo('game5_intro')">Lancer le Jeu B</button>
    </div>
  </div>
  <button class="btn secondary" onclick="goTo('home')">⬅ Retour accueil</button>
</div></div>

<div id="domain_tertiaire" class="screen"><div class="container">
  <h2>Domaine Tertiaire — TILESA</h2>
  <div class="grid">
    <div class="card">
      <h3>Jeu A — Nettoyage des Sites (Alex)</h3>
      <p class="muted">Nettoyage des sites : Explorez les services, puis rédigez le cahier des charges.</p>
      <button class="btn" onclick="goTo('game1_intro')">Lancer le Jeu A</button>
    </div>
    <div class="card">
      <h3>Jeu B — Véhicules Électriques (Manon)</h3>
      <p class="muted">Véhicules Électriques : Explorez les services, puis rédigez le cahier des charges.</p>
      <button class="btn" onclick="goTo('game6_intro')">Lancer le Jeu B</button>
    </div>
  </div>
  <button class="btn secondary" onclick="goTo('home')">⬅ Retour accueil</button>
</div></div>

<!-- INTROS -->
<div id="game1_intro" class="screen"><div class="container">
  <img class="hero" src="images/tilesia_accueil_alex.png" alt="">
  <h2>TILESA — Jeu A (Nettoyage des sites)</h2>
  <button class="btn" onclick="goTo('game1')">Démarrer la mission</button>
  <button class="btn secondary" onclick="goTo('domain_tertiaire')">⬅ Retour domaine</button>
</div></div>

<div id="game2_intro" class="screen"><div class="container">
  <img class="hero" src="images/lea_centrale_LESATI.png" alt="">
  <h2>LESATI — Jeu A (Centrale Thermique)</h2>
  <p>Léa, chargée d'affaires du service production, est volontaire pour réaliser l'expression du besoin. Il s'agit de l'achat de 3 nouveaux groupes électrogènes.</p>
  <button class="btn" onclick="goTo('game2')">Démarrer la mission</button>
  <button class="btn secondary" onclick="goTo('domain_production')">⬅ Retour domaine</button>
</div></div>

<div id="game3_intro" class="screen"><div class="container">
  <img class="hero" src="images/leon_centrale_LESATI.png" alt="">
  <h2>LESATI — Jeu B (Centrale Hydraulique)</h2>
  <p>Léon, nouveau chef de projet de la centrale hydraulique, est volontaire pour rédiger le cahier des charges concernant l’achat de pièces de rechange.</p>
  <button class="btn" onclick="goTo('game3')">Démarrer la mission</button>
  <button class="btn secondary" onclick="goTo('domain_production')">⬅ Retour domaine</button>
</div></div>

<div id="game4_intro" class="screen"><div class="container">
  <img class="hero" src="images/copaya_accueil.png" alt="">
  <h2>COPAYA — Jeu A (Élagage)</h2>
  <p>Vous incarnez Sylvie, chargée d’affaires chez Copaya. Vous devez rédiger le cahier des charges pour les prestations d’élagage. La consultation sera lancée dans 8 mois.</p>
  <button class="btn" onclick="goTo('game4')">Démarrer la mission</button>
  <button class="btn secondary" onclick="goTo('domain_reseau')">⬅ Retour domaine</button>
</div></div>

<div id="game5_intro" class="screen"><div class="container">
  <img class="hero" src="images/copaya_intro.png" alt="">
  <h2>COPAYA — Jeu B (Raccordement HTA)</h2>
  <p>Vous incarnez Carl, nouveau chargé d’affaires réseau. Vous devez rédiger un cahier des charges pour le raccordement HTA d’un village. Lancement de la consultation dans 9 mois.</p>
  <button class="btn" onclick="goTo('game5')">Démarrer la mission</button>
  <button class="btn secondary" onclick="goTo('domain_reseau')">⬅ Retour domaine</button>
</div></div>

<div id="game6_intro" class="screen"><div class="container">
  <img class="hero" src="images/accueil_sabrina.png" alt="">
  <h2>TILESA — Jeu B (Véhicules Électriques)</h2>
  <p>Vous incarnez Manon, pilote de la maintenance des véhicules. Vous rédigez le CCTP pour l’achat de véhicules électriques neufs afin de renouveler la flotte. Lancement de la consultation dans 9 mois.</p>
  <button class="btn" onclick="goTo('game6')">Démarrer la mission</button>
  <button class="btn secondary" onclick="goTo('domain_tertiaire')">⬅ Retour domaine</button>
</div></div>

<!-- CARTES / JEUX -->
<div id="game1" class="screen"><div class="container">
  <h2>TILESA — Jeu A (Nettoyage des sites)</h2>
  <div class="map">
    <div class="location" onclick="openModal('Direction',1)"><img src="https://cdn-icons-png.flaticon.com/512/219/219986.png" alt="">Direction</div>
    <div class="location" onclick="openModal('Technique',1)"><img src="https://cdn-icons-png.flaticon.com/512/2621/2621140.png" alt="">Technique</div>
    <div class="location" onclick="openModal('Salaries',1)"><img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="">Salariés</div>
    <div class="location" onclick="openModal('Juridique',1)"><img src="https://cdn-icons-png.flaticon.com/512/2569/2569069.png" alt="">Juridique</div>
  </div>
  <div class="info-log" id="infoLog1"></div>
  <button id="btnCCTP1" class="btn" disabled onclick="validateCollection(1)">Rédiger le cahier des charges</button>
  <button class="btn secondary btn-return" data-target="domain_tertiaire">⬅ Retour carte</button>
</div></div>

<div id="game2" class="screen"><div class="container">
  <h2>LESATI — Jeu A (Centrale Thermique)</h2>
  <div class="map">
    <div class="location" onclick="openModal('Direction',2)"><img src="https://cdn-icons-png.flaticon.com/512/219/219986.png" alt="">Direction</div>
    <div class="location" onclick="openModal('Service production',2)"><img src="https://cdn-icons-png.flaticon.com/512/1995/1995525.png" alt="">Service production</div>
    <div class="location" onclick="openModal('Salaries',2)"><img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="">Salariés</div>
    <div class="location" onclick="openModal('Juridique',2)"><img src="https://cdn-icons-png.flaticon.com/512/2569/2569069.png" alt="">Juridique</div>
  </div>
  <div class="info-log" id="infoLog2"></div>
  <button id="btnCCTP2" class="btn" disabled onclick="validateCollection(2)">Rédiger le cahier des charges</button>
  <button class="btn secondary btn-return" data-target="domain_production">⬅ Retour carte</button>
</div></div>

<div id="game3" class="screen"><div class="container">
  <h2>LESATI — Jeu B (Centrale Hydraulique)</h2>
  <div class="map">
    <div class="location" onclick="openModal('Direction B',3)"><img src="https://cdn-icons-png.flaticon.com/512/219/219986.png" alt="">Direction</div>
    <div class="location" onclick="openModal('Manager',3)"><img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="">Manager</div>
    <div class="location" onclick="openModal('Maintenance',3)"><img src="https://cdn-icons-png.flaticon.com/512/1995/1995525.png" alt="">Maintenance</div>
    <div class="location" onclick="openModal('Juridique B',3)"><img src="https://cdn-icons-png.flaticon.com/512/2569/2569069.png" alt="">Juridique</div>
    <div class="location" onclick="openModal('Sécurité',3)"><img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="">Sécurité</div>
  </div>
  <div class="info-log" id="infoLog3"></div>
  <button id="btnCCTP3" class="btn" disabled onclick="validateCollection(3)">Rédiger le cahier des charges</button>
  <button class="btn secondary btn-return" data-target="domain_production">⬅ Retour carte</button>
</div></div>

<div id="game4" class="screen"><div class="container">
  <h2>COPAYA — Jeu A (Élagage)</h2>
  <div class="map">
    <div class="location" onclick="openModal('Direction Copaya',4)"><img src="https://cdn-icons-png.flaticon.com/512/219/219986.png" alt="">Direction</div>
    <div class="location" onclick="openModal('Clients Copaya',4)"><img src="https://cdn-icons-png.flaticon.com/512/602/602220.png" alt="">Clients</div>
    <div class="location" onclick="openModal('Maintenance Copaya',4)"><img src="https://cdn-icons-png.flaticon.com/512/1995/1995525.png" alt="">Maintenance</div>
    <div class="location" onclick="openModal('Environnement Copaya',4)"><img src="https://cdn-icons-png.flaticon.com/512/1535/1535791.png" alt="">Environnement</div>
    <div class="location" onclick="openModal('Sécurité Copaya',4)"><img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="">Sécurité</div>
  </div>
  <div class="info-log" id="infoLog4"></div>
  <button id="btnCCTP4" class="btn" disabled onclick="validateCollection(4)">Rédiger le cahier des charges</button>
  <button class="btn secondary btn-return" data-target="domain_reseau">⬅ Retour carte</button>
</div></div>

<div id="game5" class="screen"><div class="container">
  <h2>COPAYA — Jeu B (Raccordement HTA)</h2>
  <div class="map">
    <div class="location" onclick="openModal('Directrice Carl',5)"><img src="https://cdn-icons-png.flaticon.com/512/219/219986.png" alt="">Directrice</div>
    <div class="location" onclick="openModal('Équipe Carl',5)"><img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="">Équipe</div>
    <div class="location" onclick="openModal('Manager Carl',5)"><img src="https://cdn-icons-png.flaticon.com/512/1995/1995525.png" alt="">Manager</div>
    <div class="location" onclick="openModal('Habitants Carl',5)"><img src="https://cdn-icons-png.flaticon.com/512/1484/1484825.png" alt="">Habitants</div>
    <div class="location" onclick="openModal('Juriste Carl',5)"><img src="https://cdn-icons-png.flaticon.com/512/2569/2569069.png" alt="">Juriste</div>
    <div class="location" onclick="openModal('Prévention Carl',5)"><img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="">Prévention</div>
  </div>
  <div class="info-log" id="infoLog5"></div>
  <button id="btnCCTP5" class="btn" disabled onclick="validateCollection(5)">Rédiger le cahier des charges</button>
  <button class="btn secondary btn-return" data-target="domain_reseau">⬅ Retour carte</button>
</div></div>

<div id="game6" class="screen"><div class="container">
  <h2>TILESA — Jeu B (Véhicules Électriques)</h2>
  <div class="map">
    <div class="location" onclick="openModal('Direction Tilesa B',6)"><img src="https://cdn-icons-png.flaticon.com/512/219/219986.png" alt="">Direction</div>
    <div class="location" onclick="openModal('Juriste Tilesa B',6)"><img src="https://cdn-icons-png.flaticon.com/512/2569/2569069.png" alt="">Juriste</div>
    <div class="location" onclick="openModal('Manager Tilesa B',6)"><img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="">Manager</div>
    <div class="location" onclick="openModal('Services Tilesa B',6)"><img src="https://cdn-icons-png.flaticon.com/512/1484/1484825.png" alt="">Services</div>
    <div class="location" onclick="openModal('Technique Tilesa B',6)"><img src="https://cdn-icons-png.flaticon.com/512/1995/1995525.png" alt="">Technique</div>
    <div class="location" onclick="openModal('Environnement Tilesa B',6)"><img src="https://cdn-icons-png.flaticon.com/512/1535/1535791.png" alt="">Resp. environnement</div>
  </div>
  <div class="info-log" id="infoLog6"></div>
  <button id="btnCCTP6" class="btn" disabled onclick="validateCollection(6)">Rédiger le cahier des charges</button>
  <button class="btn secondary btn-return" data-target="domain_tertiaire">⬅ Retour carte</button>
</div></div>

<!-- MODALE -->
<div class="overlay" id="overlay" onclick="closeModal()"></div>
<div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <h3 id="modalTitle"></h3>
  <img id="modalImage" src="" alt="Illustration">
  <p id="modalText"></p>
  <div style="display:flex;gap:.5rem;margin-top:.7rem">
    <button class="btn" onclick="collectInfo()">Collecter l'information</button>
    <button class="btn secondary" onclick="closeModal()">Retour</button>
  </div>
</div>

<!-- BUILDER + SUMMARY (écrans partagés pour tous les jeux) -->
<div id="builder" class="screen"><div class="container">
  <h2 id="builderTitle">Assistant (QCM)</h2>
  <div class="small">Sélectionnez les éléments pertinents à chaque étape. Les aides sont disponibles au besoin.</div>
  <div class="progress"><span id="builderProgress"></span></div>
  <div class="tabs" id="builderTabs"></div>
  <div id="builderPanels"></div>
  <div class="warn" id="builderWarn">Veuillez sélectionner au moins un élément dans cet onglet pour continuer.</div>
  <div style="display:flex;gap:.5rem;justify-content:space-between;margin-top:1rem;">
    <button class="btn secondary" id="prevStep">◀ Précédent</button>
    <div>
      <button class="btn secondary btn-return" id="btnBackToMap">Sauvegarder & Revenir à la carte</button>
      <button class="btn" id="nextStep">Suivant ▶</button>
      <button class="btn" id="finishBuilder" style="display:none">Générer le résumé</button>
    </div>
  </div>
</div></div>

<div id="summary" class="screen"><div class="container">
  <h2 id="summaryTitle">Résumé</h2>
  <div class="summary" id="summaryContent"></div>
  <div id="scoreContent" class="score"></div>
  <button class="btn toggle" id="toggleErrors" style="display:none">Voir mes erreurs</button>
  <div id="errorsPanel" class="errors"></div>
  <div style="display:flex; gap:.5rem; margin-top:12px;">
    <button class="btn" id="btnSummaryBack">Retour à la carte</button>
  </div>
</div></div>

<script>
/* ======================= Logique collecte & navigation ======================= */
const collectedByGame = {1:new Set(),2:new Set(),3:new Set(),4:new Set(),5:new Set(),6:new Set()};
let currentGameId = 0;
let currentServiceName = "";

function requiredCount(gameId){
  const wrap = document.querySelector('#game'+gameId+' .map');
  return wrap ? wrap.querySelectorAll('.location').length : 0;
}
function updateCCTPButton(gameId){
  const need = requiredCount(gameId);
  const have = collectedByGame[gameId]?.size ?? 0;
  const btn  = document.getElementById('btnCCTP'+gameId);
  if(!btn) return;
  const ok = need>0 && have>=need;
  btn.disabled = !ok;
  btn.style.opacity = ok ? '1' : '.55';
  btn.title = ok ? '' : 'Visitez tous les services avant de rédiger';
}
[1,2,3,4,5,6].forEach(id=>updateCCTPButton(id));

function openModal(serviceName, gameId){
  currentGameId = gameId;
  currentServiceName = serviceName;
  const data = modalDataFor(gameId);
  const item = data[serviceName];
  document.getElementById('modalTitle').innerText = labelShort(serviceName);
  document.getElementById('modalImage').src = item.image;
  document.getElementById('modalText').innerText = item.text;
  document.getElementById('overlay').classList.add('active');
  document.getElementById('modal').classList.add('active');
}
function closeModal(){
  document.getElementById('overlay').classList.remove('active');
  document.getElementById('modal').classList.remove('active');
}
function collectInfo(){
  if(!currentGameId || !currentServiceName){ closeModal(); return; }
  collectedByGame[currentGameId].add(currentServiceName);
  const log = document.getElementById('infoLog'+currentGameId);
  if(log){ log.textContent = 'Informations collectées : ' + Array.from(collectedByGame[currentGameId]).map(labelShort).join(', '); }
  closeModal();
  updateCCTPButton(currentGameId);
}
function validateCollection(gameId){
  const need = requiredCount(gameId);
  const have = collectedByGame[gameId]?.size ?? 0;
  if(have < need){
    alert(`Vous devez visiter tous les services (${have}/${need}) avant de rédiger le cahier des charges.`);
    return;
  }
  startBuilder(gameId);
}
function labelShort(s){
  return s.replace(' Tilesa B','').replace(' B','').replace(' Copaya','').replace(' Carl','');
}

/* ======================= Données modales (textes + images) ======================= */
/* TILESA A */
const data1={
  'Direction':{ text:"Le président vous accueille : « La santé et la sécurité sont mes priorités pour garantir le bon fonctionnement de l’entreprise et le bien-être des salariés. »", image:"images/tilesia_direction.png" },
  'Technique':{ text:`Intervention pendant les heures ouvrables, sauf cas exceptionnel. Pour les locaux électriques, le titulaire sera accompagné d'un employé disposant des habilitations requises.

Les espaces concernés sont les suivants : bureaux, couloirs, escaliers, ascenseur, sanitaires, vestiaires, réfectoires.

Le titulaire remplira un avis de passage. Le rapport semestriel sera rédigé par le service technique.

Les consommables à la charge du prestataire sont les suivants :
- Le papier toilette
- Le papier essuie-mains
- Le savon liquide à mains
- Les sacs poubelles
- Désodorisants.`, image:"images/tilesia_technique.png" },
  'Salaries':{ text:"Il y a 300 salariés dans le bâtiment répartis sur les 4 étages. Le bâtiment dispose d’une superficie de 4100 m². Vous observez une ambiance de coopération et de réunions dans les locaux.", image:"images/tilesia_salaries.png" },
  'Juridique':{ text:"La juriste rappelle les prescriptions du Décret 92-158 du 20 février 1992 reprises dans le Code du travail (articles R.237-1 et R.237-28), applicables aux travaux réalisés dans l’établissement par une entreprise extérieure.", image:"images/tilesia_juridique.png" }
};
/* LESATI A */
const data2={
  'Direction':{ text:'LESATI assure production, distribution et commercialisation à Saint Georges (800 clients). Priorité au service public et à la proximité client.', image:"images/direction_directrice_LESATI.png" },
  'Service production':{ text:'Certains groupes ont atteint leurs limites techniques (dépassement des heures constructeur) et devront être révisés. Une révision serait plus onéreuse que l’achat de matériels neufs.\n\nNous aurons besoins de 3 groupes électrogènes d’une puissance nominale de 800 kVA, de type diesel avec les certifications "Ultra" et "Iso 9001". Il faut penser aux documents nécessaires pour la bonne utilisation du matériel.', image:"images/production_groupes_LESATI.png" },
  'Salaries':{ text:"Les 30 salariés devant l’entrée du bâtiment principal. Ils sont pleinement investis dans le développement local et la relation client.", image:"images/salaries_30_LESATI.png" },
  'Juridique':{ text:"La juriste rappelle qu'il est indispensable d'ajouter une garantie technique lors de l'achat des groupes électrogènes avec livraison à Saint Georges. Les groupes seront utilisés en continu dans un milieu humide et avec température élevée.", image:"images/juridique_garantie_LESATI.png" }
};
/* LESATI B */
const data3={
  'Direction B':{ text:`Pour répondre aux besoins énergétiques croissants de la Guyane au début des années 1980, le barrage a été construit au niveau d’un resserrement naturel du fleuve Sinnamary. Grâce à sa retenue d’eau, il alimente deux tiers des foyers du littoral guyanais.`, image:"images/direction_LESATI_B.png" },
  'Manager':{ text:`Ce cahier des charges a pour objet la fourniture d’équipements destinés à l’exploitation et à la maintenance d’une centrale hydraulique (Sinnamary). Ces équipements doivent répondre aux exigences de performance, de durabilité, et de conformité aux normes en vigueur.`, image:"images/manager_LESATI_B.png" },
  'Maintenance':{ text:`Les pièces de rechange sont utilisées sur les équipements suivants :

- Les pompes,
- Les moteurs électriques,
- Les kits de maintenance des pompes,
- Les capteurs analogiques et tout ou rien de niveaux, pressostats, manomètres, 
- Les filtres,
- Les clapets anti-retour,
- Les vannes manuelles et motorisées,
- Les actionneurs (ex. électrovannes).

Les livrables attendus sont les suivants :

- L’ensemble des équipements, accompagnés de leurs certificats de conformité, notices techniques, plans d'installation si nécessaire.
- Rapport d’essais.`, image:"images/maintenance_LESATI_B.png" },
  'Juridique B':{ text:`Le titulaire garantit les fournitures contre tout défaut de fabrication ou de matière pour une durée minimale de 24 mois à compter de la date de mise en service ou 30 mois après la livraison. En cas de défaillance, le remplacement ou la réparation des équipements sera pris en charge par le Titulaire.`, image:"images/juridique_LESATI_B.png" },
  'Sécurité':{ text:`Les équipements devront être livrés avec protections contre l’humidité et les chocs. Une étiquette claire indiquant le contenu et la référence doit être visible sur chaque caisse.

Adresse du site :
Centrale hydraulique de Sinnamary
97315 Sinnamary
Guyane Française

Horaires de livraison :
Du lundi au vendredi de 08h00 à 12h00`, image:"images/securite_LESATI_B.png" }
};
/* COPAYA A */
const data4={
  'Direction Copaya':{ text:`L'élagage est essentiel pour prévenir les coupures d'électricité et assurer la continuité de l'alimentation électrique des clients. Copaya supervise l'élagage des arbres à proximité des lignes électriques pour éviter les dommages sur le réseau.`, image:"images/copaya_direction.png" },
  'Clients Copaya':{ text:`Les propriétaires doivent veiller à l'entretien et la taille régulière des arbres situés sur leurs propriétés, conformément à la réglementation. L’élagage à proximité des réseaux électriques doit être géré par des professionnels disposant d’une autorisation AIPR (Autorisation Intervention à Proximité des Réseaux). La pousse rapide de la végétation peut engendrer des problématiques de sécurité des tiers et des coupures intempestives.`, image:"images/clients_copaya.png" },
  'Maintenance Copaya':{ text:`Distances attendues :

- 405 KM à élaguer par an sur le réseau HTA
- 250 KM à élaguer par an sur le réseau HTB
- 100 pieds de support par an + accès

Nous souhaitons un compte rendu précis de chaque zone élaguée, avec photos avant/après.
Les procédures d’accès et les plans seront fournis par Copaya.
Les documents d’accès sont de la responsabilité de Copaya.

Plage horaire préférée : 6h30 – 17h00.
Tout chantier en dehors de ces horaires sera réalisé avec l’accord écrit de Copaya.

Avant toute intervention à proximité d’un ouvrage électrique, envoyer une DT-DICT au moins 15 jours avant.`, image:"images/copaya_maintenance.png" },
  'Environnement Copaya':{ text:`L’intervention dans des zones protégées, la préservation des espèces (périodes de nidification, par exemple) et la gestion des risques d’incendie sont encadrées par une réglementation qui évolue avec la prise de conscience environnementale.`, image:"images/copaya_environnement.png" },
  'Sécurité Copaya':{ text:`Le Titulaire devra s’équiper d'Equipements de Protection Collectifs (EPC) et d’Equipements de Protection Individuels (EPI) :
- Balisage des zones de travail avec cônes
- Gyrophare/voyants lumineux
- Panneaux de chantier posés a minima 50 m avant le chantier
- Casque, gants, protection auditive, vêtements, chaussures de sécurité
- Matériel d’ascension conforme (contrôle à jour)`, image:"images/copaya_securite.png" }
};
/* COPAYA B */
const data5={
  'Directrice Carl':{ 
    text:`Ce projet est d’une grande importance pour l’entreprise COPAYA. Nous voulons fournir la même qualité de service à l’ensemble des habitants présents sur le territoire. Tous les moyens seront mis en œuvre pour respecter les délais et limiter les nuisances. Il est important de finaliser les travaux avant la prochaine saison des pluies.`,
    image:"images/copaya_directrice.png"
  },
  'Équipe Carl':{
    text:`Le titulaire transmettra son planning permettant de réaliser la fiche de déroulement des opérations (FDO).
Les communications seront réalisées via un outil dont les modalités de connexion seront transmises ultérieurement.
Copaya fournira les câbles, la boîte de jonction et un local de stockage tandis que le Titulaire devra nous transmettre les chambres de tirage.`,
    image:"images/copaya_equipe.png"
  },
  'Manager Carl':{
    text:`Voici les consignes :

- Mise en souterrain de 20 km de réseau HTA et 15 km de fibres optiques
- Confection de 60 boîtes de jonction HTA
- Fourniture et pose de fourreaux
- Réalisation d’une fouille pour la pose d’une armoire
- Réalisation d’une dalle de propreté autour de l’armoire
- Installation et mise en service de l’armoire
- Raccordement et étiquetage des câbles HTA
- Durée du chantier : 4 mois`,
    image:"images/copaya_manager.png"
  },
  'Habitants Carl':{
    text:`Nous attendons ces travaux avec impatience. Ces travaux permettront de stabiliser le réseau électrique. Nous espérons que les impacts sur la chaussée et sur le volume sonore seront minimisés dans le quartier.`,
    image:"images/copaya_habitants.png"
  },
  'Juriste Carl':{
    text:`Les tranchées devront respecter les conditions imposées par la DGTM (Direction Générale des territoires et de la Mer) concernant les travaux prévus sur la voie publique.
Avant tous travaux sur le domaine public, le prestataire devra effectuer une déclaration de commencement de travaux. Avant l’ouverture du chantier, il transmettra les éléments au Maître d’Ouvrage.
Le Titulaire réalisera l’ensemble des investigations complémentaires (IC) et opérations de localisation (OL) nécessaires à l’exécution des travaux conformément au décret n°2011-12.`,
    image:"images/copaya_juriste.png"
  },
  'Prévention Carl':{
    text:`Le Titulaire devra prendre toutes les dispositions nécessaires pour assurer la sécurité des biens et des personnes :

- Balisage des zones de travail avec cônes
- Gyrophare/voyants lumineux
- Panneaux de chantier posés a minima 50 m avant le chantier

Des visites régulières de prévention sécurité seront organisées par COPAYA pour s’assurer de la conformité du chantier.`,
    image:"images/copaya_prevention.png"
  }
};
/* TILESA B */
const data6={
  'Direction Tilesa B':{ 
    text:`Dans le cadre de son engagement en faveur du développement durable et de la réduction des émissions de gaz à effet de serre, Tilesa souhaite électrifier sa flotte de véhicules en Guyane Française. La flotte actuelle compte 150 véhicules dont 30% doivent être remplacés par des modèles électriques.`,
    image:"images/direction.png" 
  },
  'Manager Tilesa B':{ 
    text:`Le Titulaire du marché devra assurer :

- La fourniture de véhicules électriques neufs, homologués pour le territoire français et adaptés à l’environnement guyanais 
- La livraison des véhicules sur les différents sites : Cayenne, Kourou, Saint-Laurent-du-Maroni…
- La mise en service complète (immatriculation locale, première charge, vérifications fonctionnelles) 
- La formation des utilisateurs à la conduite de véhicules électriques 
- La fourniture de la documentation complète (certificats de conformité, manuels, garanties)
- Le service après-vente assuré localement ou via un partenaire agréé en Guyane.
- Les véhicules seront livrées lors des jours d’ouverture des sites`,
    image:"images/manager.png" 
  },
  'Services Tilesa B':{ 
    text:`Trois collègues échangent sur les besoins :

- Service réseau : Véhicules tout-chemin électriques ou hybrides rechargeables pour zones d’accès difficile.
- Clientèle :  Petits utilitaires électriques pour transport de matériel et d’équipes techniques
- Finance : Berlines ou citadines électriques pour déplacements professionnels`,
    image:"images/services.png" 
  },
  'Technique Tilesa B':{ 
    text:`Le Titulaire prendra en charge :

- Les frais d’acheminement jusqu’en Guyane (transport maritime, douane, manutention, livraison finale)
- Les formalités administratives d’immatriculation sur le territoire
- La fourniture de tous les équipements de base (câbles de recharge, kit sécurité, roue de secours ou kit anti-crevaison)

L’entreprise assurera :
- La mise à disposition des emplacements nécessaires à la réception et au stationnement des véhicules
- L’assurance des véhicules
- L’installation et l’entretien des bornes de recharge
- Le suivi administratif (cartes grises, fiscalité, contrôles périodiques)`,
    image:"images/technique.png" 
  },
  'Juriste Tilesa B':{ 
    text:`Face à l’urgence climatique, l’Union européenne a mis en place un cadre réglementaire ambitieux pour accélérer l’électrification du parc automobile.  Parmi les mesures phares :

- l’interdiction de la vente des voitures thermiques neuves à partir de 2035
- la norme CAFE, le recyclage des batteries et la mise en place d’un passeport numérique de batterie.`,
    image:"images/juriste.png" 
  },
  'Environnement Tilesa B':{ 
    text:`Nos objectifs sont les suivants :
- Réduction mesurable des émissions de CO₂ et des coûts énergétiques
- Amélioration du confort de conduite et de la sécurité des utilisateurs
- Fonctionnement optimal des véhicules malgré les contraintes territoriales.`,
    image:"images/responsable_environnement.png" 
  }
};
function modalDataFor(gameId){
  if(gameId===2) return data2;
  if(gameId===3) return data3;
  if(gameId===4) return data4;
  if(gameId===5) return data5;
  if(gameId===6) return data6;
  return data1;
}

/* ======================= QCM — base commune & spécifiques ======================= */
/* Base commune (TILESA A) — 9 sections */
const stepsCommon=[
  { id:"objet", label:"Objet", help:"Définir précisément l’objet du CCTP.",
    options:[ "Prestation de nettoyage intérieur des locaux du site TILESIA", "Périmètre: bureaux, circulation, escaliers, ascenseur, sanitaires, vestiaires, réfectoires", "Objectif: propreté, hygiène et confort des utilisateurs" ] },
  { id:"contexte", label:"Contexte", help:"Situer le bâtiment, sa surface, la politique HSE.",
    options:[ "Bâtiment R+3, 4100 m², ~300 salariés", "La politique santé sécurité est un enjeu majeur pour l’entreprise", "Locaux électriques accompagnés par personnel habilité" ] },
  { id:"definition", label:"Définition de la prestation", help:"Nature & contenu des tâches.",
    options:[ "Nettoyage des sols (aspiration, balayage humide, lavage)", "Dépoussiérage des surfaces et mobiliers", "Désinfection des points de contact", "Sanitaires: nettoyage, désinfection et réassort" ] },
  { id:"limites_titulaire", label:"À la charge du Titulaire", help:"Outillages, consommables, matériels.",
    options:[ "Approvisionnement consommables (papier toilette, essuie-mains, savon, sacs, désodorisants)", "Fourniture matériels & produits de nettoyage", "Avis de passage après intervention" ] },
  { id:"limites_entreprise", label:"À la charge de l’Entreprise", help:"Ce que l’Entreprise fournit.",
    options:[ "Locaux d’entretien et points d’eau", "Accompagnement zones électriques (agents habilités)", "Accès / badges / consignes de sécurité" ] },
  { id:"qualite", label:"Qualité", help:"Suivi, traçabilité, indicateurs.",
    options:[ "Plan qualité & fiches techniques", "Traçabilité des interventions", "Indicateurs & amélioration continue" ] },
  { id:"conditions", label:"Conditions d’intervention", help:"Sécurité, horaires, normes.",
    options:[ "Respect sécurité / environnement (tri, stockage)", "Signalisation zones en intervention", "Interventions en heures ouvrables", "Décret 92-158 & C. travail R.237-1 à R.237-28" ] },
  { id:"resultats", label:"Résultats attendus", help:"Critères mesurables.",
    options:[ "Sols propres sans traces visibles", "Sanitaires propres et réapprovisionnés", "Mobilier dépoussiéré, points de contact désinfectés" ] },
  { id:"reception_ref", label:"Réception & Références", help:"PV, rapports, références.",
    options:[ "Rapport semestriel par le service technique", "Procès-verbal de réception bilatéral", "Références réglementaires d’hygiène" ] }
];
const answerKeyCommon={
  objet:[0], contexte:[0,1], definition:[0,1,2,3],
  limites_titulaire:[0,1], limites_entreprise:[0,1,2],
  qualite:[0,1,2], conditions:[0,1,2,3], resultats:[0,1,2],
  reception_ref:[0,1]
};

/* ---- QCM personnalisés ----
   LESATI B (3), COPAYA A (4), COPAYA B (5), TILESA B (6)
   (les jeux 1 et 2 utilisent la base commune)
*/

/* LESATI B */
const steps3=[
  { id:"objet", label:"Objet", help:"Fourniture d’équipements pour exploitation & maintenance d’une centrale hydraulique.",
    options:[
      "Fourniture d’équipements pour la centrale hydraulique de Sinnamary",
      "Nettoyage des locaux tertiaires",
      "Création d’un nouveau barrage",
      "Prestation de consultance juridique"
    ]},
  { id:"contexte", label:"Contexte", help:"Historique & rôle du barrage.",
    options:[
      "Barrage construit sur le Sinnamary pour répondre aux besoins croissants",
      "Retenue d’eau ~310 km², 2/3 des foyers du littoral alimentés",
      "Implantation dans une zone aride",
      "Mise en service inconnue"
    ]},
  { id:"definition", label:"Définition de la prestation", help:"Typologie des pièces et équipements visés.",
    options:[
      "Pièces pour pompes, moteurs, capteurs, filtres, clapets, vannes, actionneurs",
      "Équipements de bureau (PC, écrans, imprimantes)",
      "Pièces pour turbines et auxiliaires de centrale",
      "Peinture intérieure des bâtiments"
    ]},
  { id:"livrables", label:"Livrables attendus", help:"Documents & livraisons.",
    options:[
      "Équipements avec certificats, notices, plans d’installation si besoin",
      "Rapport d’essais",
      "Planning de communication interne uniquement",
      "Aucun document"
    ]},
  { id:"garantie", label:"Garantie", help:"Durée minimale et prise en charge.",
    options:[
      "24 mois après mise en service ou 30 mois après la livraison",
      "12 mois après commande",
      "Remplacement/réparation à la charge du titulaire",
      "Garantie non nécessaire"
    ]},
  { id:"logistique", label:"Emballage & étiquetage", help:"Protection & identification.",
    options:[
      "Protection contre humidité & chocs",
      "Étiquette claire avec contenu & référence",
      "Étiquetage optionnel",
      "Aucun emballage requis"
    ]},
  { id:"livraison", label:"Adresse & horaires", help:"Site et créneau de livraison.",
    options:[
      "Centrale hydraulique de Sinnamary — 97315 Sinnamary",
      "Horaires : Lun–Ven 08h00–12h00",
      "Adresse : Plateforme logistique en métropole",
      "Horaires : 22h–5h uniquement"
    ]},
  { id:"preavis", label:"Préavis & manutention", help:"Organisation et déchargement.",
    options:[
      "Préavis 21 jours minimum avant livraison",
      "Déchargement par transporteur (sauf accord contraire)",
      "Tout colis non conforme pourra être refusé",
      "Préavis non nécessaire"
    ]},
  { id:"securite", label:"Sécurité", help:"Règles générales (si mentionnées).",
    options:[
      "Respect des règles HSE du site",
      "Équipements conditionnés pour zone humide",
      "Interventions sans accompagnement",
      "Aucune contrainte sécurité"
    ]}
];
const answers3={
  objet:[0], contexte:[0,1], definition:[0,2], livrables:[0,1],
  garantie:[0,2], logistique:[0,1], livraison:[0,1], preavis:[0,1,2], securite:[0,1]
};

/* COPAYA A */
const steps4=[
  { id:"objet", label:"Objet", help:"Élagage autour d’ouvrages HTA/HTB.",
    options:[
      "Élagage pour continuité d’alimentation",
      "Nettoyage de bureaux",
      "Construction de poste source",
      "Remise à neuf de routes"
    ]},
  { id:"contexte", label:"Contexte", help:"Responsabilités & AIPR.",
    options:[
      "AIPR requise pour intervenir près des réseaux",
      "Propriétaires responsables de l’entretien sur leur terrain",
      "Pousse rapide = risques sécurité & coupures",
      "AIPR facultative"
    ]},
  { id:"definition", label:"Définition de la prestation", help:"Inclure les distances annuelles.",
    options:[
      "405 km HTA/an à élaguer",
      "250 km HTB/an à élaguer",
      "100 pieds de support/an + accès",
      "Uniquement zones urbaines (0 km)"
    ]},
  { id:"conditions", label:"Conditions d’exécution", help:"Procédures & horaires.",
    options:[
      "CR précis par zone + photos avant/après",
      "Procédures d’accès & plans fournis par Copaya",
      "Plage 6h30–17h, hors plage sur accord écrit",
      "Respect EPC/EPI (retiré de cet onglet)"
    ]},
  { id:"dtdict", label:"DT-DICT", help:"Délais réglementaires.",
    options:[
      "DT-DICT 15 jours avant",
      "DT-DICT non nécessaire",
      "Déclaration le jour J"
    ]},
  { id:"securite", label:"Sécurité", help:"EPC/EPI & balisage.",
    options:[
      "Balisage cônes & panneaux 50 m",
      "Gyrophare/voyants lumineux",
      "Casque, gants, protections, chaussures sécu",
      "Aucun EPI requis"
    ]},
  { id:"environnement", label:"Environnement", help:"Réglementations sensibles.",
    options:[
      "Respect zones protégées & périodes de nidification",
      "Gestion du risque incendie",
      "Aucune contrainte environnementale",
      "Réglementation en évolution"
    ]},
  { id:"livrables", label:"Livrables", help:"Traces & justificatifs.",
    options:[
      "Comptes rendus par zone",
      "Photos avant/après",
      "PV de réception de poste HTA",
      "Planning validé"
    ]},
  { id:"resultats", label:"Résultats attendus", help:"Résultat observable.",
    options:[
      "Dégagement conforme des abords",
      "Lignes sécurisées sans contact végétation",
      "Hauteur d’élagage aléatoire",
      "Préservation du réseau"
    ]}
];
const answers4={
  objet:[0], contexte:[0,1,2], definition:[0,1,2], conditions:[0,1,2],
  dtdict:[0], securite:[0,1,2], environnement:[0,1,3], livrables:[0,1,4], resultats:[0,1,3]
};

/* COPAYA B */
const steps5=[
  { id:"objet", label:"Objet", help:"Une seule bonne réponse.",
    options:[
      "Raccordement au réseau électrique d'un village situé en Guyane Française",
      "Réalisation des fouilles et dalle de propreté",
      "Stabilisation du réseau électrique pour les habitants",
      "Respect des normes techniques HTA et DT/DICT"
    ]},
  { id:"contexte", label:"Contexte", help:"Enjeux & délais.",
    options:[
      "Projet important, même qualité de service pour tous",
      "Limiter nuisances / respecter délais",
      "Finaliser avant saison des pluies",
      "Pas de contrainte de délai"
    ]},
  { id:"definition", label:"Définition de la prestation", help:"Consignes principales.",
    options:[
      "Mise en souterrain 20 km HTA + 15 km fibre",
      "60 boîtes de jonction HTA",
      "Fourniture et pose de fourreaux",
      "Aucun raccordement"
    ]},
  { id:"travaux", label:"Travaux détaillés", help:"Liste d'opérations.",
    options:[
      "Fouille + dalle de propreté autour armoire",
      "Installation + mise en service armoire",
      "Raccordement & étiquetage câbles HTA",
      "Durée : 4 mois"
    ]},
  { id:"equipe", label:"Organisation & matériel", help:"Rôles et fournitures.",
    options:[
      "Planning pour FDO par le titulaire",
      "Comms via outil partagé (modalités à venir)",
      "Copaya : câbles, boîte de jonction, local stockage",
      "Titulaire : chambres de tirage"
    ]},
  { id:"habitants", label:"Habitants", help:"Attentes & nuisances.",
    options:[
      "Stabiliser le réseau",
      "Minimiser impacts chaussée & bruit",
      "Travailler de nuit uniquement",
      "Informer la population"
    ]},
  { id:"juridique", label:"Juridique", help:"Règles DGTM & démarches.",
    options:[
      "Conditions DGTM voie publique",
      "Déclaration de commencement de travaux avant ouverture",
      "IC/OL selon décret 2011-12",
      "Pas de formalités"
    ]},
  { id:"prevention", label:"Prévention sécurité", help:"Balisage & visites.",
    options:[
      "Balisage cônes, panneaux 50 m, gyrophare",
      "Visites régulières de prévention COPAYA",
      "Aucun EPI requis",
      "Zone non signalée"
    ]},
  { id:"resultats", label:"Résultats attendus", help:"Synthèse objectif.",
    options:[
      "Raccordement HTA conforme",
      "Qualité de service homogène",
      "Aucune coupure",
      "Travaux non réceptionnés"
    ]}
];
const answers5={
  objet:[0], contexte:[0,1,2], definition:[0,1,2], travaux:[0,1,2,3],
  equipe:[0,1,2,3], habitants:[0,1], juridique:[0,1,2], prevention:[0,1], resultats:[0,1]
};

/* TILESA B */
const steps6=[
  { id:"objet", label:"Objet", help:"Renouvellement partiel de flotte par VE.",
    options:[
      "Achat de véhicules électriques neufs",
      "Entretien d’espaces verts",
      "Achat de groupes électrogènes",
      "Réfection d’antenne télécom"
    ]},
  { id:"contexte", label:"Contexte", help:"Objectifs & flotte.",
    options:[
      "Engagement réduction GES, électrification flotte",
      "150 véhicules, 30% à remplacer",
      "Contrainte : Guyane Française",
      "Parc déjà 100% électrique"
    ]},
  { id:"definition", label:"Définition de la prestation", help:"Ce que doit assurer le titulaire.",
    options:[
      "Fourniture VE neufs homologués France",
      "Livraison multi-sites (Cayenne, Kourou, SLM…)",
      "Mise en service (immat locale, 1ère charge, vérifs)",
      "Peinture complète des parkings"
    ]},
  { id:"accompagnement", label:"Accompagnement & docs", help:"Formation & documentation.",
    options:[
      "Formation à la conduite VE",
      "Doc complète (COC, manuels, garanties)",
      "SAV local/partenaire agréé Guyane",
      "Aucun support"
    ]},
  { id:"logistique", label:"Logistique & jours", help:"Jours d’ouverture.",
    options:[
      "Livraisons sur jours d’ouverture des sites",
      "Livraisons 24/7",
      "Livraisons uniquement week-ends",
      "Livraisons au port uniquement"
    ]},
  { id:"services", label:"Besoins métiers", help:"Adaptation par service.",
    options:[
      "Réseau : tout-chemin ou PHEV pour accès difficiles",
      "Clientèle : petits utilitaires électriques",
      "Finance : berlines/citadines électriques",
      "Moto thermique"
    ]},
  { id:"technique", label:"Technique & équipements", help:"Prise en charge titulaire.",
    options:[
      "Acheminement jusqu’en Guyane + douane",
      "Formalités immatriculation",
      "Équipements de base (câbles, kit sécurité, roue/kit)",
      "Aucun accessoire fourni"
    ]},
  { id:"entreprise", label:"À charge de l’entreprise", help:"Ce que fait Tilesa.",
    options:[
      "Emplacements réception/stationnement",
      "Assurance véhicules",
      "Installation & entretien bornes de recharge",
      "Suivi administratif (CG, fiscalité, contrôles)"
    ]},
  { id:"reglementaire", label:"Réglementaire UE", help:"Mesures phares.",
    options:[
      "Interdiction vente thermiques neufs dès 2035",
      "Norme CAFE",
      "Passeport numérique batterie",
      "Aucune mesure"
    ]}
];
const answers6={
  objet:[0], contexte:[0,1,2], definition:[0,1,2], accompagnement:[0,1,2],
  logistique:[0], services:[0,1,2], technique:[0,1,2], entreprise:[0,1,2,3], reglementaire:[0,1,2]
};

/* Map QCM par jeu */
const perGameSteps = { 3:steps3, 4:steps4, 5:steps5, 6:steps6 };
const perGameAnswers = { 3:answers3, 4:answers4, 5:answers5, 6:answers6 };

/* ======================= Assistant QCM (builder) ======================= */
let builderSelections={}, builderIndex=0, currentSteps=stepsCommon, currentAnswers=answerKeyCommon;
function startBuilder(gameId){
  window.currentBuilderGame = gameId;
  currentSteps  = perGameSteps[gameId]  || stepsCommon;
  currentAnswers= perGameAnswers[gameId]|| answerKeyCommon;

  document.getElementById('builderTitle').textContent = ({
    1:"TILESA — Jeu A",
    2:"LESATI — Jeu A",
    3:"LESATI — Jeu B",
    4:"COPAYA — Jeu A",
    5:"COPAYA — Jeu B",
    6:"TILESA — Jeu B"
  }[gameId]) + " — Assistant (QCM)";

  const tabs=document.getElementById('builderTabs');
  const panels=document.getElementById('builderPanels');
  tabs.innerHTML=""; panels.innerHTML="";
  builderSelections={}; builderIndex=0;

  currentSteps.forEach((s,i)=>{
    const b=document.createElement('button'); b.className='tab-btn'+(i===0?' active':''); b.textContent=`${i+1}. ${s.label}`; b.onclick=()=>goStep(i); tabs.appendChild(b);
    const p=document.createElement('div'); p.className='tab-panel'+(i===0?' active':''); p.id=`panel-${s.id}`;
    p.innerHTML=`
      <h3>${i+1}. ${s.label}</h3>
      ${s.help?`<div class="help"><details><summary>Aide (facultatif)</summary><p>${s.help}</p></details></div>`:""}
      <div class="helper">Sélectionnez les éléments pertinents pour votre CCTP.</div>
      <div class="option-grid">
        ${s.options.map((opt,idx)=>`
          <div class="option"><label><input type="checkbox" data-step="${s.id}" data-opt="${idx}"> ${opt}</label></div>
        `).join('')}
      </div>`;
    panels.appendChild(p);
  });

  panels.onchange=(e)=>{
    const box=e.target; if(!box || box.type!=='checkbox') return;
    const stepId=box.dataset.step; const idx=Number(box.dataset.opt);
    if(!builderSelections[stepId]) builderSelections[stepId]=new Set();
    if(box.checked) builderSelections[stepId].add(idx); else builderSelections[stepId].delete(idx);
  };

  document.getElementById('prevStep').onclick=()=>goStep(builderIndex-1);
  document.getElementById('nextStep').onclick=()=>{
    if(!hasAtLeastOne(currentSteps[builderIndex].id)){document.getElementById('builderWarn').style.display='block';return;}
    document.getElementById('builderWarn').style.display='none'; goStep(builderIndex+1);
  };
  document.getElementById('finishBuilder').onclick=()=>{
    if(!hasAtLeastOne(currentSteps[builderIndex].id)){document.getElementById('builderWarn').style.display='block';return;}
    document.getElementById('builderWarn').style.display='none'; finishBuilder();
  };

  const backBtn = document.getElementById('btnBackToMap');
  backBtn.onclick = ()=> goTo('game'+gameId);

  goStep(0);
  goTo('builder');
}
function hasAtLeastOne(stepId){const set=builderSelections[stepId];return set && set.size>0;}
function goStep(i){
  if(i<0||i>=currentSteps.length) return; builderIndex=i;
  [...document.querySelectorAll('#builderTabs .tab-btn')].forEach((b,k)=>b.classList.toggle('active',k===i));
  [...document.querySelectorAll('#builderPanels .tab-panel')].forEach(p=>p.classList.remove('active'));
  document.getElementById(`panel-${currentSteps[i].id}`).classList.add('active');
  const pct=Math.round((i)/(currentSteps.length-1)*100); document.getElementById('builderProgress').style.width=pct+'%';
  document.getElementById('prevStep').disabled=(i===0);
  document.getElementById('nextStep').style.display=(i===currentSteps.length-1)?'none':'inline-block';
  document.getElementById('finishBuilder').style.display=(i===currentSteps.length-1)?'inline-block':'none';
}
function levelBadge(pct){
  if(pct<=50) return {label:"Débutant",cls:"debutant"};
  if(pct<=70) return {label:"Avancé",cls:"avance"};
  if(pct<=95) return {label:"Expert",cls:"expert"};
  return {label:"Génie",cls:"genie"};
}
function finishBuilder(){
  const gameId = window.currentBuilderGame;
  const mapTitle = {1:"TILESA — Jeu A",2:"LESATI — Jeu A",3:"LESATI — Jeu B",4:"COPAYA — Jeu A",5:"COPAYA — Jeu B",6:"TILESA — Jeu B"}[gameId];
  document.getElementById('summaryTitle').textContent = "Résumé — " + mapTitle;

  let html='';
  currentSteps.forEach((s,i)=>{
    const picked=[...(builderSelections[s.id]||[])].sort((a,b)=>a-b);
    if(picked.length){ html+=`<h4>${i+1}. ${s.label}</h4><ul>`; picked.forEach(idx=>html+=`<li>${s.options[idx]}</li>`); html+='</ul>'; }
  });
  if(!html) html="<p>Aucun élément sélectionné.</p>";
  document.getElementById('summaryContent').innerHTML=html;

  // scoring
  let totalCorrect=0, selectedCorrect=0; const errors=[];
  for(const step of currentSteps){
    const key=currentAnswers[step.id]||[];
    totalCorrect+=key.length;
    const picked=builderSelections[step.id]?Array.from(builderSelections[step.id]):[];
    const ok=picked.filter(i=>key.includes(i));
    const wrong=picked.filter(i=>!key.includes(i));
    const missed=key.filter(i=>!picked.includes(i));
    selectedCorrect+=ok.length;
    if(wrong.length||missed.length){ errors.push({label:step.label, wrong:wrong.map(i=>step.options[i]), missed:missed.map(i=>step.options[i])}); }
  }
  const pct=totalCorrect?Math.round((selectedCorrect/totalCorrect)*100):0;
  const level=levelBadge(pct);
  const scoreEl=document.getElementById('scoreContent'); scoreEl.style.display='block';
  scoreEl.innerHTML=`Score : ${selectedCorrect} sur ${totalCorrect} (${pct}%) <span class="badge ${level.cls}">${level.label}</span>`;

  const toggleBtn=document.getElementById('toggleErrors');
  const panel=document.getElementById('errorsPanel');
  if(errors.length){
    toggleBtn.style.display='inline-block';
    panel.style.display='none';
    panel.innerHTML=errors.map(e=>{
      let block=`<div style="margin:.4rem 0">`;
      block+=`<h4>${e.label}</h4>`;
      if(e.wrong.length) block+=`<div style="color:#b91c1c"><strong>Choix non attendus :</strong><ul>${e.wrong.map(t=>`<li>${t}</li>`).join('')}</ul></div>`;
      if(e.missed.length) block+=`<div style="color:#92400e"><strong>À ne pas oublier :</strong><ul>${e.missed.map(t=>`<li>${t}</li>`).join('')}</ul></div>`;
      block+=`</div>`; return block;
    }).join('');
    toggleBtn.onclick=()=>{ panel.style.display=(panel.style.display==='none')?'block':'none'; toggleBtn.textContent=panel.style.display==='none'?'Voir mes erreurs':'Masquer les erreurs'; };
  }else{
    toggleBtn.style.display='none'; panel.style.display='none'; panel.innerHTML='';
  }

  document.getElementById('btnSummaryBack').onclick = ()=> goTo('game'+gameId);
  goTo('summary');
}
</script>
</body>
</html>
