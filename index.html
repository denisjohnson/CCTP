<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Plateforme CCTP — 3 domaines, 6 jeux</title>
  <style>
    :root{ --primary:#0a74da; --primary-dark:#095aba; --bg:#f4f7fb; --card:#ffffff; --text:#22324a; --warn:#b45309; }
    *{box-sizing:border-box}
    body{font-family:Arial,Helvetica,sans-serif;margin:0;background:var(--bg);color:var(--text);overflow-x:hidden;}
    .container{max-width:1100px;margin:0 auto;padding:clamp(16px,4vw,32px);}
    .screen{display:none;animation:fadeIn .3s ease;}
    .active{display:block;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
    h1,h2,h3{margin:0 0 .6rem}
    p{line-height:1.5}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem;}
    .card{background:#fff;border-radius:14px;box-shadow:0 10px 26px rgba(0,0,0,.08);padding:1rem;}
    .btn{padding:.7rem 1.05rem;background:var(--primary);color:#fff;border:none;border-radius:10px;font-weight:700;cursor:pointer;box-shadow:0 2px 6px rgba(10,116,218,.25);}
    .btn:hover{background:var(--primary-dark)}
    .btn.secondary{background:#e9eef5;color:#1b304a;box-shadow:none}
    .hero{width:100%;max-width:980px;border-radius:16px;box-shadow:0 10px 26px rgba(0,0,0,.08);display:block;margin:0 auto 12px;object-fit:contain;max-height:60vh;}
    .map{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem;margin-top:1rem;}
    .location{background:#fff;padding:1rem;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.06);text-align:center;cursor:pointer;transition:transform .15s ease,box-shadow .2s ease;}
    .location:hover{transform:translateY(-2px);box-shadow:0 10px 22px rgba(0,0,0,.08);}
    .location img{width:48px;height:48px;margin-bottom:.5rem;}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:999;}
    .overlay.active{display:block;}
    .modal{position:fixed;top:5%;left:50%;transform:translateX(-50%);background:#fff;padding:clamp(16px,3vw,24px);border-radius:14px;box-shadow:0 18px 50px rgba(0,0,0,.25);display:none;z-index:1000;width:min(92vw,820px);max-height:90vh;overflow:auto;}
    .modal.active{display:block;}
    .modal figure{margin:.5rem 0;}
    .modal img{max-width:100%;max-height:40vh;object-fit:contain;display:block;margin:0 auto;}
    .modal figcaption{font-size:.95rem;color:#334155;background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:.6rem .75rem;margin-top:.5rem;white-space:pre-line;}
    .modal p{white-space:pre-line;}
    .info-log{margin-top:.75rem;font-size:.95rem;color:#0f7a31;}
    .notice-panel{background:#f8fafc;border:1px solid #d1d5db;border-radius:12px;padding:1rem;margin-top:1rem;display:none;}
    /* Assistant */
    .progress{height:10px;background:#e9eef5;border-radius:999px;overflow:hidden;margin:10px 0 18px;}
    .progress>span{display:block;height:100%;background:#0a74da;width:0%;transition:width .25s ease;}
    .tabs{display:flex;flex-wrap:wrap;gap:.5rem;margin-bottom:.8rem;}
    .tab-btn{padding:.45rem .7rem;border-radius:10px;border:1px solid #d8e0ea;background:#fff;cursor:pointer;font-size:.92rem;color:#213347;}
    .tab-btn.active{background:#0a74da;color:#fff;border-color:#0a74da;}
    .tab-panel{display:none;background:#fff;padding:1rem;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.06);}
    .tab-panel.active{display:block;}
    .option-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:.75rem;margin-top:.75rem;}
    .option{border:1px solid #e6e6e6;border-radius:10px;padding:.75rem;background:#fafafa;}
    .summary{background:#fff;padding:1rem;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.06);}
    figure.hero-figure{margin:0 0 12px;}
    figure.hero-figure figcaption{font-size:.95rem;color:#334155;background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:.6rem .75rem;white-space:pre-line;}
  
/* Inline detail panel for service content */
.detail-panel{display:none;margin-top:14px;background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 8px 20px rgba(0,0,0,.06);padding:16px}
.detail-panel.active{display:block}
.detail-title{font-weight:700;font-size:1.15rem;margin:0 0 .35rem;color:#1f2a44}
.detail-body{color:#334155;line-height:1.5}
.detail-body img{max-width:100%;height:auto;border-radius:10px;display:block;margin:.25rem 0 .5rem}
.badge-visited{margin-left:.5rem;background:#e8f5e9;color:#0a7a2d;padding:.15rem .4rem;border-radius:999px;font-size:.8rem}
</style>
</head>
<body>

<!-- ACCUEIL -->
<div id="home" class="screen active">
  <div class="container">
    <img class="hero" src="images/accueil_salle_formation.png" alt="Salle de formation moderne en Guyane avec formateurs et participants">
    <h2>Choisissez votre domaine</h2>
    <div class="grid">
      <div class="card">
        <h3>Domaine Production</h3>
        <p>Jeux de l'entreprise <strong>LESATI</strong> (Guyane — énergie).</p>
        <button class="btn" onclick="goTo('domain_production')">Accéder au domaine</button>
      </div>
      <div class="card">
        <h3>Domaine Réseau</h3>
        <p>Jeux de l'entreprise <strong>COPAYA</strong> (réseaux & exploitation).</p>
        <button class="btn" onclick="goTo('domain_reseau')">Accéder au domaine</button>
      </div>
      <div class="card">
        <h3>Domaine Tertiaire</h3>
        <p>Jeux de l'entreprise <strong>TILESA</strong> (services & support).</p>
        <button class="btn" onclick="goTo('domain_tertiaire')">Accéder au domaine</button>
      </div>
    </div>
  </div>
</div>

<!-- DOMAINES -->
<div id="domain_production" class="screen">
  <div class="container">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:.5rem;flex-wrap:wrap">
      <h2>Domaine Production — LESATI</h2>
      <button class="btn secondary" onclick="goTo('home')">⬅ Retour accueil</button>
    </div>
    <div class="grid">
      <div class="card">
        <h3>Jeu A — CCTP LESATI (Léa)</h3>
        <p>Collectez les informations et préparez un CCTP.</p>
        <button class="btn" onclick="startGame(2)">Lancer</button>
      </div>
      <div class="card">
        <h3>Jeu B — LESATI (Léon)</h3>
        <p>Incarnez <strong>Léon</strong>, chef de projet hydraulique. Collectez 5 services puis rédigez.</p>
        <button class="btn" onclick="startGame(3)">Lancer</button>
      </div>
    </div>
  </div>
</div>

<div id="domain_reseau" class="screen">
  <div class="container">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:.5rem;flex-wrap:wrap">
      <h2>Domaine Réseau — COPAYA</h2>
      <button class="btn secondary" onclick="goTo('home')">⬅ Retour accueil</button>
    </div>
    <div class="grid">
      <div class="card">
        <h3>Jeu A — COPAYA (mission 1)</h3>
        <p>Exploration des contraintes réseau et plan d'intervention.</p>
        <button class="btn" onclick="startGame(4)">Lancer</button>
      </div>
      <div class="card">
        <h3>Jeu B — COPAYA (mission 2)</h3>
        <p>Évaluation des incidents et priorisation des réparations.</p>
        <button class="btn" onclick="startGame(5)">Lancer</button>
      </div>
    </div>
  </div>
</div>

<div id="domain_tertiaire" class="screen">
  <div class="container">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:.5rem;flex-wrap:wrap">
      <h2>Domaine Tertiaire — TILESA</h2>
      <button class="btn secondary" onclick="goTo('home')">⬅ Retour accueil</button>
    </div>
    <div class="grid">
      <div class="card">
        <h3>Jeu A — CCTP TILESA</h3>
        <p>Explorez les services du groupe TILESA avec Alex puis rédigez un CCTP.</p>
        <button class="btn" onclick="startGame(1)">Lancer</button>
      </div>
      <div class="card">
        <h3>Jeu B — TILESA (nouvelle mission)</h3>
        <p>Scénario complémentaire : analyse des besoins et des prestataires.</p>
        <button class="btn" onclick="startGame(6)">Lancer</button>
      </div>
    </div>
  </div>
</div>

<!-- INTRO / JEUX -->
<div id="game1_intro" class="screen">
  <div class="container">
    <img class="hero" src="images/tilesia_accueil_alex.png" alt="Alex accueil">
    <h2>Jeu A — CCTP TILESA</h2>
    <button class="btn" onclick="goTo('game1')">Démarrer la mission</button>
    <button class="btn secondary" onclick="goTo('domain_tertiaire')">⬅ Retour domaine</button>
  </div>
</div>

<div id="game2_intro" class="screen">
  <div class="container">
    <img class="hero" src="images/lea_centrale_LESATI.png" alt="Léa devant la centrale">
    <h2>Jeu A — CCTP LESATI</h2>
    <p>Léa, chargée d'affaires du service production, est volontaire pour réaliser l'expression du besoin.</p>
    <button class="btn" onclick="goTo('game2')">Démarrer la mission</button>
    <button class="btn secondary" onclick="goTo('domain_production')">⬅ Retour domaine</button>
  </div>
</div>

<div id="game3_intro" class="screen">
  <div class="container">
    <figure class="hero-figure">
      <img class="hero" src="images/leon_centrale_LESATI.png" alt="Léon devant la centrale hydraulique">
      <figcaption>LEON, nouveau chef de projet est volontaire pour rédiger le futur cahier des charge concernant l'achat de pièces de rechange pour la centrale hydraulique</figcaption>
    </figure>
    <h2>Jeu B — LESATI (Léon)</h2>
    <button class="btn" onclick="goTo('game3')">Démarrer la mission</button>
    <button class="btn secondary" onclick="goTo('domain_production')">⬅ Retour domaine</button>
  </div>
</div>

<div id="game4_intro" class="screen">
  <div class="container">
    <img class="hero" src="images/copaya_intro_A.png" alt="COPAYA - Jeu A">
    <h2>Jeu A — COPAYA</h2>
    <p>Préparez l'intervention réseau (texte et images à compléter).</p>
    <button class="btn secondary" onclick="goTo('domain_reseau')">⬅ Retour domaine</button>
  </div>
</div>

<div id="game5_intro" class="screen">
  <div class="container">
    <img class="hero" src="images/copaya_intro_B.png" alt="COPAYA - Jeu B">
    <h2>Jeu B — COPAYA</h2>
    <p>Priorisez les réparations après incidents (texte et images à compléter).</p>
    <button class="btn secondary" onclick="goTo('domain_reseau')">⬅ Retour domaine</button>
  </div>
</div>

<div id="game6_intro" class="screen">
  <div class="container">
    <img class="hero" src="images/tilesia_intro_B.png" alt="TILESA - Jeu B">
    <h2>Jeu B — TILESA</h2>
    <p>Analyse des besoins et sélection de prestataires (texte et images à compléter).</p>
    <button class="btn secondary" onclick="goTo('domain_tertiaire')">⬅ Retour domaine</button>
  </div>
</div>

<!-- Jeu 1 (TILESA A) -->
<div id="game1" class="screen">
  <div class="container">
    <h2>Jeu A — CCTP TILESA</h2>
    <div class="map">
      <div class="location" onclick="openModal('Direction',1)"><img src="https://cdn-icons-png.flaticon.com/512/219/219986.png" alt="">Direction</div>
      <div class="location" onclick="openModal('Technique',1)"><img src="https://cdn-icons-png.flaticon.com/512/2621/2621140.png" alt="">Service Technique</div>
      <div class="location" onclick="openModal('Salaries',1)"><img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="">Salariés</div>
      <div class="location" onclick="openModal('Juridique',1)"><img src="https://cdn-icons-png.flaticon.com/512/2569/2569069.png" alt="">Juridique</div>
    </div>
    <div class="info-log" id="infoLog1"></div>
    <button class="btn" onclick="validateCollection(1)">Rédiger le cahier des charges</button>
    <button class="btn secondary" onclick="goTo('domain_tertiaire')">⬅ Retour domaine</button>
  </div>
</div>

<!-- Assistant QCM Jeu 1 -->
<div id="builder1" class="screen">
  <div class="container">
    <h2>Assistant (QCM) — TILESA</h2>
    <div class="progress"><span id="builderProgress1"></span></div>
    <div class="tabs" id="builderTabs1"></div>
    <div id="builderPanels1"></div>
    <div class="notice-panel" id="builderWarn1" style="display:none">Veuillez sélectionner au moins un élément.</div>
    <div style="display:flex;gap:.5rem;justify-content:space-between;margin-top:.8rem;">
      <button class="btn secondary" id="prevStep1">◀ Précédent</button>
      <div>
        <button class="btn secondary" onclick="goTo('game1')">Sauvegarder & Revenir à la carte</button>
        <button class="btn" id="nextStep1">Suivant ▶</button>
        <button class="btn" id="finishBuilder1" style="display:none">Générer le résumé</button>
      </div>
    </div>
  </div>
</div>

<div id="summary1" class="screen">
  <div class="container">
    <h2>Résumé — CCTP TILESA</h2>
    <div class="summary" id="summaryContent1"></div>
    <div id="scoreContent1" class="notice-panel" style="display:block"></div>
    <button class="btn secondary" onclick="goTo('domain_tertiaire')">⬅ Retour domaine</button>
  </div>
</div>

<!-- Jeu 2 (LESATI A — Léa) -->
<div id="game2" class="screen">
  <div class="container">
    <h2>Jeu A — CCTP LESATI</h2>
    <div class="map">
      <div class="location" onclick="openModal('Direction',2)"><img src="https://cdn-icons-png.flaticon.com/512/219/219986.png" alt="">Direction (LESATI)</div>
      <div class="location" onclick="openModal('Service production',2)"><img src="https://cdn-icons-png.flaticon.com/512/1995/1995525.png" alt="">Service production (LESATI)</div>
      <div class="location" onclick="openModal('Salaries',2)"><img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="">Salariés (LESATI)</div>
      <div class="location" onclick="openModal('Juridique',2)"><img src="https://cdn-icons-png.flaticon.com/512/2569/2569069.png" alt="">Juridique (LESATI)</div>
    </div>
    <div class="info-log" id="infoLog2"></div>
    <button class="btn secondary" onclick="goTo('domain_production')">⬅ Retour domaine</button>
    <button id="btnCCTP2" class="btn" style="display:none;margin-top:1rem;" onclick="document.getElementById('notice2').style.display='block'">Rédiger le cahier des charges</button>
    <div id="notice2" class="notice-panel"><strong>Vous disposez de toutes les informations pour écrire un cahier des charges en 45 minutes.</strong></div>
  </div>
</div>

<!-- Jeu 3 (LESATI B — Léon) -->
<div id="game3" class="screen">
  <div class="container">
    <h2>Jeu B — LESATI (Léon)</h2>
    <div class="map">
      <div class="location" onclick="openModal('Direction B',3)"><img src="https://cdn-icons-png.flaticon.com/512/219/219986.png" alt="">Direction</div>
      <div class="location" onclick="openModal('Manager',3)"><img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="">Manager</div>
      <div class="location" onclick="openModal('Maintenance',3)"><img src="https://cdn-icons-png.flaticon.com/512/1995/1995525.png" alt="">Maintenance</div>
      <div class="location" onclick="openModal('Juridique B',3)"><img src="https://cdn-icons-png.flaticon.com/512/2569/2569069.png" alt="">Juridique</div>
      <div class="location" onclick="openModal('Sécurité',3)"><img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="">Responsable sécurité</div>
    </div>
    <div class="info-log" id="infoLog3"></div>
    <div style="margin-top:.5rem; display:flex; gap:.5rem; flex-wrap:wrap;">
      <button class="btn secondary" onclick="goTo('domain_production')">⬅ Retour domaine</button>
      <button id="btnCCTP3" class="btn" style="display:none" onclick="goTo('builder3')">Rédiger le cahier des charges</button>
    </div>
    <div class="notice-panel" id="notice3"><strong>Visitez les 5 services pour activer la rédaction.</strong></div>
  </div>
</div>

<!-- Assistant Jeu 3 (sans scoring) -->
<div id="builder3" class="screen">
  <div class="container">
    <h2>Assistant — CCTP LESATI (Léon)</h2>
    <div class="progress"><span id="builderProgress3"></span></div>
    <div class="tabs" id="builderTabs3"></div>
    <div id="builderPanels3"></div>
    <div class="notice-panel" id="builderWarn3" style="display:none">Veuillez sélectionner au moins un élément pour continuer.</div>
    <div style="display:flex;gap:.5rem;justify-content:space-between;margin-top:.8rem;">
      <button class="btn secondary" id="prevStep3">◀ Précédent</button>
      <div>
        <button class="btn secondary" onclick="goTo('game3')">Sauvegarder & Revenir à la carte</button>
        <button class="btn" id="nextStep3">Suivant ▶</button>
        <button class="btn" id="finishBuilder3" style="display:none">Générer le résumé</button>
      </div>
    </div>
  </div>
</div>

<div id="summary3" class="screen">
  <div class="container">
    <h2>Résumé — CCTP LESATI (Léon)</h2>
    <div class="summary" id="summaryContent3"></div>
    <div style="display:flex; gap:.5rem; margin-top:12px;">
      <button class="btn secondary" onclick="goTo('builder3')">Modifier</button>
      <button class="btn" onclick="goTo('domain_production')">Retour au domaine</button>
    </div>
  </div>
</div>

<!-- MODALE GLOBALE -->
<div class="overlay" id="overlay" onclick="closeModal()"></div>
<div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <h3 id="modalTitle"></h3>
  <figure>
    <img id="modalImage" src="" alt="Illustration">
    <figcaption id="modalCaption"></figcaption>
  </figure>
  <p id="modalContent"></p>
  <div style="display:flex;gap:.5rem;margin-top:.6rem;">
    <button class="btn" onclick="collectInfo()">Collecter l'information</button>
    <button class="btn secondary" onclick="closeModal()">Retour</button>
  </div>
</div>

<script>
  const screens=[...document.querySelectorAll('.screen')];
  function goTo(id){ screens.forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
  function startGame(n){
    const map={1:'game1_intro',2:'game2_intro',3:'game3_intro',4:'game4_intro',5:'game5_intro',6:'game6_intro'};
    goTo(map[n]);
  }

  // Data (TILESA / LESATI A / LESATI B) — avec textes et légendes
  const modalData1={
    'Direction':{ text:"Le président : « La santé et la sécurité sont nos priorités. »", image:"images/tilesia_direction.png" },
    'Technique':{ text:`Interventions en heures ouvrables, avis de passage, rapport semestriel.
Consommables à la charge du prestataire : papier toilette, essuie-mains, savon, sacs poubelles, désodorisants.`, image:"images/tilesia_technique.png" },
    'Salaries':{ text:"300 salariés, 4100 m², ambiance de coopération.", image:"images/tilesia_salaries.png" },
    'Juridique':{ text:"Décret 92-158 & Code du travail R.237-1 à R.237-28.", image:"images/tilesia_juridique.png" }
  };
  const modalData2={
    'Direction':{ text:'La directrice : "LESATI assure production, distribution et commercialisation à Saint Georges (800 clients). Priorité au service public et à la proximité client."', image:"images/direction_directrice_LESATI.png" },
    'Service production':{ text:'Certains groupes ont atteint leurs limites techniques... Nous aurons besoins de 3 groupes électrogènes d’une puissance nominale de 800 kVA, de type diesel avec les certifications "Ultra" et "Iso 9001". Il faut penser aux documents nécessaires pour la bonne utilisation du matériel.', image:"images/production_groupes_LESATI.png" },
    'Salaries':{ text:"Photo des 30 salariés devant l'entrée, croissance & partenariats.", image:"images/salaries_30_LESATI.png" },
    'Juridique':{ text:"Ajouter une garantie technique lors de l'achat des 3 groupes (livraison à Saint Georges). Utilisation en continu en milieu humide et chaud.", image:"images/juridique_garantie_LESATI.png" }
  };
  const modalData3={
    'Direction B':{ 
      text:`Pour répondre aux besoins énergétiques croissants de la Guyane au début des années 1980, le barrage a été construit au niveau d’un resserrement naturel du fleuve Sinnamary. Grâce à sa retenue d’eau, il alimente deux tiers des foyers du littoral guyanais.`, 
      image:"images/direction_LESATI_B.png" 
    },
    'Manager':{ 
      text:`Ce cahier des charges a pour objet la fourniture d’équipements destinés à l’exploitation et à la maintenance d’une centrale hydraulique (Petit Saut). Ces équipements doivent répondre aux exigences de performance, de durabilité, et de conformité aux normes en vigueur.`, 
      image:"images/manager_LESATI_B.png" 
    },
    'Maintenance':{ 
      text:`Les pièces de rechange sont utilisées sur les équipements suivants :
• Les pompes,
• Les moteurs électriques,
• Les kits de maintenance des pompes,
• Les capteurs analogiques et Tout ou rien de niveaux, pressostats, manomètres,
• Les filtres,
• Les clapets anti retour,
• Les vannes manuelles et motorisées,
• Les actionneurs (ex. électrovannes),
Les livrables attendus sont les suivants :
• L’ensemble des équipements, accompagnés de leurs certificats de conformité, notices techniques, plans d'installation si nécessaire.
• Rapport d’essais`, 
      image:"images/maintenance_LESATI_B.png" 
    },
    'Juridique B':{ 
      text:`Le titulaire garantit les fournitures contre tout défaut de fabrication ou de matière pour une durée minimale de 24 mois à compter de la date de mise en service ou 30 mois après livraison, selon la première échéance atteinte. En cas de défaillance, le remplacement ou la réparation des équipements sera pris en charge par le Titulaire.`, 
      image:"images/juridique_LESATI_B.png" 
    },
    'Sécurité':{ 
      text:`Les équipements devront être livrés avec protections contre l’humidité et les chocs. Une étiquette claire indiquant le contenu et la référence doit être visible sur chaque caisse.
Adresse du site : Centrale hydraulique de Sinnamary
97315 Sinnamary Guyane Française
Horaires de livraison : Du lundi au vendredi de 08h00 à 12h00
• Le titulaire devra prévenir 21 jours minimum à l’avance pour organiser la livraison.
• Le déchargement se fera par le transporteur, sauf accord contraire.
• Tout colis non conforme pourra être refusé.`, 
      image:"images/securite_LESATI_B.png" 
    }
  };

  let currentService='', currentGame=1;
  let collected1=new Set(), collected2=new Set(), collected3=new Set();

  function openModal(service, game=1){
    currentGame=game; currentService=service;
    const d= game===2 ? modalData2 : (game===3 ? modalData3 : modalData1);
    const it=d[service];
    document.getElementById('modalTitle').textContent=service.replace(' B','');
    document.getElementById('modalCaption').textContent=it.text; // légende liée
    document.getElementById('modalContent').textContent=it.text; // bloc texte
    document.getElementById('modalImage').src=it.image;
    document.getElementById('overlay').classList.add('active');
    document.getElementById('modal').classList.add('active');
  }
  function closeModal(){document.getElementById('overlay').classList.remove('active');document.getElementById('modal').classList.remove('active');}
  function collectInfo(){
    if(currentGame===3){
      collected3.add(currentService);
      document.getElementById('infoLog3').textContent='Infos collectées (LESATI B) : '+Array.from(collected3).map(s=>s.replace(' B','')).join(', ');
      if(collected3.size>=5){ document.getElementById('btnCCTP3').style.display='inline-block'; document.getElementById('notice3').style.display='block'; document.getElementById('notice3').innerHTML='<strong>Vous disposez de toutes les informations pour écrire un cahier des charges.</strong>'; }
    }else if(currentGame===2){
      collected2.add(currentService);
      document.getElementById('infoLog2').textContent='Infos collectées (LESATI) : '+Array.from(collected2).join(', ');
      if(collected2.size>=4) document.getElementById('btnCCTP2').style.display='inline-block';
    }else{
      collected1.add(currentService);
      document.getElementById('infoLog1').textContent='Infos collectées (TILESA) : '+Array.from(collected1).join(', ');
    }
    closeModal();
  }

  // QCM Jeu 1 (TILESA) - identique
  const steps1=[
    { id:"objet", label:"Objet", options:[ "Prestation de nettoyage intérieur des locaux du site TILESIA", "Périmètre: bureaux, circulation, escaliers, ascenseur, sanitaires, vestiaires, réfectoires", "Objectif: propreté, hygiène et confort des utilisateurs" ] },
    { id:"contexte", label:"Contexte", options:[ "Bâtiment R+3, 4100 m², ~300 salariés", "La politique santé sécurité est un enjeu majeur pour l’entreprise", "Locaux électriques accompagnés par personnel habilité" ] },
    { id:"definition", label:"Définition", options:[ "Nettoyage des sols (aspiration, balayage humide, lavage)", "Dépoussiérage des surfaces et mobiliers", "Désinfection des points de contact", "Sanitaires: nettoyage, désinfection et réassort" ] },
    { id:"limites_titulaire", label:"Limites Titulaire", options:[ "Consommables (papier, savon, sacs, désodorisants)", "Fourniture matériels et produits de nettoyage", "Avis de passage" ] },
    { id:"limites_entreprise", label:"Limites Entreprise", options:[ "Locaux d’entretien & points d’eau", "Accompagnement zones électriques", "Accès/badges/consignes sécurité" ] },
    { id:"qualite", label:"Qualité", options:[ "Plan qualité & fiches techniques", "Traçabilité interventions (registre/app)", "Indicateurs & amélioration" ] },
    { id:"conditions", label:"Conditions", options:[ "Respect sécurité & environnement", "Signalisation zones d'intervention", "Heures ouvrables", "Références réglementaires" ] },
    { id:"resultats", label:"Résultats", options:[ "Sols propres", "Sanitaires propres et réapprovisionnés", "Mobilier dépoussiéré" ] },
    { id:"reception_ref", label:"Réception", options:[ "Rapport semestriel (service technique)", "PV signé et daté", "Références réglementaires" ] }
  ];
  const answerKey1={ objet:[0], contexte:[0,1], definition:[0,1,2,3], limites_titulaire:[0,1], limites_entreprise:[0,1,2], qualite:[0,2], conditions:[0,1,2,3], resultats:[0,1,2], reception_ref:[0,1] };
  let builderSelections1={}, builderIndex1=0;
  const tabs1=document.getElementById('builderTabs1');
  const panels1=document.getElementById('builderPanels1');

  function validateCollection(game){
    const set = game===1 ? collected1 : game===2 ? collected2 : collected3;
    const needed = game===3 ? 5 : 4;
    if(set.size<needed){ alert("Visitez tous les services avant de continuer."); return; }
    if(game===1){ startBuilder1(true); }
  }

  function startBuilder1(reset=false){
    if(reset){builderSelections1={};tabs1.innerHTML="";panels1.innerHTML="";tabs1.dataset.ready="";}
    if(!tabs1.dataset.ready){
      steps1.forEach((s,i)=>{
        const b=document.createElement('button'); b.className='tab-btn'+(i===0?' active':''); b.textContent=`${i+1}. ${s.label}`; b.onclick=()=>goStep1(i); tabs1.appendChild(b);
        const p=document.createElement('div'); p.className='tab-panel'+(i===0?' active':''); p.id=`panel1-${s.id}`;
        p.innerHTML=`<h3>${i+1}. ${s.label}</h3><div class="option-grid">${s.options.map((opt,idx)=>`<div class="option"><label><input type="checkbox" data-step="${s.id}" data-opt="${idx}"> ${opt}</label></div>`).join('')}</div>`;
        panels1.appendChild(p);
      });
      panels1.addEventListener('change',(e)=>{
        const box=e.target; if(box && box.type==='checkbox'){ const stepId=box.dataset.step; const idx=Number(box.dataset.opt); if(!builderSelections1[stepId]) builderSelections1[stepId]=new Set(); if(box.checked) builderSelections1[stepId].add(idx); else builderSelections1[stepId].delete(idx); }
      });
      document.getElementById('prevStep1').onclick=()=>goStep1(builderIndex1-1);
      document.getElementById('nextStep1').onclick=()=>{ if(!hasAtLeastOne1(steps1[builderIndex1].id)){document.getElementById('builderWarn1').style.display='block';return;} document.getElementById('builderWarn1').style.display='none'; goStep1(builderIndex1+1); };
      document.getElementById('finishBuilder1').onclick=()=>{ if(!hasAtLeastOne1(steps1[builderIndex1].id)){document.getElementById('builderWarn1').style.display='block';return;} document.getElementById('builderWarn1').style.display='none'; finishBuilder1(); };
      tabs1.dataset.ready="1";
    }
    goStep1(0); goTo('builder1');
  }
  function hasAtLeastOne1(stepId){const set=builderSelections1[stepId];return set && set.size>0;}
  function goStep1(i){
    if(i<0||i>=steps1.length) return; builderIndex1=i;
    [...document.querySelectorAll('#builderTabs1 .tab-btn')].forEach((b,k)=>b.classList.toggle('active',k===i));
    [...document.querySelectorAll('#builderPanels1 .tab-panel')].forEach(p=>p.classList.remove('active'));
    document.getElementById(`panel1-${steps1[i].id}`).classList.add('active');
    document.getElementById('builderProgress1').style.width=Math.round((i)/(steps1.length-1)*100)+'%';
    document.getElementById('nextStep1').style.display=(i===steps1.length-1)?'none':'inline-block';
    document.getElementById('finishBuilder1').style.display=(i===steps1.length-1)?'inline-block':'none';
  }
  function finishBuilder1(){
    let html=''; steps1.forEach((s,i)=>{ const picked=[...(builderSelections1[s.id]||[])].sort((a,b)=>a-b); if(picked.length){ html+=`<h4>${i+1}. ${s.label}</h4><ul>`+picked.map(idx=>`<li>${s.options[idx]}</li>`).join('')+`</ul>`; } });
    document.getElementById('summaryContent1').innerHTML=html||"<em>Aucune sélection.</em>";
    // Score simple
    let total=0, ok=0;
    for(const s of steps1){ const key=answerKey1[s.id]||[]; total+=key.length; const picked=builderSelections1[s.id]?Array.from(builderSelections1[s.id]):[]; ok+=picked.filter(i=>key.includes(i)).length; }
    document.getElementById('scoreContent1').innerHTML=`<strong>Score :</strong> ${ok}/${total}`;
    goTo('summary1');
  }

  // Assistant Jeu 3 (LESATI B) — sans scoring
  const steps3=[
    { id:'objet', label:'Objet & périmètre', options:[
      "Fourniture/installation équipements hydrauliques et auxiliaires",
      "Modernisation automatisme/contrôle-commande",
      "Intégration au système existant (SCADA, télésurveillance)",
      "Prestations d’essais et mise en service"
    ]},
    { id:'performances', label:'Performances attendues', options:[
      "Puissance nominale par groupe et rendement minimal",
      "Courbe de charge et disponibilité cible (%)",
      "Tolérances vibratoires et acoustiques",
      "Plages environnementales (température, humidité)"
    ]},
    { id:'maintenance_docs', label:'Maintenance & documentation', options:[
      "Plan de maintenance préventive et pièces critiques",
      "Catalogue pièces détachées + références",
      "Dossiers techniques, manuels et schémas à jour",
      "Formations opérateurs et mainteneurs"
    ]},
    { id:'surete_securite', label:'Sûreté & sécurité', options:[
      "Procédures de consignation/étiquetage (LOTO)",
      "Dispositifs de protection (EPI, protections collectives)",
      "Plan de prévention et autorisations de travail",
      "Analyse des risques et mesures associées"
    ]},
    { id:'contractuel', label:'Contractuel & conformité', options:[
      "Garanties (pièces, main-d’œuvre, disponibilité)",
      "Pénalités de retard et responsabilités",
      "Conformité réglementaire et normes applicables",
      "Assurances et confidentialité"
    ]},
    { id:'livrables', label:'Livrables & réception', options:[
      "Protocoles d’essais/receptions et PV",
      "Dossier des ouvrages exécutés (DOE)",
      "Planning détaillé et jalons",
      "Support post-mise en service (SAV)"
    ]}
  ];
  let builderSelections3={}, builderIndex3=0;
  const tabs3=document.getElementById('builderTabs3');
  const panels3=document.getElementById('builderPanels3');
  function hasAtLeastOne3(stepId){const set=builderSelections3[stepId];return set && set.size>0;}

  function buildAssistant3(){
    if(tabs3.dataset.ready) return;
    steps3.forEach((s,i)=>{
      const b=document.createElement('button'); b.className='tab-btn'+(i===0?' active':''); b.textContent=`${i+1}. ${s.label}`; b.onclick=()=>goStep3(i); tabs3.appendChild(b);
      const p=document.createElement('div'); p.className='tab-panel'+(i===0?' active':''); p.id=`panel3-${s.id}`;
      p.innerHTML=`<h3>${i+1}. ${s.label}</h3><div class="option-grid">${s.options.map((opt,idx)=>`<div class="option"><label><input type="checkbox" data-step="${s.id}" data-opt="${idx}"> ${opt}</label></div>`).join('')}</div>`;
      panels3.appendChild(p);
    });
    panels3.addEventListener('change',(e)=>{
      const box=e.target; if(box && box.type==='checkbox'){ const stepId=box.dataset.step; const idx=Number(box.dataset.opt);
        if(!builderSelections3[stepId]) builderSelections3[stepId]=new Set();
        if(box.checked) builderSelections3[stepId].add(idx); else builderSelections3[stepId].delete(idx);
      }
    });
    document.getElementById('prevStep3').onclick=()=>goStep3(builderIndex3-1);
    document.getElementById('nextStep3').onclick=()=>{
      if(!hasAtLeastOne3(steps3[builderIndex3].id)){document.getElementById('builderWarn3').style.display='block';return;}
      document.getElementById('builderWarn3').style.display='none'; goStep3(builderIndex3+1);
    };
    document.getElementById('finishBuilder3').onclick=()=>{
      if(!hasAtLeastOne3(steps3[builderIndex3].id)){document.getElementById('builderWarn3').style.display='block';return;}
      document.getElementById('builderWarn3').style.display='none'; finishBuilder3();
    };
    tabs3.dataset.ready="1";
  }
  function goStep3(i){
    if(i<0||i>=steps3.length) return; builderIndex3=i;
    [...document.querySelectorAll('#builderTabs3 .tab-btn')].forEach((b,k)=>b.classList.toggle('active',k===i));
    [...document.querySelectorAll('#builderPanels3 .tab-panel')].forEach(p=>p.classList.remove('active'));
    document.getElementById(`panel3-${steps3[i].id}`).classList.add('active');
    document.getElementById('builderProgress3').style.width=Math.round((i)/(steps3.length-1)*100)+'%';
    document.getElementById('nextStep3').style.display=(i===steps3.length-1)?'none':'inline-block';
    document.getElementById('finishBuilder3').style.display=(i===steps3.length-1)?'inline-block':'none';
  }
  function finishBuilder3(){
    let html='';
    steps3.forEach((s,i)=>{
      const picked=[...(builderSelections3[s.id]||[])].sort((a,b)=>a-b);
      if(picked.length){ html+=`<h4>${i+1}. ${s.label}</h4><ul>`+picked.map(idx=>`<li>${s.options[idx]}</li>`).join('')+`</ul>`; }
    });
    document.getElementById('summaryContent3').innerHTML=html || "<em>Aucune sélection.</em>";
    goTo('summary3');
  }

  // Build assistant when screen visible
  const observer = new MutationObserver(()=>{
    if(document.getElementById('builder3').classList.contains('active')) buildAssistant3();
  });
  observer.observe(document.body, {attributes:true,subtree:true,attributeFilter:['class']});
</script>


<script>
(function(){
  const normalize = s => (s||'').trim().replace(/\s+/g,' ')
    .replace(/^Service production$/i,'Service production')
    .replace(/^Salar(ié|ie)s$/i,'Salariés')
    .replace(/^Sécurit(e|é)$/i,'Sécurité')
    .replace(/^Clients?$/i,'Clients')
    .replace(/^Manager$/i,'Manager')
    .replace(/^Maintenance$/i,'Maintenance')
    .replace(/^Direction$/i,'Direction')
    .replace(/^Juridique$/i,'Juridique');

  document.addEventListener('click', function(e){
    const card = e.target.closest('.location');
    if(!card) return;
    const screen = card.closest('.screen');
    if(!screen || !/^game[1-6]$/.test(screen.id)) return;
    const gameId = Number(screen.id.replace('game',''));
    let key = card.getAttribute('data-key') || card.querySelector('[data-title]')?.getAttribute('data-title') || card.textContent;
    key = normalize(key);

    const maps = {1:window.modalData1,2:window.modalData2,3:window.modalData3,4:window.modalData4,5:window.modalData5,6:window.modalData6};
    const map = maps[gameId] || {}; const item = map[key];
    if(!item){ console.warn('Item not found', gameId, key); return; }

    const panel = screen.querySelector('.detail-panel');
    if(!panel) return;
    panel.querySelector('.detail-title').textContent = key;
    const body = panel.querySelector('.detail-body');
    body.innerHTML = (item.image?('<img alt="'+key+'" src="'+item.image+'">'):'') + (item.text||'');
    panel.classList.add('active');

    window.currentGame = gameId; window.currentKey = key;

    const btnC = panel.querySelector('#btnCollectInline');
    const btnX = panel.querySelector('#btnCloseInline');
    if(btnC){
      btnC.onclick = function(){
        try{ if(typeof collectInfo==='function') collectInfo(); }catch(e){}
        if(!card.querySelector('.badge-visited')){
          const b=document.createElement('span'); b.className='badge-visited'; b.textContent='✔ Visité'; card.appendChild(b);
        }
      };
    }
    if(btnX){ btnX.onclick = function(){ panel.classList.remove('active'); }; }
  });
})();
</script>

</body>
</html>
