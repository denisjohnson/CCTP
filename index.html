<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CCTP — Domaines & Jeux</title>
<style>
:root{
  --bg:#f6f8fb;
  --card:#fff;
  --text:#1f2d3d;
  --muted:#5b6b7b;
  --brand:#0a74da;
  --brand-dark:#095aba;
  --ok:#0ea5e9;
  --good:#16a34a;
  --warn:#f59e0b;
  --bad:#dc2626;
  --shadow:0 10px 24px rgba(0,0,0,.08);
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
.container{max-width:1120px;margin:0 auto;padding:clamp(14px,3vw,28px)}
h1,h2,h3{margin:.2rem 0 .8rem}
h1{font-size:clamp(1.4rem,2.3vw,2rem)}
h2{font-size:clamp(1.2rem,2vw,1.6rem)}
h3{font-size:clamp(1.05rem,1.7vw,1.2rem)}
.muted{color:var(--muted)}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px}
.card{background:var(--card);border-radius:14px;box-shadow:var(--shadow);padding:16px}
.btn{display:inline-flex;align-items:center;gap:.45rem;padding:.65rem 1rem;border-radius:10px;border:none;background:var(--brand);color:#fff;font-weight:600;cursor:pointer}
.btn:hover{background:var(--brand-dark)}
.btn.secondary{background:#e9eef5;color:#1f2d3d}
.screen{display:none}
.screen.active{display:block}
.hero{width:100%;max-width:980px;margin:0 auto 14px;display:block;border-radius:16px;box-shadow:var(--shadow);max-height:60vh;object-fit:contain}
.domain-title{margin-top:4px;margin-bottom:12px}
.row{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:14px}
.service{display:flex;align-items:center;gap:14px;background:#fff;border-radius:16px;box-shadow:var(--shadow);padding:18px;cursor:pointer;transition:transform .15s ease}
.service:hover{transform:translateY(-2px)}
.service img{width:60px;height:60px;border-radius:50%;object-fit:contain;display:block}
.kit{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.6rem}
.small{color:#556272;font-size:.92rem}
.center{display:flex;align-items:center;justify-content:center}
/* Modal */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;z-index:999}
.overlay.active{display:block}
.modal{position:fixed;left:50%;top:5%;transform:translateX(-50%);width:min(92vw,860px);max-height:90vh;overflow:auto;background:#fff;border-radius:16px;box-shadow:0 18px 50px rgba(0,0,0,.3);padding:clamp(14px,2.5vw,22px);display:none;z-index:1000}
.modal.active{display:block}
.modal img{width:100%;max-height:40vh;object-fit:contain;margin:8px 0;border-radius:10px;box-shadow:var(--shadow)}
.modal .actions{display:flex;gap:.5rem;justify-content:flex-end;margin-top:10px}
.badge{padding:.3rem .6rem;border-radius:999px;border:1px solid #cbd5e1;background:#f1f5f9;font-weight:700;font-size:.8rem}
.badge.debutant{background:#fef2f2;border-color:#fecaca;color:#991b1b}
.badge.avance{background:#fff7ed;border-color:#fed7aa;color:#b45309}
.badge.expert{background:#ecfeff;border-color:#bae6fd;color:#075985}
.badge.genie{background:#ecfdf5;border-color:#a7f3d0;color:#065f46}
.progress{height:10px;border-radius:999px;background:#e5ecf6;overflow:hidden;margin:10px 0}
.progress>span{display:block;height:100%;background:var(--brand);width:0%}
.tabbar{display:flex;flex-wrap:wrap;gap:.4rem;margin:.6rem 0}
.tabbar button{border:1px solid #d4deea;background:#fff;border-radius:12px;padding:.45rem .7rem;cursor:pointer}
.tabbar button.active{background:var(--brand);color:#fff;border-color:var(--brand)}
.panel{display:none;background:#fff;border-radius:14px;padding:12px;box-shadow:var(--shadow)}
.panel.active{display:block}
.options{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:8px;margin-top:8px}
.option{border:1px solid #e5e7eb;padding:8px;border-radius:10px;background:#fafafa}
.summary{background:#fff;border-radius:14px;padding:16px;box-shadow:var(--shadow)}
.notice{background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;padding:12px;margin-top:10px}
</style>
</head>
<body>
<div id="home" class="screen active">
  <div class="container">
    <img class="hero" src="images/accueil_salle_formation.png" alt="Salle de formation" />
    <h2>Choisissez votre domaine</h2>
    <div class="grid">
      <div class="card">
        <h3 class="domain-title">Domaine Production</h3>
        <p class="muted">Jeux de l'entreprise <strong>LESATI</strong> (Thermique, Hydraulique, Smart Grids).</p>
        <div class="kit">
          <button class="btn" onclick="openDomain('lesati')">Accéder</button>
        </div>
      </div>
      <div class="card">
        <h3 class="domain-title">Domaine Réseau</h3>
        <p class="muted">Jeux de l'entreprise <strong>COPAYA</strong> (Réseaux & Exploitation).</p>
        <div class="kit">
          <button class="btn" onclick="openDomain('copaya')">Accéder</button>
        </div>
      </div>
      <div class="card">
        <h3 class="domain-title">Domaine Tertiaire</h3>
        <p class="muted">Jeux de l'entreprise <strong>TILESA</strong> (Tertiaire et Telecom).</p>
        <div class="kit">
          <button class="btn" onclick="openDomain('tilesa')">Accéder</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- LESATI domain -->
<div id="dom_lesati" class="screen">
  <div class="container">
    <h1>LESATI — Jeux</h1>
    <div class="grid">
      <div class="card">
        <h2>Jeu A — Centrale Thermique (Léa)</h2>
        <p class="muted">Centrale Thermique : explorez les services de la centrale thermique, puis rédigez le cahier des charges.</p>
        <div class="kit">
          <button class="btn" onclick="startGame('LESATI_A')">Démarrer</button>
          <button class="btn secondary" onclick="go('home')">Retour</button>
        </div>
      </div>
      <div class="card">
        <h2>Jeu B — Centrale Hydraulique (Léon)</h2>
        <p class="muted">Centrale Hydraulique : explorez les services de la centrale hydraulique, puis rédigez le cahier des charges.</p>
        <div class="kit">
          <button class="btn" onclick="startGame('LESATI_B')">Démarrer</button>
          <button class="btn secondary" onclick="go('home')">Retour</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- COPAYA domain -->
<div id="dom_copaya" class="screen">
  <div class="container">
    <h1>COPAYA — Jeux</h1>
    <div class="grid">
      <div class="card">
        <h2>Jeu A — Élagage (Sylvie)</h2>
        <p class="muted">Élagage : explorez les services, puis rédigez le cahier des charges.</p>
        <div class="kit">
          <button class="btn" onclick="startGame('COPAYA_A')">Démarrer</button>
          <button class="btn secondary" onclick="go('home')">Retour</button>
        </div>
      </div>
      <div class="card">
        <h2>Jeu B — Raccordement HTA (Carl)</h2>
        <p class="muted">Raccordement HTA : explorez les services, puis rédigez le cahier des charges.</p>
        <div class="kit">
          <button class="btn" onclick="startGame('COPAYA_B')">Démarrer</button>
          <button class="btn secondary" onclick="go('home')">Retour</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- TILESA domain -->
<div id="dom_tilesa" class="screen">
  <div class="container">
    <h1>TILESA — Jeux</h1>
    <div class="grid">
      <div class="card">
        <h2>Jeu A — Nettoyage des sites (Alex)</h2>
        <p class="muted">Nettoyage des sites : explorez les services, puis rédigez le cahier des charges.</p>
        <div class="kit">
          <button class="btn" onclick="startGame('TILESA_A')">Démarrer</button>
          <button class="btn secondary" onclick="go('home')">Retour</button>
        </div>
      </div>
      <div class="card">
        <h2>Jeu B — Véhicules Électriques (Manon)</h2>
        <p class="muted">Véhicules Électriques : explorez les services, puis rédigez le cahier des charges.</p>
        <div class="kit">
          <button class="btn" onclick="startGame('TILESA_B')">Démarrer</button>
          <button class="btn secondary" onclick="go('home')">Retour</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Generic Game Screen -->
<div id="game" class="screen">
  <div class="container">
    <div id="gameIntro"></div>
    <div id="gameMap" class="row"></div>
    <div class="kit">
      <button class="btn" id="btnWrite" style="display:none" onclick="launchBuilder()">Rédiger le CCTP</button>
      <button class="btn secondary" onclick="goBackDomain()">⬅ Retour</button>
    </div>
    <div class="small" id="collectLog" style="margin-top:8px"></div>
  </div>
</div>

<!-- Builder -->
<div id="builder" class="screen">
  <div class="container">
    <h2 id="builderTitle">Assistant CCTP</h2>
    <div class="small">Sélectionnez les éléments pertinents. Les aides sont facultatives.</div>
    <div class="progress"><span id="progressBar"></span></div>
    <div class="tabbar" id="tabbar"></div>
    <div id="panels"></div>
    <div class="kit" style="justify-content:space-between;margin-top:10px">
      <button class="btn secondary" onclick="go('game')">Retour carte</button>
      <div>
        <button class="btn secondary" id="prevStep">◀ Précédent</button>
        <button class="btn" id="nextStep">Suivant ▶</button>
        <button class="btn" id="finishBtn" style="display:none">Générer le résumé</button>
      </div>
    </div>
  </div>
</div>

<!-- Summary -->
<div id="summary" class="screen">
  <div class="container">
    <h2>Résumé du CCTP</h2>
    <div id="summaryBox" class="summary"></div>
    <div id="scoreBox" class="notice" style="margin-top:10px"></div>
    <div class="kit" style="margin-top:10px">
      <button class="btn" onclick="go('home')">Retour à l'accueil</button>
      <button class="btn secondary" onclick="go(currentDomainScreen())">Rejouer ce domaine</button>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="overlay" class="overlay" onclick="closeModal()"></div>
<div id="modal" class="modal" role="dialog" aria-modal="true">
  <h3 id="modTitle"></h3>
  <!-- No legends under the image -->
  <img id="modImg" alt="" />
  <div id="modText" class="small"></div>
  <div class="actions">
    <button class="btn" onclick="collect()">Collecter l'information</button>
    <button class="btn secondary" onclick="closeModal()">Fermer</button>
  </div>
</div>

<script>
// ---------- Router helpers
function go(id){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
function openDomain(key){ go('dom_'+key); }
function currentDomainScreen(){
  if(currentGame.startsWith('LESATI')) return 'dom_lesati';
  if(currentGame.startsWith('COPAYA')) return 'dom_copaya';
  return 'dom_tilesa';
}
function goBackDomain(){ go(currentDomainScreen()); }

// ---------- Game data
const GAMES = {
  LESATI_A: {
    title: 'LESATI — Jeu A (Centrale Thermique)',
    intro: 'Léa, chargée d\'affaires du service production, est volontaire pour réaliser l\'expression du besoin. Il s\'agit de l\'achat de 3 nouveaux groupes électrogènes.',
    introImg: 'images/lea_centrale_LESATI.png',
    places: [
      {label:'Direction', img:'images/direction_directrice_LESATI.png', text:`La directrice s'explique : "L'entreprise LESATI assure les missions de production, distribution et commercialisation de l'énergie dans la commune de Saint Georges (800 clients). La mission de service public et la proximité client sont nos priorités".`},
      {label:'Service production', img:'images/production_groupes_LESATI.png', text:`Certains de ces groupes ont atteint leurs limites techniques (dépassement du nombre d’heures limites prévues par le constructeur) et devront être révisés. À ce stade une révision serait plus onéreuse que l’achat de matériels neufs.`},
      {label:'Salariés', img:'images/salaries_30_LESATI.png', text:`Les 30 salariés devant l’entrée du bâtiment principal. Il sont pleinement investis dans le développement local et dans la relation avec les clients de la ville.`},
      {label:'Juridique', img:'images/juridique_garantie_LESATI.png', text:`La juriste rappelle qu'il est indispensable d'ajouter une garantie technique lors de l'achat des 3 groupes électrogènes avec la livraison à Saint Georges. Les groupes seront utilisés en continu en milieu humide et chaud.`},
    ],
    builder: null // no custom QCM (déjà OK côté utilisateur)
  },
  LESATI_B: {
    title: 'LESATI — Jeu B (Centrale Hydraulique)',
    intro: 'LÉON, nouveau chef de projet, est volontaire pour rédiger le futur cahier des charges pour l\'achat de pièces de rechange de la centrale hydraulique.',
    introImg: 'images/leon_centrale_LESATI.png',
    places: [
      {label:'Direction', img:'images/direction_LESATI_B.png', text:`Pour répondre aux besoins énergétiques croissants de la Guyane au début des années 1980, le barrage a été construit au niveau d’un resserrement naturel du fleuve Sinnamary. Grâce à sa retenue d’eau, il alimente deux tiers des foyers du littoral guyanais.`},
      {label:'Manager', img:'images/manager_LESATI_B.png', text:`Ce cahier des charges a pour objet la fourniture d’équipements destinés à l’exploitation et à la maintenance d’une centrale hydraulique (Sinnamary). Ces équipements doivent répondre aux exigences de performance, de durabilité, et de conformité aux normes en vigueur.`},
      {label:'Maintenance', img:'images/maintenance_LESATI_B.png', text:`Les pièces de rechange concernent : pompes, moteurs électriques, kits de maintenance de pompes, capteurs (analogiques et TOR de niveaux), pressostats, manomètres, filtres, clapets anti-retour, vannes manuelles & motorisées, actionneurs (électrovannes). Livrables : équipements + certificats de conformité, notices, plans si besoin, et rapport d'essais.`},
      {label:'Juridique', img:'images/juridique_LESATI_B.png', text:`Le titulaire garantit les fournitures 24 mois après mise en service ou 30 mois après la livraison. En cas de défaillance, remplacement ou réparation pris en charge par le Titulaire.`},
      {label:'Sécurité', img:'images/securite_LESATI_B.png', text:`Livraison protégée (humidité/chocs), étiquettes claires. Adresse : Centrale hydraulique de Sinnamary, 97315 Sinnamary, Guyane Française. Horaires : Lun-Ven 08h00–12h00. Préavis 21 jours, déchargement par transporteur, colis non conforme refusé.`}
    ],
    builder: makeBuilder_LESATI_B()
  },
  COPAYA_A: {
    title: 'COPAYA — Jeu A (Élagage)',
    intro: 'Vous incarnez Sylvie, chargée d’affaires. Objectif : préparer le CCTP pour les prestations d’élagage.',
    introImg: 'images/copaya_accueil.png',
    places: [
      {label:'Direction', img:'images/copaya_direction.png', text:`L'élagage est essentiel pour prévenir les coupures d'électricité et assurer la continuité de l'alimentation. Copaya supervise l'élagage des arbres à proximité des lignes électriques pour éviter les dommages sur le réseau.`},
      {label:'Clients', img:'images/clients_copaya.png', text:`Les propriétaires doivent entretenir les arbres. L’élagage près des réseaux est géré par des professionnels disposant d’une AIPR (Autorisation d’intervention à proximité des réseaux électriques). La végétation peut provoquer des risques pour les tiers et des coupures.`},
      {label:'Maintenance', img:'images/copaya_maintenance.png', text:`Distances attendues : HTA 405 km/an, HTB 250 km/an, 100 pieds de support/an + accès. Compte rendu précis avec photos avant/après. Procédures d’accès et plans fournis par Copaya. Chantiers 6h30–17h00 (hors horaires → accord écrit Copaya). DT-DICT 15 jours avant travaux.`},
      {label:'Environnement', img:'images/copaya_environnement.png', text:`Zones protégées, espèces, périodes de nidification, risques d’incendie : réglementation évolutive et exigences de préservation.`},
      {label:'Sécurité', img:'images/copaya_securite.png', text:`EPC/EPI requis : balisage, cônes, gyrophare/voyants, panneaux 50m, casque, gants, protections auditives, vêtements, chaussures de sécurité, matériel d’ascension contrôlé.`}
    ],
    builder: makeBuilder_COPAYA_A()
  },
  COPAYA_B: {
    title: 'COPAYA — Jeu B (Raccordement HTA)',
    intro: 'Vous incarnez Carl, chargé d’affaires réseau. Objectif : CCTP pour le raccordement HTA d’un village.',
    introImg: 'images/copaya_intro.png',
    places: [
      {label:'La Directrice', img:'images/copaya_directrice.png', text:`Ce projet est d’une grande importance. Nous voulons fournir la même qualité de service à l’ensemble des habitants présents sur le territoire. Respect des délais, nuisances limitées, fin avant la saison des pluies.`},
      {label:'Équipe', img:'images/copaya_equipe.png', text:`Le titulaire transmet le planning pour la FDO. Communications via outil dédié. Copaya fournit câbles, boîtes de jonction et local de stockage. Le Titulaire fournit les chambres de tirage.`},
      {label:'Manager', img:'images/copaya_manager.png', text:`Mise en souterrain de 20 km HTA + 15 km fibre ; 60 boîtes de jonction HTA ; fourniture/pose de fourreaux ; fouille + dalle de propreté ; installation, mise en service d’armoire ; raccordement + étiquetage des câbles HTA ; durée : 4 mois.`},
      {label:'Habitants', img:'images/copaya_habitants.png', text:`Les habitants attendent une stabilisation du réseau. Impacts chaussée et bruit à minimiser.`},
      {label:'Juriste', img:'images/copaya_juriste.png', text:`Respect DGTM pour travaux voie publique. Déclaration de commencement de travaux avant ouverture ; transmission au MOA. IC/OL nécessaires selon décret n°2011‑12.`},
      {label:'Prévention', img:'images/copaya_prevention.png', text:`Sécurité : cônes de balisage, gyrophare/voyants, panneaux à 50 m. Visites régulières de prévention sécurité par COPAYA.`}
    ],
    builder: makeBuilder_COPAYA_B()
  },
  TILESA_A: {
    title: 'TILESA — Jeu A (Nettoyage)',
    intro: 'Alex vous accueille pour explorer les services TILESA avant de rédiger le CCTP.',
    introImg: 'images/tilesia_accueil_alex.png',
    places: [
      {label:'Direction', img:'images/tilesia_direction.png', text:`Le président vous accueille : « La santé et la sécurité sont mes priorités pour garantir le bon fonctionnement de l’entreprise et le bien-être des salariés. »`},
      {label:'Technique', img:'images/tilesia_technique.png', text:`Intervention en heures ouvrables (sauf exception). Locaux électriques accompagnés par agent habilité.
Espaces : bureaux, couloirs, escaliers, ascenseur, sanitaires, vestiaires, réfectoires.
Avis de passage. Rapport semestriel par le service technique.

Consommables à la charge du prestataire :
- Papier toilette
- Essuie-mains
- Savon liquide à mains
- Sacs poubelles
- Désodorisants.`},
      {label:'Salariés', img:'images/tilesia_salaries.png', text:`Il y a 300 salariés dans le bâtiment répartis sur 4 étages (4100 m²). Ambiance de coopération et de réunions.`},
      {label:'Juridique', img:'images/tilesia_juridique.png', text:`Décret 92-158 du 20 février 1992 – Code du travail (R.237-1 à R.237-28) applicables aux travaux réalisés par une entreprise extérieure.`}
    ],
    builder: null
  },
  TILESA_B: {
    title: 'TILESA — Jeu B (Véhicules Électriques)',
    intro: `Vous incarnez Manon, pilote de la maintenance des véhicules. Vous êtes en charge de la rédaction d’un cahier des charges pour l’achat de véhicules électriques neufs permettant de renouveler la flotte. La consultation sera lancée dans 9 mois et vous anticipez cette étape.`,
    introImg: 'images/accueil_sabrina.png',
    places: [
      {label:'Direction', img:'images/direction.png', text:`Développement durable : électrification de la flotte en Guyane. 150 véhicules dont 30% à remplacer par des modèles électriques.`},
      {label:'Manager', img:'images/manager.png', text:`Le Titulaire devra assurer :
- Fourniture de véhicules électriques neufs (homologués FR, adaptés Guyane)
- Livraison sur les sites : Cayenne, Kourou, Saint‑Laurent‑du‑Maroni…
- Mise en service complète (immatriculation locale, première charge, vérifications fonctionnelles)
- Formation des utilisateurs à la conduite de VE
- Documentation complète (certificats, manuels, garanties)
- SAV assuré localement ou via partenaire agréé en Guyane
- Véhicules livrées les jours d’ouverture des sites`},
      {label:'Services', img:'images/services.png', text:`Besoins :
- Service réseau : tout‑chemin électriques ou PHEV pour zones d’accès difficile
- Clientèle : petits utilitaires électriques (matériel & équipes techniques)
- Finance : berlines/citadines électriques (déplacements professionnels)`},
      {label:'Technique', img:'images/technique.png', text:`Le Titulaire prendra en charge :
- Acheminement vers la Guyane (maritime, douane, manutention, livraison finale)
- Formalités d’immatriculation
- Équipements de base (câbles, kit sécurité, roue de secours/kit anti-crevaison)

L’entreprise assurera :
- Emplacements de réception & stationnement
- Assurance des véhicules
- Installation & entretien des bornes de recharge
- Suivi administratif (cartes grises, fiscalité, contrôles)`},
      {label:'Juriste', img:'images/juriste.png', text:`Cadre européen : interdiction des ventes thermiques neuves à partir de 2035, norme CAFE, recyclage & passeport numérique de batterie.`},
      {label:'Responsable Environnement', img:'images/responsable_environnement.png', text:`Objectifs :
- Réduction mesurable des émissions de CO₂ & coûts énergétiques
- Amélioration du confort & de la sécurité des utilisateurs
- Fonctionnement optimal malgré les contraintes territoriales`}
    ],
    builder: makeBuilder_TILESA_B()
  }
};

// ---------- Clickable map rendering
let currentGame = null;
let collected = new Set();
let visitedCountRequired = 0;

function startGame(key){
  currentGame = key;
  const g = GAMES[key];
  collected = new Set();
  visitedCountRequired = g.places.length;
  const introHTML = `
    <h1>${g.title}</h1>
    <p class="muted">${g.intro}</p>
    <img class="hero" src="${g.introImg}" alt="illustration" />
  `;
  document.getElementById('gameIntro').innerHTML = introHTML;

  const map = document.getElementById('gameMap');
  map.innerHTML = '';
  g.places.forEach((p, idx)=>{
    const card = document.createElement('div');
    card.className='service';
    card.onclick = ()=>openModal(idx);
    card.innerHTML = `<img src="${p.img}" alt=""><div><h3>${p.label}</h3></div>`;
    map.appendChild(card);
  });
  document.getElementById('btnWrite').style.display='none';
  document.getElementById('collectLog').textContent = '';
  go('game');
}

function openModal(idx){
  const p = GAMES[currentGame].places[idx];
  document.getElementById('modTitle').textContent = p.label;
  document.getElementById('modImg').src = p.img;
  document.getElementById('modText').textContent = p.text; // no caption block
  document.getElementById('overlay').classList.add('active');
  document.getElementById('modal').classList.add('active');
  document.getElementById('modal').dataset.idx = idx;
}
function closeModal(){
  document.getElementById('overlay').classList.remove('active');
  document.getElementById('modal').classList.remove('active');
}
function collect(){
  const idx = +document.getElementById('modal').dataset.idx;
  collected.add(idx);
  document.getElementById('collectLog').textContent = `Informations collectées : ${collected.size}/${visitedCountRequired}`;
  closeModal();
  if(collected.size >= visitedCountRequired){
    document.getElementById('btnWrite').style.display='inline-flex';
  }
}

// ---------- Builders (QCM)
let builderSteps = [];
let builderSelections = {};
let builderIndex = 0;
let answerKey = {};

function launchBuilder(){
  const config = GAMES[currentGame].builder;
  if(!config){ // simple generic empty builder
    builderSteps = genericSteps();
    answerKey = genericAnswers(builderSteps.length);
  }else{
    builderSteps = config.steps;
    answerKey = config.answerKey;
  }
  builderSelections = {};
  builderIndex = 0;
  renderBuilder();
  go('builder');
}
function renderBuilder(){
  document.getElementById('builderTitle').textContent = 'Assistant — ' + GAMES[currentGame].title;
  const tabbar = document.getElementById('tabbar');
  const panels = document.getElementById('panels');
  tabbar.innerHTML=''; panels.innerHTML='';
  builderSteps.forEach((s,i)=>{
    const b = document.createElement('button');
    b.textContent = `${i+1}. ${s.label}`;
    b.className = i===0?'active':'';
    b.onclick = ()=>goStep(i);
    tabbar.appendChild(b);
    const p = document.createElement('div');
    p.className = 'panel' + (i===0?' active':'');
    p.id = 'p'+i;
    p.innerHTML = `
      <h3>${i+1}. ${s.label}</h3>
      ${s.help?`<details class="small"><summary>Aide (facultatif)</summary><p>${s.help}</p></details>`:''}
      <div class="options">
      ${s.options.map((opt,idx)=>`
        <div class="option"><label><input type="checkbox" data-s="${i}" data-o="${idx}"> ${opt}</label></div>
      `).join('')}
      </div>
    `;
    p.addEventListener('change', (ev)=>{
      const box = ev.target;
      if(box && box.type==='checkbox'){
        const sid = builderSteps[+box.dataset.s].id;
        if(!builderSelections[sid]) builderSelections[sid] = new Set();
        if(box.checked) builderSelections[sid].add(+box.dataset.o); else builderSelections[sid].delete(+box.dataset.o);
      }
    });
    panels.appendChild(p);
  });
  document.getElementById('prevStep').onclick = ()=>goStep(builderIndex-1);
  document.getElementById('nextStep').onclick = ()=>{
    if(!hasOne(builderIndex)){ alert('Sélectionnez au moins un élément.'); return; }
    goStep(builderIndex+1);
  };
  document.getElementById('finishBtn').onclick = finishBuilder;
  goStep(0);
}
function hasOne(i){
  const sid = builderSteps[i].id;
  const set = builderSelections[sid];
  return set && set.size>0;
}
function goStep(i){
  if(i<0 || i>=builderSteps.length) return;
  builderIndex = i;
  [...document.getElementById('tabbar').children].forEach((b,k)=>b.classList.toggle('active',k===i));
  [...document.getElementById('panels').children].forEach((p,k)=>p.classList.toggle('active',k===i));
  const pct = Math.round((i)/(builderSteps.length-1)*100);
  document.getElementById('progressBar').style.width = pct+'%';
  document.getElementById('prevStep').disabled = (i===0);
  document.getElementById('nextStep').style.display = (i===builderSteps.length-1)?'none':'inline-flex';
  document.getElementById('finishBtn').style.display = (i===builderSteps.length-1)?'inline-flex':'none';
}
function finishBuilder(){
  if(!hasOne(builderIndex)){ alert('Sélectionnez au moins un élément.'); return; }
  // Summary
  let html='';
  builderSteps.forEach((s,idx)=>{
    const set = builderSelections[s.id] ? Array.from(builderSelections[s.id]).sort((a,b)=>a-b) : [];
    if(set.length){ html += `<h3>${idx+1}. ${s.label}</h3><ul>` + set.map(i=>`<li>${s.options[i]}</li>`).join('') + '</ul>'; }
  });
  if(!html) html='<p>Aucun élément sélectionné.</p>';
  document.getElementById('summaryBox').innerHTML = html;

  // Score
  let total=0, good=0;
  builderSteps.forEach(s=>{
    const key = answerKey[s.id] || [];
    total += key.length;
    const picked = builderSelections[s.id] ? Array.from(builderSelections[s.id]) : [];
    good += picked.filter(i=>key.includes(i)).length;
  });
  const pct = total?Math.round((good/total)*100):0;
  let lvlCls='debutant', lvl='Débutant';
  if(pct>95){ lvl='Génie'; lvlCls='genie'; }
  else if(pct>=71){ lvl='Expert'; lvlCls='expert'; }
  else if(pct>=51){ lvl='Avancé'; lvlCls='avance'; }
  else { lvl='Débutant'; lvlCls='debutant'; }
  document.getElementById('scoreBox').innerHTML = `Score : <strong>${good}/${total}</strong> (${pct}%) <span class="badge ${lvlCls}">${lvl}</span>`;
  go('summary');
}

// ---------- Builders per game
function genericSteps(){
  return [
    {id:'objet',label:'Objet',options:['—'],help:'Définir l’objet.'},
    {id:'ctx',label:'Contexte',options:['—']},
    {id:'def',label:'Définition de la prestation',options:['—']},
    {id:'lim_tit',label:'Limites à la charge du titulaire',options:['—']},
    {id:'lim_ent',label:'Limites à la charge de l’entreprise',options:['—']},
    {id:'qual',label:'Qualité',options:['—']},
    {id:'cond',label:'Conditions d’interventions',options:['—']},
    {id:'res',label:'Résultats attendus',options:['—']},
    {id:'rec',label:'Réception',options:['—']},
  ];
}
function genericAnswers(n){ const a={}; return a; }

function makeBuilder_LESATI_B(){
  return {
    steps:[
      {id:'objet',label:'Objet',help:'Ce que couvre l’achat.',options:[
        'Fourniture d’équipements pour exploitation/maintenance centrale hydraulique',
        'Achat de 3 GE pour centrale thermique',
        'Prestations de nettoyage industriel',
      ]},
      {id:'ctx',label:'Contexte',help:'Mise en service et rôle du barrage.',options:[
        'Barrage construit au niveau d’un resserrement du Sinnamary, retient 310 km² et alimente 2/3 du littoral',
        'Projet urbain hors énergie',
        'Site isolé sans production électrique',
      ]},
      {id:'def',label:'Définition de la prestation',options:[
        'Pompes, moteurs, kits de maintenance, capteurs, pressostats/manomètres, filtres, clapets, vannes, actionneurs',
        'Mobilier de bureau',
        'Déploiement réseau fibre nationale',
      ]},
      {id:'lim_tit',label:'Limites à la charge du titulaire',options:[
        'Remplacement/réparation en cas de défaillance pendant garantie',
        'Fourniture de carburant des groupes',
        'Surveillance 24/7 du barrage',
      ]},
      {id:'lim_ent',label:'Limites à la charge de l’entreprise',options:[
        'Organisation de la réception sur site (créneaux 8h-12h)',
        'Déchargement par transporteur sauf accord contraire',
        'Fourniture des plans d’installation interne',
      ]},
      {id:'qual',label:'Qualité',options:[
        'Certificats de conformité, notices, plans d’installation si nécessaire',
        'Aucun document requis',
        'Tolérance aux pièces non conformes',
      ]},
      {id:'cond',label:'Conditions d’interventions',options:[
        'Préavis 21 jours pour livraison, protection contre humidité/chocs, étiquettes claires',
        'Pas de contrôle des colis',
        'Livraison à toute heure sans rendez-vous',
      ]},
      {id:'res',label:'Résultats attendus',options:[
        'Équipements conformes & opérationnels, rapport d’essais fourni',
        'Rapport non nécessaire',
        'Équipements partiels acceptés',
      ]},
      {id:'rec',label:'Réception',options:[
        'Contrôle des documents & essais, PV de réception',
        'Réception tacite sans vérification',
        'Livraison = réception automatique',
      ]},
    ],
    answerKey:{
      objet:[0],
      ctx:[0],
      def:[0],
      lim_tit:[0],
      lim_ent:[0,1],
      qual:[0],
      cond:[0],
      res:[0],
      rec:[0]
    }
  };
}

function makeBuilder_COPAYA_A(){
  return {
    steps:[
      {id:'objet',label:'Objet',options:[
        'Élagage de la végétation autour des ouvrages HTA/HTB en Guyane',
        'Raccordement HTA d’un village',
        'Nettoyage des locaux',
      ]},
      {id:'ctx',label:'Contexte',options:[
        'Végétation rapide : risques pour tiers et coupures clients',
        'Stable sans risque',
        'Contexte maritime uniquement',
      ]},
      {id:'def',label:'Définition de la prestation',help:'Intégrer les distances attendues.',
       options:[
         'Élagage HTA 405 km/an, HTB 250 km/an, 100 pieds de support/an + accès',
         'Balayage de bureaux',
         'Pose d’armoire HTA',
       ]},
      {id:'lim_tit',label:'Limites à la charge du titulaire',options:[
        'Compte rendu précis avec photos avant/après',
        'Respect des procédures/DT-DICT et créneaux 6h30–17h',
        'Fourniture des plans par Copaya',
        'Respect des EPC/EPI (casque, gants, panneaux 50m, gyrophare, etc.)'
      ]},
      {id:'lim_ent',label:'Limites à la charge de l’entreprise',options:[
        'Procédures d’accès & plans fournis par Copaya',
        'Copaya réalise les élagages',
        'Copaya fournit l’outillage',
      ]},
      {id:'qual',label:'Qualité',options:[
        'Traçabilité par CR de zone + photos avant/après',
        'Aucune preuve',
        'CR oral uniquement',
      ]},
      {id:'cond',label:'Conditions d’interventions',options:[
        'Chantiers 6h30–17h ; hors horaires sur accord écrit ; DT‑DICT 15 jours',
        'Sans autorisation',
        'Travail de nuit imposé',
      ]},
      {id:'res',label:'Résultats attendus',options:[
        'Élagage conforme, continuité de service améliorée',
        'Faible visibilité du chantier',
        'Aucune contrainte',
      ]},
      {id:'rec',label:'Réception',options:[
        'Contrôle de chaque zone élaguée + CR/photos',
        'Réception tacite',
        'Auto‑réception titulaire',
      ]},
    ],
    answerKey:{
      objet:[0],
      ctx:[0],
      def:[0],
      lim_tit:[0,1],   // (1) & (2) bonnes; on retire EPC/EPI du set de bonnes
      lim_ent:[0],
      qual:[0],
      cond:[0],
      res:[0],
      rec:[0]
    }
  };
}

function makeBuilder_COPAYA_B(){
  return {
    steps:[
      {id:'objet',label:'Objet',options:[
        'Raccordement au réseau électrique d\'un village situé en Guyane Française', // seule bonne
        'Réalisation des fouilles et dalle de propreté',
        'Stabilisation du réseau électrique pour les habitants',
        'Respect des normes techniques HTA et DT/DICT'
      ]},
      {id:'ctx',label:'Contexte',options:[
        'Finaliser avant saison des pluies, limiter nuisances, qualité de service uniforme',
        'Projet sans échéance',
        'Intervention hors réseau électrique',
      ]},
      {id:'def',label:'Définition de la prestation',options:[
        '20 km HTA + 15 km fibre ; 60 boîtes HTA ; fourreaux ; fouille + dalle ; armoire ; raccordement/étiquetage',
        'Élagage de 405 km',
        'Nettoyage de voirie',
      ]},
      {id:'lim_tit',label:'Limites à la charge du titulaire',options:[
        'Transmission planning pour FDO',
        'Fourniture des chambres de tirage',
        'Communication via l’outil spécifié',
        'Fourniture des câbles HTA (fourni par Copaya)'
      ]},
      {id:'lim_ent',label:'Limites à la charge de l’entreprise',options:[
        'Copaya fournit câbles, boîtes de jonction, local de stockage',
        'Copaya réalise le chantier',
        'Copaya s’occupe des DT/DICT uniquement',
      ]},
      {id:'qual',label:'Qualité',options:[
        'Conformité DGTM + IC/OL selon décret n°2011‑12',
        'Pas de suivi',
        'Réduction du bruit non vérifiée',
      ]},
      {id:'cond',label:'Conditions d’interventions',options:[
        'Balisage cônes, panneaux 50 m, gyrophare ; visites de prévention',
        'Sans balisage',
        'Travaux nuit obligatoires',
      ]},
      {id:'res',label:'Résultats attendus',options:[
        'Raccordement conforme, impacts chaussée/bruit minimisés',
        'Durée indéfinie',
        'Livraison partielle',
      ]},
      {id:'rec',label:'Réception',options:[
        'Contrôles réglementaires + PV',
        'Auto‑réception',
        'Réception tacite',
      ]},
    ],
    answerKey:{
      objet:[0],
      ctx:[0],
      def:[0],
      lim_tit:[0,1,2],
      lim_ent:[0],
      qual:[0],
      cond:[0],
      res:[0],
      rec:[0]
    }
  };
}

function makeBuilder_TILESA_B(){
  return {
    steps:[
      {id:'objet',label:'Objet',options:[
        'Achat de véhicules électriques neufs pour renouveler la flotte',
        'Prestations d’élagage HTB',
        'Raccordement HTA',
      ]},
      {id:'ctx',label:'Contexte',options:[
        'Flotte 150 véhicules, 30% à remplacer ; électrification en Guyane',
        'Achat de camions thermiques',
        'Aucun objectif de décarbonation',
      ]},
      {id:'def',label:'Définition de la prestation',options:[
        'Fourniture VE homologués FR adaptés Guyane ; livraison multi‑sites ; mise en service ; formation ; docs ; SAV local',
        'Livraison sans mise en service',
        'Sans formation utilisateur',
      ]},
      {id:'lim_tit',label:'Limites à la charge du titulaire',options:[
        'Acheminement Guyane + immatriculation + équipements de base',
        'Installation & entretien des bornes de recharge',
        'Suivi administratif complet',
      ]},
      {id:'lim_ent',label:'Limites à la charge de l’entreprise',options:[
        'Mise à disposition des emplacements & assurance des véhicules',
        'Formation des utilisateurs',
        'Achat de carburant',
      ]},
      {id:'qual',label:'Qualité',options:[
        'Certificats de conformité, manuels, garanties ; SAV local/agréé',
        'Aucun document',
        'SAV uniquement hors Guyane',
      ]},
      {id:'cond',label:'Conditions d’interventions',options:[
        'Livraisons les jours d’ouverture des sites',
        'Livraison week‑end uniquement',
        'Sans rendez‑vous',
      ]},
      {id:'res',label:'Résultats attendus',options:[
        'VE opérationnels, confort/sécurité améliorés, réduction CO₂ et coûts',
        'Aucun indicateur',
        'Performance non mesurée',
      ]},
      {id:'rec',label:'Réception',options:[
        'Contrôle docs + vérifications fonctionnelles, PV de réception',
        'Réception tacite',
        'Sans essai',
      ]},
    ],
    answerKey:{
      objet:[0],
      ctx:[0],
      def:[0],
      lim_tit:[0],
      lim_ent:[0],
      qual:[0],
      cond:[0],
      res:[0],
      rec:[0]
    }
  };
}

// ---------- Navigation helpers
function openDomain(key){ go('dom_'+key); }
function goHome(){ go('home'); }
function goBack(){ history.back(); }

// ---------- Init
function go(id){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
go('home');

</script>
</body>
</html>
