<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Tilesia - Jeux p√©dagogiques (2 en 1)</title>
  <style>
    :root{
      --primary:#0a74da;
      --primary-dark:#095aba;
      --bg:#f4f7fb;
      --card:#ffffff;
      --text:#22324a;
      --warn:#b45309;
    }
    *{box-sizing:border-box}
    body{font-family:Arial,Helvetica,sans-serif;margin:0;background:var(--bg);color:var(--text);overflow-x:hidden;}
    .container{max-width:1100px;margin:0 auto;padding:clamp(16px,4vw,32px);}
    .screen{display:none;animation:fadeIn .4s ease-in;}
    .active{display:block;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}
    h1,h2,h3{margin:0 0 .6rem}
    .muted{color:#64748b}
    .btn{padding:.7rem 1.1rem;background:#0a74da;color:#fff;border:none;border-radius:10px;cursor:pointer;font-weight:600;box-shadow:0 2px 6px rgba(10,116,218,.25);}
    .btn:hover{background:#095aba;}
    .btn.secondary{background:#e9eef5;color:#18324a;box-shadow:none;}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem;}
    .card{background:#fff;border-radius:14px;box-shadow:0 10px 26px rgba(0,0,0,.08);padding:1rem;}
    .card h3{margin-bottom:.4rem}
    .hero{width:100%;max-width:980px;border-radius:16px;box-shadow:0 10px 26px rgba(0,0,0,.08);display:block;margin:0 auto 12px;object-fit:contain;max-height:60vh;}
    .map{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem;margin-top:1rem;}
    .location{background:#fff;padding:1rem;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.06);text-align:center;cursor:pointer;transition:transform .15s ease,box-shadow .2s ease;}
    .location:hover{transform:translateY(-2px);box-shadow:0 10px 22px rgba(0,0,0,.08);}
    .location img{width:48px;height:48px;margin-bottom:.5rem;}
    .modal{position:fixed;top:5%;left:50%;transform:translateX(-50%);background:#fff;padding:clamp(16px,3vw,24px);border-radius:14px;box-shadow:0 18px 50px rgba(0,0,0,.25);display:none;z-index:1000;width:min(92vw,820px);max-height:90vh;overflow:auto;}
    .modal.active{display:block;}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:999;}
    .overlay.active{display:block;}
    .modal img{max-width:100%;max-height:40vh;object-fit:contain;display:block;margin:.5rem 0;}
    .modal-actions{position:sticky;bottom:0;background:#fff;padding-top:.5rem;margin-top:.5rem;}
    .info-log{margin-top:.75rem;font-size:.95rem;color:#0f7a31;}
    .summary{background:#fff;padding:1rem;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.06);}
    .score{margin-top:12px;background:#f0f9ff;border:1px solid #bae6fd;color:#0c4a6e;padding:.75rem 1rem;border-radius:12px;font-weight:600;display:none;}
    .badge{display:inline-block;padding:.35rem .6rem;border-radius:999px;font-size:.9rem;font-weight:700;margin-left:.5rem;}
    .badge.intermediaire{background:#fff7ed;color:#b45309;border:1px solid #fed7aa;}
    .badge.avance{background:#eff6ff;color:#1d4ed8;border:1px solid #93c5fd;}
    .badge.expert{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0;}
    .errors{margin-top:10px;background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:.75rem 1rem;display:none;}
    .errors h4{margin:.2rem 0 .4rem;}
    .errors ul{margin:.2rem 0 0 1rem;}
    .toggle{margin-top:8px;background:#e9eef5;color:#22324a;}
    .progress{height:10px;background:#e9eef5;border-radius:999px;overflow:hidden;margin:10px 0 18px;}
    .progress>span{display:block;height:100%;background:#0a74da;width:0%;transition:width .25s ease;}
    .tabs{display:flex;flex-wrap:wrap;gap:.5rem;margin-bottom:.8rem;}
    .tab-btn{padding:.45rem .7rem;border-radius:10px;border:1px solid #d8e0ea;background:#fff;cursor:pointer;font-size:.92rem;color:#213347;}
    .tab-btn.active{background:#0a74da;color:#fff;border-color:#0a74da;}
    .tab-panel{display:none;background:#fff;padding:1rem;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.06);}
    .tab-panel.active{display:block;}
    .option-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:.75rem;margin-top:.75rem;}
    .option{border:1px solid #e6e6e6;border-radius:10px;padding:.75rem;background:#fafafa;}
    .option label{display:block;cursor:pointer;line-height:1.35;}
    ul{margin:.4rem 0 0 1rem}
    .footer-space{height:12px;}
    .scenario{background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;padding:1rem;margin-top:12px;}
    .notice-panel{background:#f8fafc;border:1px solid #d1d5db;border-radius:12px;padding:1rem;margin-top:1rem;display:none;}
  </style>
</head>
<body>

<!-- Audio (optionnel) -->
<audio autoplay loop>
  <source src="https://cdn.pixabay.com/download/audio/2022/03/29/audio_d2d7f6a30e.mp3" type="audio/mpeg">
  Votre navigateur ne supporte pas l'audio.
</audio>
<audio id="clickSound">
  <source src="https://cdn.pixabay.com/download/audio/2022/03/23/audio_32901fa291.mp3" type="audio/mpeg">
  Votre navigateur ne supporte pas l'audio.
</audio>

<!-- ACCUEIL -->
<div id="home" class="screen active">
  <div class="container">
    <img class="hero" src="images/accueil_salle_formation.png" alt="Salle de formation moderne en Guyane avec formateurs et participants">
    <h2>Choisissez votre jeu</h2>
    <div class="grid">
      <div class="card">
        <h3>Jeu n¬∞1 ‚Äî CCTP Tilesa</h3>
        <p class="muted">Explorez les services du groupe TILESA avec Alex, puis r√©digez le cahier des charges via un assistant.</p>
        <button class="btn" onclick="startGame(1)">Lancer le jeu n¬∞1</button>
      </div>
      <div class="card">
        <h3>Jeu n¬∞2 ‚Äî CCTP Lesati</h3>
        <p class="muted">Suivez L√©a, charg√©e d'affaires, qui doit r√©diger un cahier des charges en int√©gralit√© pour l'entreprise LESATI.</p>
        <button class="btn" onclick="startGame(2)">Lancer le jeu n¬∞2</button>
      </div>
    </div>
  </div>
</div>

<!-- Jeu 1 : intro -->
<div id="game1_intro" class="screen">
  <div class="container">
    <img class="hero" src="images/tilesia_accueil_alex.png" alt="Accueil du jeu 1 - Alex TILESA">
    <div style="display:flex; gap:.5rem; margin-top:.5rem;">
      <button class="btn" onclick="goTo('game1')">D√©marrer la mission</button>
      <button class="btn secondary" onclick="goTo('home')">‚¨Ö Retour √† l'accueil</button>
    </div>
  </div>
</div>

<!-- Jeu 1 : carte -->
<div id="game1" class="screen">
  <div class="container">
    <h2>Jeu n¬∞1 ‚Äî Explorer les services</h2>
    <div class="map">
      <div class="location" onclick="playClick(); openModal('Direction')">
        <img src="https://cdn-icons-png.flaticon.com/512/219/219986.png" alt="Direction">Direction
      </div>
      <div class="location" onclick="playClick(); openModal('Technique')">
        <img src="https://cdn-icons-png.flaticon.com/512/2621/2621140.png" alt="Technique">Service Technique
      </div>
      <div class="location" onclick="playClick(); openModal('Salaries')">
        <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="Salari√©s">Salari√©s
      </div>
      <div class="location" onclick="playClick(); openModal('Juridique')">
        <img src="https://cdn-icons-png.flaticon.com/512/2569/2569069.png" alt="Juridique">Juridique
      </div>
    </div>
    <div class="footer-space"></div>
    <button class="btn" onclick="validateCollection(1)">R√©diger le cahier des charges</button>
    <button class="btn secondary" onclick="goTo('home')">‚¨Ö Retour accueil</button>
    <div class="info-log" id="infoLog1"></div>
  </div>
</div>

<!-- Jeu 1 : Assistant QCM -->
<div id="builder1" class="screen">
  <div class="container">
    <h2>Jeu n¬∞1 ‚Äî Assistant (QCM)</h2>
    <div class="muted">S√©lectionnez les √©l√©ments pertinents √† chaque √©tape.</div>
    <div class="progress"><span id="builderProgress1"></span></div>
    <div class="tabs" id="builderTabs1"></div>
    <div id="builderPanels1"></div>
    <div class="warn" id="builderWarn1">Veuillez s√©lectionner au moins un √©l√©ment dans cet onglet pour continuer.</div>
    <div class="step-actions">
      <button class="btn secondary" id="prevStep1">‚óÄ Pr√©c√©dent</button>
      <div>
        <button class="btn secondary" onclick="goTo('game1')">Sauvegarder & Revenir √† la carte</button>
        <button class="btn" id="nextStep1">Suivant ‚ñ∂</button>
        <button class="btn" id="finishBuilder1" style="display:none">G√©n√©rer le r√©sum√©</button>
      </div>
    </div>
  </div>
</div>

<!-- Jeu 1 : R√©sum√© + Score -->
<div id="summary1" class="screen">
  <div class="container">
    <h2>R√©sum√© ‚Äî Jeu n¬∞1</h2>
    <div class="summary" id="summaryContent1"></div>
    <div id="scoreContent1" class="score"></div>
    <button class="btn toggle" id="toggleErrors1" style="display:none">Voir mes erreurs</button>
    <div id="errorsPanel1" class="errors"></div>
    <div style="display:flex; gap:.5rem; margin-top:12px;">
      <button class="btn secondary" onclick="goTo('builder1')">Modifier</button>
      <button class="btn" onclick="goTo('home')">Retour √† l'accueil</button>
    </div>
  </div>
</div>

<!-- Jeu 2 : intro -->
<div id="game2_intro" class="screen">
  <div class="container">
    <img class="hero" src="images/lea_centrale_LESATI.png" alt="Accueil du jeu 2 - L√©a devant la centrale">
    <h2>Jeu n¬∞2 ‚Äî CCTP Lesati</h2>
    <p>L√©a, charg√©e d'affaires du service production, est volontaire pour r√©aliser l'expression du besoin.</p>
    <div style="display:flex; gap:.5rem; margin-top:.5rem;">
      <button class="btn" onclick="goTo('game2')">D√©marrer la mission</button>
      <button class="btn secondary" onclick="goTo('home')">‚¨Ö Retour √† l'accueil</button>
    </div>
  </div>
</div>

<!-- Jeu 2 : carte -->
<div id="game2" class="screen">
  <div class="container">
    <h2>Jeu n¬∞2 ‚Äî Suivez L√©a (LESATI)</h2>
    <div class="map">
      <div class="location" onclick="playClick(); openModal('Direction',2)">
        <img src="https://cdn-icons-png.flaticon.com/512/219/219986.png" alt="Direction">Direction (LESATI)
      </div>
      <div class="location" onclick="playClick(); openModal('Service production',2)">
        <img src="https://cdn-icons-png.flaticon.com/512/1995/1995525.png" alt="Production">Service production (LESATI)
      </div>
      <div class="location" onclick="playClick(); openModal('Salaries',2)">
        <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="Salari√©s">Salari√©s (LESATI)
      </div>
      <div class="location" onclick="playClick(); openModal('Juridique',2)">
        <img src="https://cdn-icons-png.flaticon.com/512/2569/2569069.png" alt="Juridique">Juridique (LESATI)
      </div>
    </div>
    <div class="footer-space"></div>
    <button class="btn secondary" onclick="goTo('home')">‚¨Ö Retour accueil</button>
    <div class="info-log" id="infoLog2"></div>

    <!-- Bouton qui appara√Æt apr√®s collecte compl√®te -->
    <button id="btnCCTP2" class="btn" style="display:none; margin-top:1rem;" onclick="document.getElementById('notice2').style.display='block'">
      R√©diger le cahier des charges
    </button>
    <div id="notice2" class="notice-panel">
      <p><strong>Vous disposez de toutes les informations pour √©crire un cahier des charges en 45 minutes.</strong></p>
    </div>
  </div>
</div>

<!-- (Optionnel) √âcran fin de mission J2 -->
<div id="summary2" class="screen">
  <div class="container">
    <h2>Fin de mission ‚Äî Jeu n¬∞2</h2>
    <div class="summary">
      <p><strong>Bravo !</strong> Vous avez collect√© toutes les informations aupr√®s des 4 services.</p>
      <div class="scenario">
        <h4>üéØ Sc√©nario LESATI</h4>
        <p><strong>Contexte :</strong> L‚Äôentreprise <strong>LESATI</strong> assure les missions de production, distribution et commercialisation de l‚Äô√©nergie pour la commune de <strong>Saint Georges</strong>.</p>
        <p>Certains groupes ont atteint leurs limites techniques (d√©passement du nombre d‚Äôheures limites pr√©vues par le constructeur) et devront √™tre r√©vis√©s. √Ä ce stade, une r√©vision des groupes co√ªte tr√®s cher, potentiellement plus on√©reuse que l‚Äôachat de mat√©riels neufs.</p>
        <p><strong>Objet :</strong> Achat de <strong>3 groupes √©lectrog√®nes neufs</strong> comprenant la livraison √† Saint Georges.</p>
        <p><strong>Condition :</strong> Utilisation continue du groupe sans restriction dans un milieu humide et avec temp√©rature √©lev√©e.</p>
      </div>
    </div>
    <div style="display:flex; gap:.5rem; margin-top:12px;">
      <button class="btn" onclick="goTo('home')">Retour √† l'accueil</button>
    </div>
  </div>
</div>

<!-- Modale partag√©e -->
<div class="overlay" id="overlay" onclick="closeModal()"></div>
<div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <h3 id="modalTitle"></h3>
  <p id="modalContent"></p>
  <img id="modalImage" src="" alt="Illustration du service">
  <div class="modal-actions" style="display:flex; gap:.5rem; margin-top:.8rem;">
    <button class="btn" onclick="collectInfo()">Collecter l'information</button>
    <button class="btn secondary" onclick="closeModal()">Retour</button>
  </div>
</div>

<script>
  // Navigation de base
  const screens=document.querySelectorAll('.screen');
  const clickSound=document.getElementById('clickSound');
  function playClick(){try{clickSound.currentTime=0;clickSound.play();}catch(e){}}
  function goTo(id){screens.forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');}
  function startGame(n){ goTo(n===1?'game1_intro':'game2_intro'); }

  // Donn√©es Jeu 1 (TILESA)
  const modalData1={
    'Direction':{ text:"Le pr√©sident vous accueille : ¬´ La sant√© et la s√©curit√© sont mes priorit√©s pour garantir le bon fonctionnement de l‚Äôentreprise et le bien-√™tre des salari√©s. ¬ª", image:"images/tilesia_direction.png" },
    'Technique':{ text:`Intervention pendant les heures ouvrables, sauf cas exceptionnel. Pour les locaux √©lectriques, le titulaire sera accompagn√© d'un employ√© disposant des habilitations requises.
Les espaces concern√©s sont les suivants : bureaux, couloirs, escaliers, ascenseur, sanitaires, vestiaires, r√©fectoires.
Le titulaire remplira un avis de passage. Le rapport semestriel sera r√©dig√© par le service technique.

Les consommables √† la charge du prestataire sont les suivants :
- Le papier toilette
- Le papier essuie-mains
- Le savon liquide √† mains
- Les sacs poubelles
- D√©sodorisants.`, image:"images/tilesia_technique.png" },
    'Salaries':{ text:"Il y a 300 salari√©s dans le b√¢timent r√©partis sur les 4 √©tages. Le b√¢timent dispose d‚Äôune superficie de 4100 m¬≤. Vous observez une ambiance de coop√©ration et de r√©unions dans les locaux.", image:"images/tilesia_salaries.png" },
    'Juridique':{ text:"La juriste rappelle les prescriptions du D√©cret 92-158 du 20 f√©vrier 1992 reprises dans le Code du travail (articles R.237-1 et R.237-28), applicables aux travaux r√©alis√©s dans l‚Äô√©tablissement par une entreprise ext√©rieure.", image:"images/tilesia_juridique.png" }
  };

  // Donn√©es Jeu 2 (LESATI) ‚Äî textes mis √† jour
  const modalData2={
    'Direction':{
      text:'La directrice s\\'explique: "L\\'entreprise LESATI assure les missions de production, distribution et commercialisation de l\\'√©nergie dans la commune de Saint Georges. La mission de service public et la proximit√© client sont nos priorit√©s".',
      image:"images/direction_directrice_LESATI.png"
    },
    'Service production':{
      text:"Certains de ces groupes ont atteint leurs limites techniques (d√©passement du nombre d‚Äôheures limites pr√©vues par le constructeur) et devront √™tre r√©vis√©s. A ce stade une r√©vision des groupes co√ªte tr√®s ch√®re, elle serait m√™me plus on√©reuse que l‚Äôachat de mat√©riels neufs.",
      image:"images/production_groupes_LESATI.png"
    },
    'Salaries':{
      text:"Photo des 30 salari√©s de l'entreprise devant l'entr√©e du b√¢timent. L'entreprise est en forte croissance et noue de plus en plus de partenariats strat√©giques.",
      image:"images/salaries_30_LESATI.png"
    },
    'Juridique':{
      text:"La juriste rappelle qu'il est indispensable d'ajouter une garantie technique lors de l'achat des groupes 3 √©lectrog√®nes avec la livraison √† Saint Georges. Les groupes seront utilis√©es en continue dans un milieu humide et avec temp√©rature √©lev√©e..",
      image:"images/juridique_garantie_LESATI.png"
    }
  };

  let currentService=''; let currentGame=1;
  let collected1=new Set(); let collected2=new Set();

  function openModal(service, game=1){
    currentGame = game; currentService = service;
    const data = game===2 ? modalData2 : modalData1;
    const item = data[service];
    document.getElementById('modalTitle').innerText=service;
    document.getElementById('modalContent').innerText=item.text;
    document.getElementById('modalImage').src=item.image;
    document.getElementById('overlay').classList.add('active');
    document.getElementById('modal').classList.add('active');
  }
  function closeModal(){
    document.getElementById('overlay').classList.remove('active');
    document.getElementById('modal').classList.remove('active');
  }
  function collectInfo(){
    if(currentGame===2){
      collected2.add(currentService);
      document.getElementById('infoLog2').innerText=`Informations collect√©es (LESATI) : ${Array.from(collected2).join(', ')}`;
      if(collected2.size>=4){
        const btn = document.getElementById('btnCCTP2');
        if(btn) btn.style.display='inline-block';
      }
    }else{
      collected1.add(currentService);
      document.getElementById('infoLog1').innerText=`Informations collect√©es : ${Array.from(collected1).join(', ')}`;
    }
    closeModal();
  }

  // Assistant QCM Jeu 1
  const steps1=[
    { id:"objet", label:"Objet", help:"Il sert √† d√©finir l‚Äôobjet du cahier des charges. Il ne doit pas comporter d‚Äôautre mention que cette d√©finition.",
      options:[ "Prestation de nettoyage int√©rieur des locaux du site TILESIA", "P√©rim√®tre: bureaux, circulation, escaliers, ascenseur, sanitaires, vestiaires, r√©fectoires", "Objectif: propret√©, hygi√®ne et confort des utilisateurs" ] },
    { id:"contexte", label:"Contexte", help:"Situer le contexte de l‚Äôaffaire (√©v√®nements historiques, politique d‚Äôentreprise).",
      options:[ "B√¢timent R+3, 4100 m¬≤, ~300 salari√©s", "La politique sant√© s√©curit√© est un enjeu majeur pour l‚Äôentreprise", "Locaux √©lectriques accompagn√©s par personnel habilit√©" ] },
    { id:"definition", label:"D√©finition de la prestation", help:"D√©finir la prestation ainsi que la volum√©trie (tous les √©l√©ments quantitatifs et qualitatifs).",
      options:[ "Nettoyage des sols (aspiration, balayage humide, lavage)", "D√©poussi√©rage des surfaces et mobiliers", "D√©sinfection des points de contact", "Sanitaires: nettoyage, d√©sinfection et r√©assort" ] },
    { id:"limites_titulaire", label:"Limites √† la charge du titulaire", help:"Mentionner clairement les limites de la prestation du Titulaire (outillages, produits).",
      options:[ "Approvisionnement consommables: papier toilette, essuie-mains, savon mains, sacs poubelles, d√©sodorisants", "Fourniture mat√©riels et produits de nettoyage", "Avis de passage apr√®s intervention" ] },
    { id:"limites_entreprise", label:"Limites √† la charge de l‚Äôentreprise", help:"Prestations et mat√©riels √† charge d‚ÄôEDF.",
      options:[ "Mise √† disposition des locaux d‚Äôentretien et points d‚Äôeau", "Accompagnement zones √©lectriques par agents habilit√©s", "Acc√®s / badges / consignes de s√©curit√©" ] },
    { id:"qualite", label:"Qualit√©", help:"Certification, homologation des produits.",
      options:[ "Plan qualit√© et fiches techniques produits", "Tra√ßabilit√© des interventions (registre / app)", "Indicateurs de propret√© et plan d‚Äôam√©lioration" ] },
    { id:"conditions", label:"Conditions d‚Äôinterventions", help:"Pr√©cautions, d√©lais horaires, conditions d‚Äôacc√®s, s√©curit√©.",
      options:[ "Respect s√©curit√© / environnement (tri, stockage produits)", "Signalisation des zones en intervention", "Interventions en heures ouvrables", "D√©cret 92-158 & C. travail (R.237-1 √† R.237-28), normes d‚Äôhygi√®ne" ] },
    { id:"resultats", label:"R√©sultats attendus", help:"Quantifiables, mesurables et contr√¥lables (seuil, niveau, temp√©rature).",
      options:[ "Sols propres sans traces visibles", "Sanitaires propres, d√©sinfect√©s et r√©approvisionn√©s", "Mobilier d√©poussi√©r√©, points de contact d√©sinfect√©s" ] },
    { id:"reception_ref", label:"R√©ception", help:"D√©crire les √©l√©ments qui permettront de r√©aliser la r√©ception technique (livrables).",
      options:[ "Rapport semestriel r√©dig√© par le service technique", "Proc√®s-verbal sign√© et dat√© par les deux parties", "R√©f√©rences: D√©cret 92-158 & C. travail (R.237-1 √† R.237-28), normes d‚Äôhygi√®ne" ] }
  ];
  const answerKey1={ objet:[0], contexte:[0,1], definition:[0,1,2,3], limites_titulaire:[0,1], limites_entreprise:[0,1,2], qualite:[0,2], conditions:[0,1,2,3], resultats:[0,1,2], reception_ref:[0,1] };
  let builderSelections1={}, builderIndex1=0;

  function validateCollection(game){
    const set = game===1 ? collected1 : collected2;
    if(set.size<4){ alert("Vous devez visiter tous les services avant de continuer."); return; }
    if(game===1){ startBuilder1(true); }
  }

  function startBuilder1(reset=false){
    const tabs=document.getElementById('builderTabs1');
    const panels=document.getElementById('builderPanels1');
    if(reset){builderSelections1={};tabs.innerHTML="";panels.innerHTML="";tabs.dataset.ready="";}
    if(!tabs.dataset.ready){
      steps1.forEach((s,i)=>{
        const b=document.createElement('button'); b.className='tab-btn'+(i===0?' active':''); b.textContent=`${i+1}. ${s.label}`; b.onclick=()=>goStep1(i); tabs.appendChild(b);
        const p=document.createElement('div'); p.className='tab-panel'+(i===0?' active':''); p.id=`panel1-${s.id}`;
        p.innerHTML=`
          <h3>${i+1}. ${s.label}</h3>
          <div class="muted" style="margin:.25rem 0 .5rem"><details><summary>Aide (facultatif)</summary><p>${s.help||""}</p></details></div>
          <div class="option-grid">
            ${s.options.map((opt,idx)=>`
              <div class="option"><label><input type="checkbox" data-step="${s.id}" data-opt="${idx}"> ${opt}</label></div>
            `).join('')}
          </div>`;
        panels.appendChild(p);
      });
      panels.addEventListener('change',(e)=>{
        const box=e.target; if(box && box.type==='checkbox'){
          const stepId=box.dataset.step; const idx=Number(box.dataset.opt);
          if(!builderSelections1[stepId]) builderSelections1[stepId]=new Set();
          if(box.checked) builderSelections1[stepId].add(idx); else builderSelections1[stepId].delete(idx);
        }
      });
      document.getElementById('prevStep1').onclick=()=>goStep1(builderIndex1-1);
      document.getElementById('nextStep1').onclick=()=>{
        if(!hasAtLeastOne1(steps1[builderIndex1].id)){document.getElementById('builderWarn1').style.display='block';return;}
        document.getElementById('builderWarn1').style.display='none'; goStep1(builderIndex1+1);
      };
      document.getElementById('finishBuilder1').onclick=()=>{
        if(!hasAtLeastOne1(steps1[builderIndex1].id)){document.getElementById('builderWarn1').style.display='block';return;}
        document.getElementById('builderWarn1').style.display='none'; finishBuilder1();
      };
      tabs.dataset.ready="1";
    }
    goStep1(0); goTo('builder1');
  }
  function hasAtLeastOne1(stepId){const set=builderSelections1[stepId];return set && set.size>0;}
  function goStep1(i){
    if(i<0||i>=steps1.length) return; builderIndex1=i;
    [...document.querySelectorAll('#builderTabs1 .tab-btn')].forEach((b,k)=>b.classList.toggle('active',k===i));
    [...document.querySelectorAll('#builderPanels1 .tab-panel')].forEach(p=>p.classList.remove('active'));
    document.getElementById(`panel1-${steps1[i].id}`).classList.add('active');
    const pct=Math.round((i)/(steps1.length-1)*100); document.getElementById('builderProgress1').style.width=pct+'%';
    document.getElementById('prevStep1').disabled=(i===0);
    document.getElementById('nextStep1').style.display=(i===steps1.length-1)?'none':'inline-block';
    document.getElementById('finishBuilder1').style.display=(i===steps1.length-1)?'inline-block':'none';
  }
  function levelBadge(pct){ if(pct<=50) return {label:"Interm√©diaire",cls:"intermediaire"}; if(pct<=80) return {label:"Avanc√©",cls:"avance"}; return {label:"Expert",cls:"expert"}; }
  function finishBuilder1(){
    let html=''; steps1.forEach((s,i)=>{
      const picked=[...(builderSelections1[s.id]||[])].sort((a,b)=>a-b);
      if(picked.length){ html+=`<h4>${i+1}. ${s.label}</h4><ul>`; picked.forEach(idx=>html+=`<li>${s.options[idx]}</li>`); html+='</ul>'; }
    });
    if(!html) html="<p>Aucun √©l√©ment s√©lectionn√©. Revenez dans l‚Äôassistant pour choisir vos options.</p>";
    document.getElementById('summaryContent1').innerHTML=html;

    // score & erreurs
    let totalCorrect=0, selectedCorrect=0; const errors=[];
    for(const step of steps1){
      const key=answerKey1[step.id]||[]; totalCorrect+=key.length;
      const picked=builderSelections1[step.id]?Array.from(builderSelections1[step.id]):[];
      const ok=picked.filter(i=>key.includes(i));
      const wrong=picked.filter(i=>!key.includes(i));
      const missed=key.filter(i=>!picked.includes(i));
      selectedCorrect+=ok.length;
      if(wrong.length||missed.length){ errors.push({label:step.label, wrong:wrong.map(i=>step.options[i]), missed:missed.map(i=>step.options[i])}); }
    }
    const pct=totalCorrect?Math.round((selectedCorrect/totalCorrect)*100):0; const level=levelBadge(pct);
    const scoreEl=document.getElementById('scoreContent1'); scoreEl.style.display='block';
    scoreEl.innerHTML=`Score : ${selectedCorrect} sur ${totalCorrect} (${pct}%) <span class="badge ${level.cls}">${level.label}</span>`;

    const toggleBtn=document.getElementById('toggleErrors1'); const panel=document.getElementById('errorsPanel1');
    if(errors.length){
      toggleBtn.style.display='inline-block'; panel.style.display='none';
      panel.innerHTML=errors.map(e=>{
        let block=`<div style="margin:.4rem 0">`;
        block+=`<h4>${e.label}</h4>`;
        if(e.wrong.length) block+=`<div style="color:#b91c1c"><strong>Choix non attendus :</strong><ul>${e.wrong.map(t=>`<li>${t}</li>`).join('')}</ul></div>`;
        if(e.missed.length) block+=`<div style="color:#92400e"><strong>√Ä ne pas oublier :</strong><ul>${e.missed.map(t=>`<li>${t}</li>`).join('')}</ul></div>`;
        block+=`</div>`; return block;
      }).join('');
      toggleBtn.onclick=()=>{ panel.style.display=(panel.style.display==='none')?'block':'none'; toggleBtn.textContent=panel.style.display==='none'?'Voir mes erreurs':'Masquer les erreurs'; };
    }else{ toggleBtn.style.display='none'; panel.style.display='none'; panel.innerHTML=''; }

    goTo('summary1');
  }
</script>

</body>
</html>
