<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Jeux CCTP ‚Äî LESATI / COPAYA / TILESA</title>
<style>
:root{--primary:#0a66ff;--bg:#f6f8fb;--card:#fff;--text:#1f2937;--muted:#66758a;--ring:#dbeafe;}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
.container{max-width:1200px;margin:0 auto;padding:24px}
h1,h2,h3{margin:.25rem 0 .6rem} h1{font-size:clamp(22px,3.4vw,36px)} h2{font-size:clamp(18px,2.6vw,26px)}
p{margin:.35rem 0}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
.card{background:var(--card);border-radius:14px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
.btn{background:var(--primary);color:#fff;border:none;border-radius:10px;padding:.65rem 1rem;font-weight:700;cursor:pointer}
.btn.secondary{background:#e9eef7;color:#1f2937}
.btn[disabled]{opacity:.6;cursor:not-allowed}
.kit{display:none}.active{display:block}
.badge{display:inline-block;background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe;border-radius:999px;padding:.15rem .5rem;font-size:.78rem;font-weight:700}
.row{display:flex;align-items:center;gap:.5rem;flex-wrap:wrap}
.service{display:flex;align-items:center;gap:12px;padding:12px;border:1px solid #e5e7eb;border-radius:12px;background:var(--card);cursor:pointer}
.service:focus,.service:hover{outline:2px solid var(--ring)}
.service.done{border-color:#93c5fd;background:#f0f7ff}
.notice{background:#fff7ed;border:1px solid #fed7aa;border-radius:12px;padding:10px;margin-top:10px}
/* Assistant */
.tabs{display:flex;flex-wrap:wrap;gap:8px;margin:.6rem 0 1rem}
.tab{border:1px solid #dbe3f0;background:#fff;border-radius:12px;padding:.45rem .7rem;cursor:pointer}
.tab.active{background:var(--primary);border-color:var(--primary);color:#fff}
.panel{display:none;background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:14px}
.panel.active{display:block}
.help{background:#f8fafc;border:1px dashed #cbd5e1;border-radius:10px;padding:.6rem;margin:.5rem 0}
.option{border:1px solid #e5e7eb;border-radius:10px;padding:.55rem;background:#fbfdff}
.option + .option{margin-top:.45rem}
.progress{height:10px;background:#e9eef5;border-radius:999px;overflow:hidden;margin:.6rem 0 1rem}
.progress>span{display:block;height:100%;background:var(--primary);width:0%}
.warn{display:none;color:#b45309;background:#fff7ed;border:1px solid #fde68a;border-radius:10px;padding:.5rem;margin-top:.5rem}
.summary,.errors{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin-top:10px}
.score{background:#f0f9ff;border:1px solid #bae6fd;border-radius:12px;padding:.6rem;margin-top:10px;font-weight:700}
.small{color:var(--muted);font-size:.92rem}
.back{display:inline-flex;align-items:center;gap:.4rem}
.footer{height:16px}
</style>
</head>
<body>

<div id="home" class="kit active">
  <div class="container">
    <h1>Choisissez votre domaine</h1>
    <div class="grid">
      <div class="card">
        <h2>Domaine Production <span class="badge">LESATI</span></h2>
        <p class="small">Jeux de l'entreprise LESATI (Thermique, Hydraulique, Smart Grids).</p>
        <button class="btn" onclick="openDomain('LESATI')">Acc√©der au domaine</button>
      </div>
      <div class="card">
        <h2>Domaine R√©seau <span class="badge">COPAYA</span></h2>
        <p class="small">Jeux de l'entreprise COPAYA (R√©seaux &amp; Exploitation).</p>
        <button class="btn" onclick="openDomain('COPAYA')">Acc√©der au domaine</button>
      </div>
      <div class="card">
        <h2>Domaine Tertiaire <span class="badge">TILESA</span></h2>
        <p class="small">Jeux de l'entreprise TILESA (Tertiaire &amp; Telecom).</p>
        <button class="btn" onclick="openDomain('TILESA')">Acc√©der au domaine</button>
      </div>
    </div>
  </div>
</div>

<div id="domain" class="kit">
  <div class="container">
    <div class="row">
      <button class="btn secondary back" onclick="go('home')">‚¨Ö Retour</button>
      <h1 id="domainTitle"></h1>
    </div>
    <div class="grid" id="games"></div>
  </div>
</div>

<!-- Carte (services) -->
<div id="map" class="kit">
  <div class="container">
    <div class="row">
      <button class="btn secondary back" onclick="go('domain')">‚¨Ö Retour</button>
      <h1 id="mapTitle"></h1>
    </div>
    <p class="small" id="introText"></p>
    <div id="services" class="grid"></div>
    <div class="footer"></div>
    <button id="btnWrite" class="btn" style="display:none" onclick="startAssistant()">R√©diger le cahier des charges</button>
  </div>
</div>

<!-- Assistant QCM -->
<div id="assistant" class="kit">
  <div class="container">
    <div class="row">
      <button class="btn secondary back" onclick="backToMap()">‚¨Ö Retour carte</button>
      <h1 id="asstTitle"></h1>
    </div>
    <p class="small">S√©lectionnez les √©l√©ments pertinents √† chaque √©tape. Les aides sont facultatives.</p>
    <div class="progress"><span id="prog"></span></div>
    <div id="tabs" class="tabs"></div>
    <div id="panels"></div>
    <div id="warn" class="warn">Veuillez s√©lectionner au moins un √©l√©ment dans cet onglet pour continuer.</div>
    <div class="row" style="justify-content:space-between;margin-top:10px">
      <button id="prevBtn" class="btn secondary">‚óÄ Pr√©c√©dent</button>
      <div>
        <button class="btn secondary" onclick="backToMap()">üíæ Sauvegarder &amp; retour carte</button>
        <button id="nextBtn" class="btn">Suivant ‚ñ∂</button>
        <button id="finishBtn" class="btn" style="display:none">G√©n√©rer le r√©sum√©</button>
      </div>
    </div>
  </div>
</div>

<!-- R√©sum√© -->
<div id="summary" class="kit">
  <div class="container">
    <div class="row">
      <button class="btn secondary back" onclick="go('assistant')">‚¨Ö Revenir √† l‚Äôassistant</button>
      <h1 id="sumTitle">R√©sum√©</h1>
    </div>
    <div class="summary" id="sumContent"></div>
    <div id="score" class="score"></div>
    <button id="toggleErr" class="btn secondary" style="display:none">Voir mes erreurs</button>
    <div id="errPanel" class="errors" style="display:none"></div>
    <div class="row" style="margin-top:10px">
      <button class="btn" onclick="go('home')">üèÅ Retour √† l'accueil</button>
    </div>
  </div>
</div>

<script>
const S = { domain:null, game:null, visited:new Set(), selections:{}, dataset:{} };
const DOM = id => document.getElementById(id);
const go = id => { document.querySelectorAll('.kit').forEach(e=>e.classList.remove('active')); DOM(id).classList.add('active'); };

// Jeux & services
const GAMES = {
  LESATI: { title:'LESATI ‚Äî Production', items:[
    { id:'LESATI_A', title:'Jeu A (Centrale Thermique ‚Äî L√©a)', intro:"L√©a, charg√©e d‚Äôaffaires du service production, est volontaire pour r√©aliser l‚Äôexpression du besoin. Il s'agit de l'achat de 3 nouveaux groupes √©lectrog√®nes.", services:['Direction','Service production','Salari√©s','Juridique']},
    { id:'LESATI_B', title:'Jeu B (Centrale Hydraulique ‚Äî L√©on)', intro:'Centrale hydraulique : explorez les services puis r√©digez le cahier des charges.', services:['Direction','Manager','Maintenance','Juridique','S√©curit√©']},
  ]},
  COPAYA: { title:'COPAYA ‚Äî R√©seau', items:[
    { id:'COPAYA_A', title:'Jeu A (√âlagage ‚Äî Sylvie)', intro:'√âlagage : explorez les services puis r√©digez le cahier des charges.', services:['Direction','Clients','Maintenance','Environnement','S√©curit√©']},
    { id:'COPAYA_B', title:'Jeu B (Raccordement HTA ‚Äî Carl)', intro:'Raccordement HTA : explorez les services puis r√©digez le cahier des charges.', services:['La Directrice','√âquipe','Manager','Habitants','Juriste','Pr√©vention']},
  ]},
  TILESA: { title:'TILESA ‚Äî Tertiaire', items:[
    { id:'TILESA_A', title:'Jeu A (Nettoyage ‚Äî Alex)', intro:'Nettoyage des sites : explorez les services puis r√©digez le cahier des charges.', services:['Direction','Technique','Salari√©s','Juridique']},
    { id:'TILESA_B', title:'Jeu B (V√©hicules √©lectriques ‚Äî Manon)', intro:'V√©hicules √âlectriques : explorez les services puis r√©digez le cahier des charges.', services:['Direction','Manager','Services','Technique','Juriste','Responsable Environnement']},
  ]},
};

// Aides (affich√©es en ‚ÄúAide (facultatif)‚Äù)
const HELP = {
  objet:"D√©finir l‚Äôobjet du CCTP en une phrase claire. √âvitez les √©l√©ments hors p√©rim√®tre.",
  contexte:"Situer l‚Äôenvironnement du projet et ses enjeux.",
  def:"D√©crire pr√©cis√©ment ce qui est inclus (volum√©trie, nature, livrables).",
  limites_titulaire:"Ce que le titulaire doit prendre en charge (hors de la charge du ma√Ætre d‚Äôouvrage).",
  limites_entreprise:"Ce que l‚Äôentreprise fournit directement.",
  qualite:"Exigences qualit√© et conformit√©.",
  conditions:"Contraintes d‚Äôacc√®s, s√©curit√©, planning, autorisations.",
  resultats:"R√©sultats mesurables attendus en fin de prestation.",
  reception:"Modalit√©s de contr√¥le et de r√©ception.",
};
const QCM = { sec:(id,label,help,opts)=>({id,label,help,options:opts}) };

// ===== QCM personnalis√©s (4 jeux) ‚Äî selon vos consignes =====
const COPAYA_A_QCM = [
  QCM.sec('objet','Objet',HELP.objet,[
    ['√âlagage de la v√©g√©tation autour des ouvrages √©lectriques HTA/HTB',1],
    ['Maintenance pr√©ventive des lignes issues du poste √âtoile jusqu‚Äôau poste Margot',1],
    ['R√©alisation d‚Äôune visite pr√©alable avec COPAYA avant les travaux',1],
    ['Fourniture d‚Äô√©quipements √©lectriques haute tension',0],
    ['Construction d‚Äôun nouveau poste √©lectrique',0],
  ]),
  QCM.sec('contexte','Contexte',HELP.contexte,[
    ['Pousse rapide de la v√©g√©tation en Guyane',1],
    ['Risques de coupures intempestives pour la client√®le',1],
    ['Risques de s√©curit√© pour les tiers',1],
    ['Modernisation des r√©seaux fibre optique',0],
    ['Projet li√© √† l‚Äôaugmentation des besoins touristiques',0],
  ]),
  QCM.sec('definition','D√©finition de la prestation',HELP.def,[
    ['√âlagage manuel',1],['√âlagage au bulldozer',1],['√âlagage au gyrobroyeur',1],['Gestion des acc√®s aux pieds de support',1],
    ['Pose de c√¢bles HTA',0],['405 km √† √©laguer sur le r√©seau HTA',1],['250 km √† √©laguer sur le r√©seau HTB',1],['100 pieds de support + acc√®s',1],
  ]),
  QCM.sec('limites_titulaire','Limites √† la charge du titulaire',HELP.limites_titulaire,[
    ['Organiser les moyens humains et mat√©riels n√©cessaires',1],
    ['R√©aliser l‚Äô√©lagage et l‚Äôacc√®s aux pieds de support',1],
    ['Transmettre un planning apr√®s la visite pr√©alable avec COPAYA',1],
  ]),
  QCM.sec('limites_entreprise','Limites √† la charge de l‚Äôentreprise (COPAYA)',HELP.limites_entreprise,[
    ['Fourniture des plans et proc√©dures d\'acc√®s',1],
    ['Accompagnement lors de la visite pr√©alable',1],
    ['Fourniture du personnel d‚Äô√©lagage',0],
    ['Mise √† disposition du mat√©riel d‚Äôascension',0],
  ]),
  QCM.sec('qualite','Qualit√©',HELP.qualite,[
    ['Photos avant / apr√®s intervention',1],['Rapport pr√©cis de chaque zone √©lagu√©e',1],['Respect du d√©cret du 20 f√©vrier 1992',1],['Certification ISO obligatoire',0]
  ]),
  QCM.sec('conditions','Conditions d‚Äôinterventions',HELP.conditions,[
    ['Interventions pr√©f√©rentiellement entre 6h30 et 17h',1],['DT-DICT envoy√©e 15 jours avant travaux',1],
    ['Inspection commune pr√©alable obligatoire',1],['Travaux en zone prot√©g√©e soumis √† r√©glementation environnementale',1],
    ['Travaux uniquement la nuit',0],['Intervention sans pr√©venir COPAYA',0],
  ]),
  QCM.sec('resultats','R√©sultats attendus',HELP.resultats,[
    ['Continuit√© de l‚Äôalimentation √©lectrique',1],['Suppression des risques de court-circuit d√ª aux v√©g√©taux',1],['Diminution des coupures intempestives',1],['Installation de nouveaux √©quipements HTA',0],
  ]),
  QCM.sec('reception','R√©ception',HELP.reception,[
    ['Signature d‚Äôun rapport de visite pr√©alable par les deux parties',1],['COPAYA peut refuser un chantier non conforme',1],['Photos justificatives obligatoires pour validation',1],['R√©ception automatique sans contr√¥le',0],
  ]),
];

const COPAYA_B_QCM = [
  QCM.sec('objet','Objet',HELP.objet,[
    ["Raccordement au r√©seau √©lectrique d'un village situ√© en Guyane Fran√ßaise",1],
    ["R√©alisation de fouilles et de dalles de propret√©",0],
    ["Stabilisation du r√©seau √©lectrique pour les habitants",0],
    ["Respect des normes HTA et DT/DICT",0],
  ]),
  QCM.sec('contexte','Contexte',HELP.contexte,[
    ['Projet prioritaire pour maintenir le service public d‚Äô√©lectricit√©',1],
    ['Limiter les nuisances et finaliser les travaux avant la saison des pluies',1],
    ['Attentes fortes des habitants concernant la qualit√© du r√©seau',1],
    ['Projet pr√©vu uniquement pour augmenter la capacit√© de production locale',0],
  ]),
  QCM.sec('definition','D√©finition de la prestation',HELP.def,[
    ['Mise en souterrain de 20 km de r√©seau HTA et 15 km de fibre optique',1],
    ['Installation et mise en service d‚Äôarmoires √©lectriques & raccordements HTA',1],
    ['Confection de 60 bo√Ætes de jonction HTA et fourniture/pose de fourreaux',1],
    ['Travaux de d√©boisement et construction de logements temporaires',0],
  ]),
  QCM.sec('limites_titulaire','Limites √† la charge du titulaire',HELP.limites_titulaire,[
    ['R√©alisation des fouilles et dalle de propret√©',1],
    ['Raccordement, √©tiquetage c√¢bles HTA et transmission chambres de tirage',1],
    ['Respect du balisage, panneaux, gyrophare et s√©curit√© chantier',1],
    ['Fourniture des c√¢bles et des bo√Ætes de jonction',0],
  ]),
  QCM.sec('limites_entreprise','Limites √† la charge de l‚Äôentreprise',HELP.limites_entreprise,[
    ['Fourniture des c√¢bles',1],['Fourniture des bo√Ætes de jonction',1],['Mise √† disposition d‚Äôun local de stockage',1],['Fourniture des chambres de tirage',0],
  ]),
  QCM.sec('qualite','Qualit√©',HELP.qualite,[
    ['Travaux r√©alis√©s dans les d√©lais pour √©viter la saison des pluies',1],['Respect des normes techniques HTA et DT/DICT',1],['Limitation des nuisances (bruit, circulation)',1],['Interventions uniquement de nuit pour limiter les impacts urbains',0],
  ]),
  QCM.sec('conditions','Conditions d‚Äôinterventions',HELP.conditions,[
    ['Transmission d‚Äôun planning permettant d‚Äô√©tablir la FDO',1],['Visites r√©guli√®res de pr√©vention s√©curit√© organis√©es par COPAYA',1],['Communication via l‚Äôoutil COPAYA d√©di√©',1],['Intervention uniquement durant les week-ends',0],
  ]),
  QCM.sec('resultats','R√©sultats attendus',HELP.resultats,[
    ['R√©seau souterrain op√©rationnel et fiable pour les habitants',1],['Stabilisation du r√©seau et r√©duction du risque de coupures',1],['Travaux conformes aux prescriptions r√©glementaires et techniques',1],['Production d‚Äô√©lectricit√© accrue dans la r√©gion',0],
  ]),
  QCM.sec('reception','R√©ception',HELP.reception,[
    ['Contr√¥le des travaux par COPAYA',1],['R√©ception apr√®s conformit√© r√©glementaire DGTM & IC/OL',1],['V√©rification des installations HTA et fibre avant mise en service',1],['R√©ception automatique apr√®s fin de chantier',0],
  ]),
];

const TILESA_B_QCM = [
  QCM.sec('objet','Objet',HELP.objet,[
    ['Achat de v√©hicules √©lectriques neufs pour renouveler la flotte de Tilesa',1],
    ['Remplacement des bornes de recharge existantes',0],
    ['Achat de v√©los √©lectriques pour les √©quipes',0],
    ['Maintenance du r√©seau fibre optique',0],
  ]),
  QCM.sec('contexte','Contexte',HELP.contexte,[
    ['Tilesa souhaite √©lectrifier sa flotte pour r√©duire son impact environnemental',1],
    ['Tilesa souhaite uniquement augmenter la vitesse de ses v√©hicules',0],
    ['La flotte actuelle est d√©j√† 100% √©lectrique',0],
    ['Le projet r√©pond aux engagements climatiques europ√©ens',1],
  ]),
  QCM.sec('definition','D√©finition de la prestation',HELP.def,[
    ['Fourniture de v√©hicules √©lectriques adapt√©s √† la Guyane',1],
    ['Livraison sur plusieurs sites (Cayenne, Kourou, Saint-Laurent‚Ä¶)',1],
    ['Formation des utilisateurs √† la conduite des VE',1],
    ['Achat de v√©hicules thermiques hybrides rechargeables uniquement',0],
  ]),
  QCM.sec('limites_titulaire','Limites √† la charge du titulaire',HELP.limites_titulaire,[
    ["Acheminement jusqu'en Guyane, douane & livraison finale",1],
    ["Formalit√©s d'immatriculation locale",1],
    ['Service apr√®s-vente local ou agr√©√©',1],
    ['Assurance des v√©hicules',0],
  ]),
  QCM.sec('limites_entreprise','Limites √† la charge de l‚Äôentreprise',HELP.limites_entreprise,[
    ['Mise √† disposition des emplacements & stationnement',1],
    ['Assurance des v√©hicules',1],
    ['Installation des bornes de recharge',1],
    ['Fourniture des v√©hicules thermiques de secours',0],
  ]),
  QCM.sec('qualite','Qualit√©',HELP.qualite,[
    ['V√©hicules adapt√©s au climat et aux routes locales',1],
    ['Documentation compl√®te & garanties',1],
    ['Pas besoin de SAV local',0],
    ['V√©hicules test√©s avant livraison',1],
  ]),
  QCM.sec('conditions','Conditions d‚Äôintervention',HELP.conditions,[
    ['Livraison uniquement en jours ouvr√©s',1],
    ['V√©rification fonctionnelle √† la r√©ception',1],
    ['Livraison libre sans prise de rendez-vous',0],
    ['Livraison uniquement sur Cayenne',0],
  ]),
  QCM.sec('resultats','R√©sultats attendus',HELP.resultats,[
    ['R√©duction mesurable des √©missions CO‚ÇÇ',1],
    ["Am√©lioration du confort des utilisateurs",1],
    ['Fonctionnement optimal malgr√© contraintes territoriales',1],
    ['R√©duction du nombre de sites op√©rationnels',0],
  ]),
  QCM.sec('reception','R√©ception',HELP.reception,[
    ['Remise de la documentation compl√®te',1],
    ['V√©rification fonctionnelle & premi√®re charge',1],
    ['Acceptation automatique sans contr√¥le',0],
    ['Enregistrement administratif conforme',1],
  ]),
];

const LESATI_B_QCM = [
  QCM.sec('objet','Objet',HELP.objet,[
    ["Fourniture d‚Äô√©quipements destin√©s √† l‚Äôexploitation et √† la maintenance d‚Äôune centrale hydraulique",1],
    ['Achat de pompes et de moteurs',0],
    ['Maintenance de la centrale hydraulique',0],
    ["Achat d'√©quipements pour centrale de production",0],
  ]),
  QCM.sec('contexte','Contexte',HELP.contexte,[
    ['Le barrage de Petit Saut a √©t√© construit au niveau du fleuve Sinnamary',1],
    ['La mise en service a eu lieu en 1994',1],
    ['La retenue d‚Äôeau de 310 km¬≤ alimente deux tiers des foyers du littoral',1],
    ['Ce projet concerne une installation industrielle hors Guyane',0],
  ]),
  QCM.sec('definition','D√©finition de la prestation',HELP.def,[
    ['Fourniture de pi√®ces de rechange pour pompe et √©quipements hydrauliques',1],
    ['Fourniture des √©quipements conformes aux normes en vigueur',1],
    ['Fourniture de syst√®mes d‚Äôair conditionn√©',0],
    ['Fourniture d‚Äô√©quipements pour centrale photovolta√Øque',0],
  ]),
  QCM.sec('limites_titulaire','Limites √† la charge du titulaire',HELP.limites_titulaire,[
    ['Remplacement ou r√©paration en cas de d√©faillance',1],
    ['Livraison dans les conditions sp√©cifi√©es',1],
    ['Pr√©venir l‚Äôentreprise 21 jours avant la livraison',1],
    ['Fourniture des documents techniques',1],
    ['Le titulaire peut livrer sans emballage',0],
  ]),
  QCM.sec('limites_entreprise','Limites √† la charge de l‚Äôentreprise',HELP.limites_entreprise,[
    ['Le transport et le d√©chargement sont √† la charge du titulaire',1],
    ['L‚Äôentreprise prend en charge le d√©chargement des colis',0],
    ['L‚Äôentreprise g√®re l‚Äôassurance transport',0],
    ['L‚Äôentreprise fournit les pi√®ces si n√©cessaire',0],
  ]),
  QCM.sec('qualite','Qualit√©',HELP.qualite,[
    ['Certificats de conformit√©',1],['Notices techniques',1],['Plans d‚Äôinstallation si n√©cessaire',1],['Rapport d‚Äôessais',1],['Aucune documentation fournie',0],
  ]),
  QCM.sec('conditions','Conditions d‚Äôinterventions',HELP.conditions,[
    ['Livraison du lundi au vendredi de 08h00 √† 12h00',1],['Livraison possible uniquement de nuit',0],["Emballage avec protection contre l'humidit√© et les chocs",1],['√âtiquetage clair et de r√©f√©rence',1],
  ]),
  QCM.sec('resultats','R√©sultats attendus',HELP.resultats,[
    ['Mat√©riels fonctionnels conformes aux sp√©cifications',1],['Documentation compl√®te remise',1],['Audit environnemental r√©alis√©',0],["Remplacement automatique des √©quipements au bout d‚Äôun an",0],
  ]),
  QCM.sec('reception','R√©ception',HELP.reception,[
    ['Contr√¥le technique des √©quipements',1],['Possibilit√© de refus si colis non conforme',1],['R√©ception automatique sans contr√¥le',0],['D√©chargement effectu√© par le transporteur',1],
  ]),
];

// QCM g√©n√©riques pour LESATI A & TILESA A (inchang√©s)
const GENERIC_A_QCM = [
  QCM.sec('objet','Objet',HELP.objet,[['D√©finir l‚Äôobjet du march√©',1],['Hors p√©rim√®tre',0]]),
  QCM.sec('contexte','Contexte',HELP.contexte,[['Contexte pertinent',1],['Hors sujet',0]]),
  QCM.sec('definition','D√©finition',HELP.def,[['Prestation incluse',1],['Non inclus',0]]),
  QCM.sec('limites_titulaire','Limites titulaire',HELP.limites_titulaire,[['√Ä charge du titulaire',1]]),
  QCM.sec('limites_entreprise','Limites entreprise',HELP.limites_entreprise,[['√Ä charge de l‚Äôentreprise',1]]),
  QCM.sec('qualite','Qualit√©',HELP.qualite,[['Conformit√©',1]]),
  QCM.sec('conditions','Conditions',HELP.conditions,[['Acc√®s & s√©curit√©',1]]),
  QCM.sec('resultats','R√©sultats',HELP.resultats,[['R√©sultat mesurable',1]]),
  QCM.sec('reception','R√©ception',HELP.reception,[['Proc√®s-verbal',1]]),
];

// Registre jeux -> QCM
const GAME_QCM = {
  LESATI_A: GENERIC_A_QCM, LESATI_B: LESATI_B_QCM,
  COPAYA_A: COPAYA_A_QCM, COPAYA_B: COPAYA_B_QCM,
  TILESA_A: GENERIC_A_QCM, TILESA_B: TILESA_B_QCM,
};

// Navigation domaine/jeux
function openDomain(key){
  S.domain = key;
  const d = GAMES[key];
  DOM('domainTitle').textContent = d.title;
  const wrap = DOM('games'); wrap.innerHTML = '';
  d.items.forEach(item=>{
    const el = document.createElement('div'); el.className='card';
    el.innerHTML = `<h2>${item.title}</h2><p class="small">${item.intro}</p>
    <button class="btn" onclick="openGame('${item.id}')">D√©marrer</button>`;
    wrap.appendChild(el);
  });
  go('domain');
}
function getCurrentItem(){
  const domainKey = Object.keys(GAMES).find(k=>GAMES[k].items.some(i=>i.id===S.game));
  return GAMES[domainKey].items.find(i=>i.id===S.game);
}
function openGame(gameId){
  S.game = gameId;
  S.visited = new Set();
  const item = getCurrentItem();
  DOM('mapTitle').textContent = item.title;
  DOM('introText').textContent = item.intro;
  const box = DOM('services'); box.innerHTML='';
  item.services.forEach(s => {
    const div = document.createElement('div'); div.className='service'; div.tabIndex=0;
    div.innerHTML = `<strong>${s}</strong>`;
    div.addEventListener('click',()=>visitService(s,div));
    box.appendChild(div);
  });
  DOM('btnWrite').style.display='none';
  go('map');
}
function visitService(name, node){
  S.visited.add(name);
  node.classList.add('done');
  const item = getCurrentItem();
  if(S.visited.size >= item.services.length){
    DOM('btnWrite').style.display='inline-block';
  }
}
function startAssistant(){
  S.dataset = { steps: GAME_QCM[S.game] };
  S.selections = {};
  buildAssistant();
  go('assistant');
}
function backToMap(){ go('map'); }

// Assistant builder
function buildAssistant(){
  DOM('asstTitle').textContent = getCurrentItem().title + ' ‚Äî Assistant (QCM)';
  const tabs = DOM('tabs'); const panels = DOM('panels');
  tabs.innerHTML=''; panels.innerHTML=''; S.index=0;

  S.dataset.steps.forEach((s,i)=>{
    const b = document.createElement('button'); b.className='tab'+(i===0?' active':''); b.textContent = `${i+1}. ${s.label}`;
    b.onclick = ()=>goStep(i);
    tabs.appendChild(b);

    const p = document.createElement('div'); p.className='panel'+(i===0?' active':''); p.id='panel-'+s.id;
    const opts = s.options.map((t,idx)=>{
      const label = Array.isArray(t)?t[0]:t;
      const val = Array.isArray(t)?(t[1]!==undefined?t[1]:1):1;
      return `<div class="option"><label><input type="checkbox" data-step="${s.id}" data-idx="${idx}" data-ok="${val}"> ${label}</label></div>`;
    }).join('');
    p.innerHTML = `<h3>${i+1}. ${s.label}</h3>
      <div class="help"><details><summary>Aide (facultatif)</summary><div>${s.help||''}</div></details></div>
      <div class="small">S√©lectionnez les √©l√©ments pertinents pour votre CCTP.</div>
      ${opts}`;
    panels.appendChild(p);
  });
  panels.addEventListener('change', (e)=>{
    if(e.target && e.target.matches('input[type="checkbox"]')){
      const st = e.target.dataset.step, idx = Number(e.target.dataset.idx);
      if(!S.selections[st]) S.selections[st] = new Set();
      if(e.target.checked) S.selections[st].add(idx); else S.selections[st].delete(idx);
    }
  });
  DOM('prevBtn').onclick = ()=>goStep(S.index-1);
  DOM('nextBtn').onclick = ()=>{ if(!hasPick()) {DOM('warn').style.display='block'; return;} DOM('warn').style.display='none'; goStep(S.index+1); };
  DOM('finishBtn').onclick = ()=>{ if(!hasPick()) {DOM('warn').style.display='block'; return;} DOM('warn').style.display='none'; buildSummary(); };
  updateNav();
}
function goStep(i){
  if(i<0||i>=S.dataset.steps.length) return;
  S.index = i;
  [...DOM('tabs').children].forEach((b,k)=>b.classList.toggle('active',k===i));
  [...DOM('panels').children].forEach((p,k)=>p.classList.toggle('active',k===i));
  const pct = Math.round((i)/(S.dataset.steps.length-1)*100);
  DOM('prog').style.width = pct+'%';
  updateNav();
}
function updateNav(){
  DOM('prevBtn').disabled = (S.index===0);
  DOM('nextBtn').style.display = (S.index===S.dataset.steps.length-1)?'none':'inline-block';
  DOM('finishBtn').style.display = (S.index===S.dataset.steps.length-1)?'inline-block':'none';
}
function hasPick(){
  const stepId = S.dataset.steps[S.index].id;
  const set = S.selections[stepId];
  return set && set.size>0;
}

// R√©sum√© + scoring
function buildSummary(){
  DOM('sumTitle').textContent = getCurrentItem().title+' ‚Äî R√©sum√©';
  const wrap = [];
  let total=0, good=0; const errors=[];
  S.dataset.steps.forEach((s,i)=>{
    const picked = (S.selections[s.id] ? Array.from(S.selections[s.id]) : []);
    if(picked.length){
      wrap.push(`<h3>${i+1}. ${s.label}</h3><ul>`);
      picked.forEach(idx => {
        const label = Array.isArray(s.options[idx])?s.options[idx][0]:s.options[idx];
        wrap.push(`<li>${label}</li>`);
      });
      wrap.push('</ul>');
    }
    // count correct
    s.options.forEach((t)=>{ const ok = Array.isArray(t)? (t[1]!==undefined?t[1]:1) : 1; if(ok===1) total++; });
    picked.forEach(idx=>{ const ok = Array.isArray(s.options[idx])? (s.options[idx][1]!==undefined?s.options[idx][1]:1) : 1; if(ok===1) good++; else { errors.push({label:s.label, wrong:[Array.isArray(s.options[idx])?s.options[idx][0]:s.options[idx]], missed:[]}); } });
    // missed
    const requiredIdx = s.options.map((t,i)=>[i, Array.isArray(t)? (t[1]!==undefined?t[1]:1) : 1]).filter(x=>x[1]===1).map(x=>x[0]);
    const missed = requiredIdx.filter(i2=>!picked.includes(i2));
    if(missed.length) errors.push({label:s.label, wrong:[], missed:missed.map(i2=>Array.isArray(s.options[i2])?s.options[i2][0]:s.options[i2])});
  });
  DOM('sumContent').innerHTML = wrap.join('') || '<p>Aucun √©l√©ment s√©lectionn√©.</p>';
  const pct = total? Math.round(100*good/total) : 0;
  let level='D√©butant'; if(pct>95) level='G√©nie'; else if(pct>=71) level='Expert'; else if(pct>=51) level='Avanc√©';
  DOM('score').textContent = `Score : ${good} / ${total} (${pct}%) ‚Äî Niveau ${level}`;
  const btn = DOM('toggleErr'); const panel = DOM('errPanel');
  if(errors.length){
    btn.style.display='inline-block';
    panel.innerHTML = errors.map(e=>{
      let block = `<h4>${e.label}</h4>`;
      if(e.wrong.length) block += `<div style="color:#b91c1c"><strong>Choix non attendus :</strong><ul>${e.wrong.map(x=>`<li>${x}</li>`).join('')}</ul></div>`;
      if(e.missed.length) block += `<div style="color:#92400e"><strong>√Ä ne pas oublier :</strong><ul>${e.missed.map(x=>`<li>${x}</li>`).join('')}</ul></div>`;
      return block;
    }).join('');
    btn.onclick = ()=>{ panel.style.display = panel.style.display==='none' ? 'block':'none'; btn.textContent = panel.style.display==='none'?'Voir mes erreurs':'Masquer les erreurs'; };
  }else{
    btn.style.display='none'; panel.style.display='none'; panel.innerHTML='';
  }
  go('summary');
}
</script>
</body>
</html>
"""
with open(file_path,'w',encoding='utf-8') as f:
    f.write(html)
file_path
::contentReference[oaicite:0]{index=0}
