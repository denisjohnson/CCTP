<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Plateforme CCTP ‚Äî Domaines & Jeux (A/B)</title>
<style>
  :root{--primary:#0a74da;--primary-dark:#095aba;--bg:#f4f7fb;--card:#fff;--text:#22324a}
  *{box-sizing:border-box}body{font-family:Arial,Helvetica,sans-serif;margin:0;background:var(--bg);color:var(--text)}
  .container{max-width:1100px;margin:0 auto;padding:clamp(16px,4vw,32px)}
  .screen{display:none;animation:fade .25s ease} .active{display:block}
  @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
  h1,h2,h3{margin:0 0 .8rem}
  .muted{color:#64748b}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem}
  .card{background:#fff;border-radius:14px;box-shadow:0 10px 26px rgba(0,0,0,.08);padding:1rem}
  .btn{padding:.7rem 1.1rem;background:#0a74da;color:#fff;border:none;border-radius:10px;font-weight:700;cursor:pointer}
  .btn:hover{background:#095aba}
  .btn.secondary{background:#e9eef5;color:#1b304a}
  .hero{width:100%;max-width:980px;border-radius:16px;box-shadow:0 10px 26px rgba(0,0,0,.08);display:block;margin:0 auto 12px;object-fit:contain;max-height:60vh}
  .map{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem;margin-top:1rem}
  .location{background:#fff;padding:1rem;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.06);text-align:center;cursor:pointer;transition:transform .15s ease,box-shadow .2s ease}
  .location:hover{transform:translateY(-2px);box-shadow:0 10px 22px rgba(0,0,0,.08)}
  .location img{width:48px;height:48px;margin-bottom:.5rem}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:999}
  .overlay.active{display:block}
  .modal{position:fixed;top:5%;left:50%;transform:translateX(-50%);background:#fff;padding:clamp(16px,3vw,24px);border-radius:14px;box-shadow:0 18px 50px rgba(0,0,0,.25);display:none;z-index:1000;width:min(92vw,820px);max-height:90vh;overflow:auto}
  .modal.active{display:block}
  .modal img{max-width:100%;max-height:40vh;object-fit:contain;display:block;margin:0 auto .6rem}
  .modal p{white-space:pre-wrap;line-height:1.35}
  .notice{background:#f8fafc;border:1px solid #d1d5db;border-radius:12px;padding:1rem;margin-top:1rem;display:none}
  .info-log{margin-top:.6rem;color:#0f7a31}
  /* Builder (QCM) */
  .tabs{display:flex;flex-wrap:wrap;gap:.5rem;margin-bottom:.8rem;}
  .tab-btn{padding:.45rem .7rem;border-radius:10px;border:1px solid #d8e0ea;background:#fff;cursor:pointer;font-size:.92rem;color:#213347;}
  .tab-btn.active{background:#0a74da;color:#fff;border-color:#0a74da;}
  .tab-panel{display:none;background:#fff;padding:1rem;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.06);}
  .tab-panel.active{display:block;}
  .progress{height:10px;background:#e9eef5;border-radius:999px;overflow:hidden;margin:10px 0 18px;}
  .progress>span{display:block;height:100%;background:#0a74da;width:0%;transition:width .25s ease;}
  .option-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:.75rem;margin-top:.75rem;}
  .option{border:1px solid #e6e6e6;border-radius:10px;padding:.75rem;background:#fafafa;}
  .option label{display:block;cursor:pointer;line-height:1.35;}
  .helper{font-size:.92rem;color:#526479;margin:.4rem 0 .1rem}
  .warn{color:#b54708;background:#fff7ed;padding:.5rem .75rem;border-radius:8px;border:1px solid #fde68a;display:none;margin-top:.5rem;}
  .summary{background:#fff;padding:1rem;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.06);}
  .score{margin-top:12px;background:#f0f9ff;border:1px solid #bae6fd;color:#0c4a6e;padding:.75rem 1rem;border-radius:12px;font-weight:600;display:none;}
  .badge{display:inline-block;padding:.35rem .6rem;border-radius:999px;font-size:.9rem;font-weight:700;margin-left:.5rem;}
  .badge.debutant{background:#fff1f2;color:#be123c;border:1px solid #fecdd3;}
  .badge.avance{background:#fff7ed;color:#b45309;border:1px solid #fed7aa;}
  .badge.expert{background:#eff6ff;color:#1d4ed8;border:1px solid #93c5fd;}
  .badge.genie{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0;}
  .errors{margin-top:10px;background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:.75rem 1rem;display:none;}
  .errors h4{margin:.2rem 0 .4rem;}
  .errors ul{margin:.2rem 0 0 1rem;}
  .toggle{margin-top:8px;background:#e9eef5;color:#22324a;}
</style>
</head>
<body>

<script>
(function () {
  function show(id) {
    var screens = document.querySelectorAll('.screen');
    for (var i = 0; i < screens.length; i++) screens[i].classList.remove('active');
    var el = document.getElementById(id) || document.getElementById('home');
    if (el) el.classList.add('active');
    try { window.scrollTo(0, 0); } catch(e) {}
  }
  window.goTo = function (id) {
    show(id);
    try { history.replaceState(null, '', '#' + id); } catch (e) { location.hash = id; }
  };
  window.addEventListener('hashchange', function () {
    var id = (location.hash || '#home').slice(1);
    show(id);
  });
  var start = (location.hash || '#home').slice(1);
  show(start);
})();
</script>

<!-- ACCUEIL -->
<div id="home" class="screen active">
  <div class="container">
    <img class="hero" src="images/accueil_salle_formation.png" alt="Salle de formation moderne en Guyane">
    <h2>Choisissez votre domaine</h2>
    <div class="grid">
      <div class="card">
        <h3>Domaine Production</h3>
        <p class="muted">Jeux de l'entreprise LESATI (Thermique, Hydraulique, Smart Grids)</p>
        <button class="btn" onclick="goTo('domain_production')">Acc√©der</button>
      </div>
      <div class="card">
        <h3>Domaine R√©seau</h3>
        <p class="muted">Jeux de l'entreprise COPAYA (R√©seaux & Exploitation)</p>
        <button class="btn" onclick="goTo('domain_reseau')">Acc√©der</button>
      </div>
      <div class="card">
        <h3>Domaine Tertiaire</h3>
        <p class="muted">Jeux de l'entreprise TILESA (Tertiaire et Telecom)</p>
        <button class="btn" onclick="goTo('domain_tertiaire')">Acc√©der</button>
      </div>
    </div>
  </div>
</div>

<!-- DOMAINES -->
<div id="domain_production" class="screen"><div class="container">
  <h2>Domaine Production ‚Äî LESATI</h2>
  <div class="grid">
    <div class="card">
      <h3>Jeu A ‚Äî Centrale Thermique (L√©a)</h3>
      <p class="muted">Centrale Thermique : explorez les services de la centrale thermique, puis r√©digez le cahier des charges.</p>
      <button class="btn" onclick="goTo('game2_intro')">Lancer</button>
    </div>
    <div class="card">
      <h3>Jeu B ‚Äî Centrale Hydraulique (L√©on)</h3>
      <p class="muted">Centrale Hydraulique : explorez les services de la centrale hydraulique, puis r√©digez le cahier des charges.</p>
      <button class="btn" onclick="goTo('game3_intro')">Lancer</button>
    </div>
  </div>
  <button class="btn secondary" onclick="goTo('home')">‚¨Ö Retour</button>
</div></div>

<div id="domain_reseau" class="screen"><div class="container">
  <h2>Domaine R√©seau ‚Äî COPAYA</h2>
  <div class="grid">
    <div class="card">
      <h3>Jeu A ‚Äî √âlagage (Sylvie)</h3>
      <p class="muted">√âlagage : explorez les services, puis r√©digez le cahier des charges.</p>
      <button class="btn" onclick="goTo('game4_intro')">Lancer</button>
    </div>
    <div class="card">
      <h3>Jeu B ‚Äî Raccordement HTA (Carl)</h3>
      <p class="muted">Raccordement HTA : explorez les services, puis r√©digez le cahier des charges.</p>
      <button class="btn" onclick="goTo('game5_intro')">Lancer</button>
    </div>
  </div>
  <button class="btn secondary" onclick="goTo('home')">‚¨Ö Retour</button>
</div></div>

<div id="domain_tertiaire" class="screen"><div class="container">
  <h2>Domaine Tertiaire ‚Äî TILESA</h2>
  <div class="grid">
    <div class="card">
      <h3>Jeu A ‚Äî Nettoyage des Sites (Alex)</h3>
      <p class="muted">Nettoyage des sites : Explorez les services, puis r√©digez le cahier des charges.</p>
      <button class="btn" onclick="goTo('game1_intro')">Lancer</button>
    </div>
    <div class="card">
      <h3>Jeu B ‚Äî V√©hicules √âlectriques (Manon)</h3>
      <p class="muted">V√©hicules √âlectriques : Explorez les services, puis r√©digez le cahier des charges.</p>
      <button class="btn" onclick="goTo('game6_intro')">Lancer</button>
    </div>
  </div>
  <button class="btn secondary" onclick="goTo('home')">‚¨Ö Retour</button>
</div></div>

<!-- INTROS -->
<div id="game1_intro" class="screen"><div class="container">
  <img class="hero" src="images/tilesia_accueil_alex.png" alt="">
  <h2>TILESA ‚Äî Jeu A (Nettoyage des sites)</h2>
  <button class="btn" onclick="goTo('game1')">D√©marrer</button>
  <button class="btn secondary" onclick="goTo('domain_tertiaire')">‚¨Ö Retour</button>
</div></div>

<div id="game2_intro" class="screen"><div class="container">
  <img class="hero" src="images/lea_centrale_LESATI.png" alt="">
  <h2>LESATI ‚Äî Jeu A (Centrale Thermique)</h2>
  <p>L√©a, charg√©e d'affaires du service production, est volontaire pour r√©aliser l'expression du besoin. Il s'agit de l'achat de 3 nouveaux groupes √©lectrog√®nes.</p>
  <button class="btn" onclick="goTo('game2')">D√©marrer</button>
  <button class="btn secondary" onclick="goTo('domain_production')">‚¨Ö Retour</button>
</div></div>

<div id="game3_intro" class="screen"><div class="container">
  <img class="hero" src="images/leon_centrale_LESATI.png" alt="">
  <h2>LESATI ‚Äî Jeu B (Centrale Hydraulique)</h2>
  <p>L√©on, nouveau chef de projet de la centrale hydraulique, est volontaire pour r√©diger le cahier des charges concernant l‚Äôachat de pi√®ces de rechange.</p>
  <button class="btn" onclick="goTo('game3')">D√©marrer</button>
  <button class="btn secondary" onclick="goTo('domain_production')">‚¨Ö Retour</button>
</div></div>

<div id="game4_intro" class="screen"><div class="container">
  <img class="hero" src="images/copaya_accueil.png" alt="">
  <h2>COPAYA ‚Äî Jeu A (√âlagage)</h2>
  <p>Vous incarnez Sylvie, charg√©e d‚Äôaffaires au sein de l‚Äôentreprise Copaya. Vous avez pour objectif de r√©diger le cahier des charges pour les prestations d‚Äô√©lagage.</p>
  <button class="btn" onclick="goTo('game4')">D√©marrer</button>
  <button class="btn secondary" onclick="goTo('domain_reseau')">‚¨Ö Retour</button>
</div></div>

<div id="game5_intro" class="screen"><div class="container">
  <img class="hero" src="images/copaya_intro.png" alt="">
  <h2>COPAYA ‚Äî Jeu B (Raccordement HTA)</h2>
  <p>Vous incarnez Carl, nouveau charg√© d‚Äôaffaires du service r√©seau. Vous √™tes en charge de la r√©daction d‚Äôun cahier des charges pour le raccordement HTA d‚Äôun village.</p>
  <button class="btn" onclick="goTo('game5')">D√©marrer</button>
  <button class="btn secondary" onclick="goTo('domain_reseau')">‚¨Ö Retour</button>
</div></div>

<div id="game6_intro" class="screen"><div class="container">
  <img class="hero" src="images/accueil_sabrina.png" alt="">
  <h2>TILESA ‚Äî Jeu B (V√©hicules √âlectriques)</h2>
  <p>Vous incarnez Manon, pilote de la maintenance des v√©hicules. Vous √™tes en charge de la r√©daction d‚Äôun cahier des charges pour l‚Äôachat de v√©hicules √©lectriques neufs.</p>
  <button class="btn" onclick="goTo('game6')">D√©marrer</button>
  <button class="btn secondary" onclick="goTo('domain_tertiaire')">‚¨Ö Retour</button>
</div></div>

<!-- CARTES / JEUX -->
<div id="game1" class="screen"><div class="container">
  <h2>TILESA ‚Äî Jeu A (Nettoyage des sites)</h2>
  <div class="map">
    <div class="location" onclick="openModal('Direction',1)"><img src="https://cdn-icons-png.flaticon.com/512/219/219986.png" alt="">Direction</div>
    <div class="location" onclick="openModal('Technique',1)"><img src="https://cdn-icons-png.flaticon.com/512/2621/2621140.png" alt="">Technique</div>
    <div class="location" onclick="openModal('Salaries',1)"><img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="">Salari√©s</div>
    <div class="location" onclick="openModal('Juridique',1)"><img src="https://cdn-icons-png.flaticon.com/512/2569/2569069.png" alt="">Juridique</div>
  </div>
  <div class="info-log" id="infoLog1"></div>
  <div style="margin-top:10px;display:flex;gap:.5rem;flex-wrap:wrap">
    <button class="btn" onclick="startBuilder(1,true)">R√©diger le cahier des charges</button>
    <button class="btn secondary" onclick="goTo('domain_tertiaire')">‚¨Ö Retour</button>
  </div>
</div></div>

<div id="game2" class="screen"><div class="container">
  <h2>LESATI ‚Äî Jeu A (Centrale Thermique)</h2>
  <div class="map">
    <div class="location" onclick="openModal('Direction',2)"><img src="https://cdn-icons-png.flaticon.com/512/219/219986.png" alt="">Direction</div>
    <div class="location" onclick="openModal('Service production',2)"><img src="https://cdn-icons-png.flaticon.com/512/1995/1995525.png" alt="">Service production</div>
    <div class="location" onclick="openModal('Salaries',2)"><img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="">Salari√©s</div>
    <div class="location" onclick="openModal('Juridique',2)"><img src="https://cdn-icons-png.flaticon.com/512/2569/2569069.png" alt="">Juridique</div>
  </div>
  <div class="info-log" id="infoLog2"></div>
  <button class="btn secondary" onclick="goTo('domain_production')">‚¨Ö Retour</button>
  <button id="btnCCTP2" class="btn" style="display:none" onclick="document.getElementById('notice2').style.display='block'">R√©diger le cahier des charges</button>
  <div id="notice2" class="notice" style="display:none"><strong>Vous disposez de toutes les informations pour √©crire un cahier des charges en 45 minutes.</strong></div>
</div></div>

<div id="game3" class="screen"><div class="container">
  <h2>LESATI ‚Äî Jeu B (Centrale Hydraulique)</h2>
  <div class="map">
    <div class="location" onclick="openModal('Direction B',3)"><img src="https://cdn-icons-png.flaticon.com/512/219/219986.png" alt="">Direction</div>
    <div class="location" onclick="openModal('Manager',3)"><img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="">Manager</div>
    <div class="location" onclick="openModal('Maintenance',3)"><img src="https://cdn-icons-png.flaticon.com/512/1995/1995525.png" alt="">Maintenance</div>
    <div class="location" onclick="openModal('Juridique B',3)"><img src="https://cdn-icons-png.flaticon.com/512/2569/2569069.png" alt="">Juridique</div>
    <div class="location" onclick="openModal('S√©curit√©',3)"><img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="">S√©curit√©</div>
  </div>
  <div class="info-log" id="infoLog3"></div>
  <div style="margin-top:10px;display:flex;gap:.5rem;flex-wrap:wrap">
    <button class="btn" onclick="startBuilder(3,true)">R√©diger le cahier des charges</button>
    <button class="btn secondary" onclick="goTo('domain_production')">‚¨Ö Retour</button>
  </div>
</div></div>

<div id="game4" class="screen"><div class="container">
  <h2>COPAYA ‚Äî Jeu A (√âlagage)</h2>
  <div class="map">
    <div class="location" onclick="openModal('Direction Copaya',4)"><img src="https://cdn-icons-png.flaticon.com/512/219/219986.png" alt="">Direction</div>
    <div class="location" onclick="openModal('Clients Copaya',4)"><img src="https://cdn-icons-png.flaticon.com/512/602/602220.png" alt="">Clients</div>
    <div class="location" onclick="openModal('Maintenance Copaya',4)"><img src="https://cdn-icons-png.flaticon.com/512/1995/1995525.png" alt="">Maintenance</div>
    <div class="location" onclick="openModal('Environnement Copaya',4)"><img src="https://cdn-icons-png.flaticon.com/512/1535/1535791.png" alt="">Environnement</div>
    <div class="location" onclick="openModal('S√©curit√© Copaya',4)"><img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="">S√©curit√©</div>
  </div>
  <div class="info-log" id="infoLog4"></div>
  <div style="margin-top:10px;display:flex;gap:.5rem;flex-wrap:wrap">
    <button class="btn" onclick="startBuilder(4,true)">R√©diger le cahier des charges</button>
    <button class="btn secondary" onclick="goTo('domain_reseau')">‚¨Ö Retour</button>
  </div>
</div></div>

<div id="game5" class="screen"><div class="container">
  <h2>COPAYA ‚Äî Jeu B (Raccordement HTA)</h2>
  <div class="map">
    <div class="location" onclick="openModal('Directrice Carl',5)"><img src="https://cdn-icons-png.flaticon.com/512/219/219986.png" alt="">La Directrice</div>
    <div class="location" onclick="openModal('√âquipe Carl',5)"><img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="">√âquipe</div>
    <div class="location" onclick="openModal('Manager Carl',5)"><img src="https://cdn-icons-png.flaticon.com/512/1995/1995525.png" alt="">Manager</div>
    <div class="location" onclick="openModal('Habitants Carl',5)"><img src="https://cdn-icons-png.flaticon.com/512/1484/1484825.png" alt="">Habitants</div>
    <div class="location" onclick="openModal('Juriste Carl',5)"><img src="https://cdn-icons-png.flaticon.com/512/2569/2569069.png" alt="">Juriste</div>
    <div class="location" onclick="openModal('Pr√©vention Carl',5)"><img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="">Pr√©vention</div>
  </div>
  <div class="info-log" id="infoLog5"></div>
  <div style="margin-top:10px;display:flex;gap:.5rem;flex-wrap:wrap">
    <button class="btn" onclick="startBuilder(5,true)">R√©diger le cahier des charges</button>
    <button class="btn secondary" onclick="goTo('domain_reseau')">‚¨Ö Retour</button>
  </div>
</div></div>

<div id="game6" class="screen"><div class="container">
  <h2>TILESA ‚Äî Jeu B (V√©hicules √âlectriques)</h2>
  <div class="map">
    <div class="location" onclick="openModal('Direction Tilesa B',6)"><img src="https://cdn-icons-png.flaticon.com/512/219/219986.png" alt="">Direction</div>
    <div class="location" onclick="openModal('Juriste Tilesa B',6)"><img src="https://cdn-icons-png.flaticon.com/512/2569/2569069.png" alt="">Juriste</div>
    <div class="location" onclick="openModal('Manager Tilesa B',6)"><img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="">Manager</div>
    <div class="location" onclick="openModal('Services Tilesa B',6)"><img src="https://cdn-icons-png.flaticon.com/512/1484/1484825.png" alt="">Services</div>
    <div class="location" onclick="openModal('Technique Tilesa B',6)"><img src="https://cdn-icons-png.flaticon.com/512/1995/1995525.png" alt="">Technique</div>
    <div class="location" onclick="openModal('Environnement Tilesa B',6)"><img src="https://cdn-icons-png.flaticon.com/512/1535/1535791.png" alt="">Responsable environnement</div>
  </div>
  <div class="info-log" id="infoLog6"></div>
  <div style="margin-top:10px;display:flex;gap:.5rem;flex-wrap:wrap">
    <button class="btn" onclick="startBuilder(6,true)">R√©diger le cahier des charges</button>
    <button class="btn secondary" onclick="goTo('domain_tertiaire')">‚¨Ö Retour</button>
  </div>
</div></div>

<!-- MODALE -->
<div class="overlay" id="overlay" onclick="closeModal()"></div>
<div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <h3 id="modalTitle"></h3>
  <img id="modalImage" src="" alt="Illustration">
  <p id="modalText"></p>
  <div style="display:flex;gap:.5rem;margin-top:.7rem">
    <button class="btn" onclick="collectInfo()">Collecter l'information</button>
    <button class="btn secondary" onclick="closeModal()">Retour</button>
  </div>
</div>

<!-- BUILDERS (QCM) -->
<div id="builder" class="screen"><div class="container" id="builderContainer"></div></div>
<div id="summary" class="screen"><div class="container" id="summaryContainer"></div></div>

<script>
/* ---------- Donn√©es modales (textes) ---------- */
const data1={'Direction':{text:"La sant√© et la s√©curit√© sont nos priorit√©s.",image:"images/tilesia_direction.png"},'Technique':{text:"Intervention pendant les heures ouvrables. Consommables √† la charge du prestataire : papier, savon, sacs, d√©sodorisants.",image:"images/tilesia_technique.png"},'Salaries':{text:"300 salari√©s, 4100 m¬≤ sur 4 √©tages.",image:"images/tilesia_salaries.png"},'Juridique':{text:"D√©cret 92-158 du 20/02/1992 ‚Äì articles R.237-1 √† R.237-28.",image:"images/tilesia_juridique.png"}};
const data2={'Direction':{text:"LESATI : priorit√© service public et proximit√©.",image:"images/direction_directrice_LESATI.png"},'Service production':{text:"3 groupes 800 kVA diesel ‚Äî certifs Ultra & ISO 9001.",image:"images/production_groupes_LESATI.png"},'Salaries':{text:"30 salari√©s investis.",image:"images/salaries_30_LESATI.png"},'Juridique':{text:"Garantie technique. Environnement humide/chaud.",image:"images/juridique_garantie_LESATI.png"}};
const data3={'Direction B':{text:"Barrage au Sinnamary (Petit Saut).",image:"images/direction_LESATI_B.png"},'Manager':{text:"Fourniture √©quipements pour exploitation/maintenance.",image:"images/manager_LESATI_B.png"},'Maintenance':{text:"Pompes, moteurs, capteurs, etc. + livrables.",image:"images/maintenance_LESATI_B.png"},'Juridique B':{text:"Garantie 24 mois min ou 30 mois post-livraison.",image:"images/juridique_LESATI_B.png"},'S√©curit√©':{text:"Livraisons Lun‚ÄìVen 08h‚Äì12h, adressage et protections.",image:"images/securite_LESATI_B.png"}};
const data4={'Direction Copaya':{text:"√âlagage = continuit√© d'alimentation.",image:"images/copaya_direction.png"},'Clients Copaya':{text:"Obligations propri√©taires, AIPR.",image:"images/clients_copaya.png"},'Maintenance Copaya':{text:"405 km HTA, 250 km HTB, 100 pieds.",image:"images/copaya_maintenance.png"},'Environnement Copaya':{text:"Zones prot√©g√©es & feux, r√©glementation.",image:"images/copaya_environnement.png"},'S√©curit√© Copaya':{text:"EPC/EPI + balisage.",image:"images/copaya_securite.png"}};
const data5={'Directrice Carl':{text:"Importance strat√©gique et d√©lais (avant pluies).",image:"images/copaya_directrice.png"},'√âquipe Carl':{text:"Planning pour FDO, outil de communication, chambres de tirage.",image:"images/copaya_equipe.png"},'Manager Carl':{text:"20 km HTA, 15 km FO, 60 bo√Ætes, fourreaux, armoire et dalle.",image:"images/copaya_manager.png"},'Habitants Carl':{text:"Attentes fortes, nuisances minimis√©es.",image:"images/copaya_habitants.png"},'Juriste Carl':{text:"DGTM + d√©cret 2011-12, IC/OL, d√©clarations.",image:"images/copaya_juriste.png"},'Pr√©vention Carl':{text:"Balisage, c√¥nes, panneaux, gyrophares.",image:"images/copaya_prevention.png"}};
const data6={'Direction Tilesa B':{text:"Electrification partielle de la flotte (30%).",image:"images/direction.png"},'Manager Tilesa B':{text:"Fourniture, livraison multi-sites, formation, SAV.",image:"images/manager.png"},'Services Tilesa B':{text:"Besoins par service (r√©seau, client√®le, finance).",image:"images/services.png"},'Technique Tilesa B':{text:"Acheminement, douanes, immat., √©quipements.",image:"images/technique.png"},'Juriste Tilesa B':{text:"Cadre europ√©en 2035, batteries.",image:"images/juriste.png"},'Environnement Tilesa B':{text:"Objectifs CO‚ÇÇ, confort, contraintes territoriales.",image:"images/responsable_environnement.png"}};

let currentGame=0,currentKey='';const sets={1:new Set(),2:new Set(),3:new Set(),4:new Set(),5:new Set(),6:new Set()};

function openModal(key,game){
  currentGame=game; currentKey=key;
  const src= game===2?data2 : game===3?data3 : game===4?data4 : game===5?data5 : game===6?data6 : data1;
  const it=src[key];
  document.getElementById('modalTitle').textContent=key.replace(' Tilesa B','').replace(' B','').replace(' Copaya','').replace(' Carl','');
  document.getElementById('modalImage').src=it.image;
  document.getElementById('modalText').textContent=it.text;
  document.getElementById('overlay').classList.add('active');
  document.getElementById('modal').classList.add('active');
}
function closeModal(){document.getElementById('overlay').classList.remove('active');document.getElementById('modal').classList.remove('active');}
function collectInfo(){const set=sets[currentGame]; set.add(currentKey); const el=document.getElementById('infoLog'+currentGame); if(el) el.textContent="Infos collect√©es : "+Array.from(set).join(', ');}

/* ----------------------- QCM builder (9 onglets stricts, aides identiques) ----------------------- */
const helpByStep = {
  objet: "D√©finir l‚Äôobjet du cahier des charges (rien d‚Äôautre).",
  contexte: "Situer le contexte (enjeux, historique, politique d‚Äôentreprise).",
  definition: "D√©crire pr√©cis√©ment la prestation et sa volum√©trie.",
  limites_titulaire: "Ce qui est explicitement √† la charge du Titulaire.",
  limites_entreprise: "Ce qui reste √† la charge de l‚Äôentreprise.",
  qualite: "Exigences de qualit√©, normes, tra√ßabilit√©.",
  conditions: "Acc√®s, s√©curit√©, d√©lais, pr√©cautions.",
  resultats: "R√©sultats mesurables et contr√¥lables.",
  reception_ref: "Crit√®res, livrables et modalit√©s de r√©ception."
};

// === Contenu EXACT selon vos consignes ===
function stepsFor(gameId){
  switch(gameId){
    case 4: // COPAYA A ‚Äî √âlagage
      return [
        {id:"objet",label:"Objet",help:helpByStep.objet,options:[
          "√âlagage de la v√©g√©tation autour des ouvrages √©lectriques HTA/HTB",
          "Maintenance pr√©ventive des lignes issues du poste √âtoile jusqu‚Äôau poste Margot",
          "R√©alisation d‚Äôune visite pr√©alable avec COPAYA avant les travaux",
          "Fourniture d‚Äô√©quipements √©lectriques haute tension",
          "Construction d‚Äôun nouveau poste √©lectrique"
        ]},
        {id:"contexte",label:"Contexte",help:helpByStep.contexte,options:[
          "Pousse rapide de la v√©g√©tation en Guyane",
          "Risques de coupures intempestives pour la client√®le",
          "Risques de s√©curit√© pour les tiers",
          "Modernisation des r√©seaux fibre optique",
          "Projet li√© √† l‚Äôaugmentation des besoins touristiques"
        ]},
        {id:"definition",label:"D√©finition de la prestation",help:helpByStep.definition,options:[
          "√âlagage manuel",
          "√âlagage au bulldozer",
          "√âlagage au gyrobroyeur",
          "Gestion des acc√®s aux pieds de support",
          "Pose de c√¢bles HTA",
          "405 km √† √©laguer sur le r√©seau HTA",
          "250 km √† √©laguer sur le r√©seau HTB",
          "100 pieds de support + acc√®s"
        ]},
        {id:"limites_titulaire",label:"Limites √† la charge du titulaire",help:helpByStep.limites_titulaire,options:[
          "Organiser les moyens humains et mat√©riels n√©cessaires",
          "R√©aliser l‚Äô√©lagage et l‚Äôacc√®s aux pieds de support",
          "Transmettre un planning apr√®s la visite pr√©alable avec COPAYA"
        ]},
        {id:"limites_entreprise",label:"Limites √† la charge de l‚Äôentreprise",help:helpByStep.limites_entreprise,options:[
          "Fourniture des plans et proc√©dures d'acc√®s",
          "Accompagnement lors de la visite pr√©alable",
          "Fourniture du personnel d‚Äô√©lagage",
          "Mise √† disposition du mat√©riel d‚Äôascension"
        ]},
        {id:"qualite",label:"Qualit√©",help:helpByStep.qualite,options:[
          "Photos avant / apr√®s intervention",
          "Rapport pr√©cis de chaque zone √©lagu√©e",
          "Respect du d√©cret du 20 f√©vrier 1992",
          "Certification ISO obligatoire"
        ]},
        {id:"conditions",label:"Conditions d‚Äôintervention",help:helpByStep.conditions,options:[
          "Interventions pr√©f√©rentiellement entre 6h30 et 17h",
          "DT-DICT envoy√©e 15 jours avant travaux",
          "Inspection commune pr√©alable obligatoire",
          "Travaux en zone prot√©g√©e soumis √† r√©glementation environnementale",
          "Travaux uniquement la nuit",
          "Intervention sans pr√©venir COPAYA"
        ]},
        {id:"resultats",label:"R√©sultats attendus",help:helpByStep.resultats,options:[
          "Continuit√© de l‚Äôalimentation √©lectrique",
          "Suppression des risques de court-circuit d√ª aux v√©g√©taux",
          "Diminution des coupures intempestives",
          "Installation de nouveaux √©quipements HTA"
        ]},
        {id:"reception_ref",label:"R√©ception",help:helpByStep.reception_ref,options:[
          "Signature d‚Äôun rapport de visite pr√©alable par les deux parties",
          "COPAYA peut refuser un chantier non conforme",
          "Photos justificatives obligatoires pour validation",
          "R√©ception automatique sans contr√¥le"
        ]}
      ];
    case 5: // COPAYA B ‚Äî Raccordement HTA
      return [
        {id:"objet",label:"Objet",help:helpByStep.objet,options:[
          "Raccordement au r√©seau √©lectrique d'un village situ√© en Guyane Fran√ßaise",
          "R√©alisation de fouilles et de dalles de propret√©",
          "Stabilisation du r√©seau √©lectrique pour les habitants",
          "Respect des normes HTA et DT/DICT"
        ]},
        {id:"contexte",label:"Contexte",help:helpByStep.contexte,options:[
          "Projet prioritaire pour maintenir le service public d‚Äô√©lectricit√©",
          "Limiter les nuisances et finaliser les travaux avant la saison des pluies",
          "Attentes fortes des habitants concernant la qualit√© du r√©seau",
          "Projet pr√©vu uniquement pour augmenter la capacit√© de production locale"
        ]},
        {id:"definition",label:"D√©finition de la prestation",help:helpByStep.definition,options:[
          "Mise en souterrain de 20 km de r√©seau HTA et 15 km de fibre optique",
          "Installation et mise en service d‚Äôarmoires √©lectriques & raccordements HTA",
          "Confection de 60 bo√Ætes de jonction HTA et fourniture/pose de fourreaux",
          "Travaux de d√©boisement et construction de logements temporaires"
        ]},
        {id:"limites_titulaire",label:"Limites √† la charge du titulaire",help:helpByStep.limites_titulaire,options:[
          "R√©alisation des fouilles et dalle de propret√©",
          "Raccordement, √©tiquetage c√¢bles HTA et transmission chambres de tirage",
          "Respect du balisage, panneaux, gyrophare et s√©curit√© chantier",
          "Fourniture des c√¢bles et des bo√Ætes de jonction"
        ]},
        {id:"limites_entreprise",label:"Limites √† la charge de l‚Äôentreprise",help:helpByStep.limites_entreprise,options:[
          "Fourniture des c√¢bles",
          "Fourniture des bo√Ætes de jonction",
          "Mise √† disposition d‚Äôun local de stockage",
          "Fourniture des chambres de tirage"
        ]},
        {id:"qualite",label:"Qualit√©",help:helpByStep.qualite,options:[
          "Travaux r√©alis√©s dans les d√©lais pour √©viter la saison des pluies",
          "Respect des normes techniques HTA et DT/DICT",
          "Limitation des nuisances (bruit, circulation)",
          "Interventions uniquement de nuit pour limiter les impacts urbains"
        ]},
        {id:"conditions",label:"Conditions d‚Äôintervention",help:helpByStep.conditions,options:[
          "Transmission d‚Äôun planning permettant d‚Äô√©tablir la FDO",
          "Visites r√©guli√®res de pr√©vention s√©curit√© organis√©es par COPAYA",
          "Communication via l‚Äôoutil COPAYA d√©di√©",
          "Intervention uniquement durant les week-ends"
        ]},
        {id:"resultats",label:"R√©sultats attendus",help:helpByStep.resultats,options:[
          "R√©seau souterrain op√©rationnel et fiable pour les habitants",
          "Stabilisation du r√©seau et r√©duction du risque de coupures",
          "Travaux conformes aux prescriptions r√©glementaires et techniques",
          "Production d‚Äô√©lectricit√© accrue dans la r√©gion"
        ]},
        {id:"reception_ref",label:"R√©ception",help:helpByStep.reception_ref,options:[
          "Contr√¥le des travaux par COPAYA",
          "R√©ception apr√®s conformit√© r√©glementaire DGTM & IC/OL",
          "V√©rification des installations HTA et fibre avant mise en service",
          "R√©ception automatique apr√®s fin de chantier"
        ]}
      ];
    case 6: // TILESA B ‚Äî Flotte VE
      return [
        {id:"objet",label:"Objet",help:helpByStep.objet,options:[
          "Achat de v√©hicules √©lectriques neufs pour renouveler la flotte de Tilesa",
          "Remplacement des bornes de recharge existantes",
          "Achat de v√©los √©lectriques pour les √©quipes",
          "Maintenance du r√©seau fibre optique"
        ]},
        {id:"contexte",label:"Contexte",help:helpByStep.contexte,options:[
          "Tilesa souhaite √©lectrifier sa flotte pour r√©duire son impact environnemental",
          "Tilesa souhaite uniquement augmenter la vitesse de ses v√©hicules",
          "La flotte actuelle est d√©j√† 100% √©lectrique",
          "Le projet r√©pond aux engagements climatiques europ√©ens"
        ]},
        {id:"definition",label:"D√©finition de la prestation",help:helpByStep.definition,options:[
          "Fourniture de v√©hicules √©lectriques adapt√©s √† la Guyane",
          "Livraison sur plusieurs sites (Cayenne, Kourou, Saint-Laurent‚Ä¶)",
          "Formation des utilisateurs √† la conduite des VE",
          "Achat de v√©hicules thermiques hybrides rechargeables uniquement"
        ]},
        {id:"limites_titulaire",label:"Limites √† la charge du titulaire",help:helpByStep.limites_titulaire,options:[
          "Acheminement jusqu'en Guyane, douane & livraison finale",
          "Formalit√©s d'immatriculation locale",
          "Service apr√®s-vente local ou agr√©√©",
          "Assurance des v√©hicules"
        ]},
        {id:"limites_entreprise",label:"Limites √† la charge de l‚Äôentreprise",help:helpByStep.limites_entreprise,options:[
          "Mise √† disposition des emplacements & stationnement",
          "Assurance des v√©hicules",
          "Installation des bornes de recharge",
          "Fourniture des v√©hicules thermiques de secours"
        ]},
        {id:"qualite",label:"Qualit√©",help:helpByStep.qualite,options:[
          "V√©hicules adapt√©s au climat et aux routes locales",
          "Documentation compl√®te & garanties",
          "Pas besoin de SAV local",
          "V√©hicules test√©s avant livraison"
        ]},
        {id:"conditions",label:"Conditions d‚Äôintervention",help:helpByStep.conditions,options:[
          "Livraison uniquement en jours ouvr√©s",
          "V√©rification fonctionnelle √† la r√©ception",
          "Livraison libre sans prise de rendez-vous",
          "Livraison uniquement sur Cayenne"
        ]},
        {id:"resultats",label:"R√©sultats attendus",help:helpByStep.resultats,options:[
          "R√©duction mesurable des √©missions CO‚ÇÇ",
          "Am√©lioration du confort des utilisateurs",
          "Fonctionnement optimal malgr√© contraintes territoriales",
          "R√©duction du nombre de sites op√©rationnels"
        ]},
        {id:"reception_ref",label:"R√©ception",help:helpByStep.reception_ref,options:[
          "Remise de la documentation compl√®te",
          "V√©rification fonctionnelle & premi√®re charge",
          "Acceptation automatique sans contr√¥le",
          "Enregistrement administratif conforme"
        ]}
      ];
    case 3: // LESATI B ‚Äî Centrale Hydraulique
      return [
        {id:"objet",label:"Objet",help:helpByStep.objet,options:[
          "Fourniture d‚Äô√©quipements destin√©s √† l‚Äôexploitation et √† la maintenance d‚Äôune centrale hydraulique",
          "Achat de pompes et de moteurs",
          "Maintenance de la centrale hydraulique",
          "Achat d'√©quipements pour centrale de production"
        ]},
        {id:"contexte",label:"Contexte",help:helpByStep.contexte,options:[
          "Le barrage de Petit Saut a √©t√© construit au niveau du fleuve Sinnamary",
          "La mise en service a eu lieu en 1994",
          "La retenue d‚Äôeau de 310 km¬≤ alimente deux tiers des foyers du littoral",
          "Ce projet concerne une installation industrielle hors Guyane"
        ]},
        {id:"definition",label:"D√©finition de la prestation",help:helpByStep.definition,options:[
          "Fourniture de pi√®ces de rechange pour pompe et √©quipements hydrauliques",
          "Fourniture des √©quipements conformes aux normes en vigueur",
          "Fourniture de syst√®mes d‚Äôair conditionn√©",
          "Fourniture d‚Äô√©quipements pour centrale photovolta√Øque"
        ]},
        {id:"limites_titulaire",label:"Limites √† la charge du titulaire",help:helpByStep.limites_titulaire,options:[
          "Remplacement ou r√©paration en cas de d√©faillance",
          "Livraison dans les conditions sp√©cifi√©es",
          "Pr√©venir l‚Äôentreprise 21 jours avant la livraison",
          "Fourniture des documents techniques",
          "Le titulaire peut livrer sans emballage"
        ]},
        {id:"limites_entreprise",label:"Limites √† la charge de l‚Äôentreprise",help:helpByStep.limites_entreprise,options:[
          "Le transport et le d√©chargement sont √† la charge du titulaire",
          "L‚Äôentreprise prend en charge le d√©chargement des colis",
          "L‚Äôentreprise g√®re l'assurance transport",
          "L‚Äôentreprise fournit les pi√®ces si n√©cessaire"
        ]},
        {id:"qualite",label:"Qualit√©",help:helpByStep.qualite,options:[
          "Certificats de conformit√©",
          "Notices techniques",
          "Plans d‚Äôinstallation si n√©cessaire",
          "Rapport d‚Äôessais",
          "Aucune documentation fournie"
        ]},
        {id:"conditions",label:"Conditions d‚Äôintervention",help:helpByStep.conditions,options:[
          "Livraison du lundi au vendredi de 08h00 √† 12h00",
          "Livraison possible uniquement de nuit",
          "Emballage avec protection contre l'humidit√© et les chocs",
          "√âtiquetage clair et de r√©f√©rence"
        ]},
        {id:"resultats",label:"R√©sultats attendus",help:helpByStep.resultats,options:[
          "Mat√©riels fonctionnels conformes aux sp√©cifications",
          "Documentation compl√®te remise",
          "Audit environnemental r√©alis√©",
          "Remplacement automatique des √©quipements au bout d‚Äôun an"
        ]},
        {id:"reception_ref",label:"R√©ception",help:helpByStep.reception_ref,options:[
          "Contr√¥le technique des √©quipements",
          "Possibilit√© de refus si colis non conforme",
          "R√©ception automatique sans contr√¥le",
          "D√©chargement effectu√© par le transporteur"
        ]}
      ];
    case 1: // TILESA A ‚Äî Nettoyage
      return [
        {id:"objet",label:"Objet",help:helpByStep.objet,options:[
          "Prestation de nettoyage int√©rieur des locaux du site TILESIA",
          "P√©rim√®tre: bureaux, circulation, escaliers, ascenseur, sanitaires, vestiaires, r√©fectoires",
          "Objectif: propret√©, hygi√®ne et confort des utilisateurs"
        ]},
        {id:"contexte",label:"Contexte",help:helpByStep.contexte,options:[
          "B√¢timent R+3, 4100 m¬≤, ~300 salari√©s",
          "La politique sant√© s√©curit√© est un enjeu majeur pour l‚Äôentreprise",
          "Locaux √©lectriques accompagn√©s par personnel habilit√©"
        ]},
        {id:"definition",label:"D√©finition de la prestation",help:helpByStep.definition,options:[
          "Nettoyage des sols (aspiration, balayage humide, lavage)",
          "D√©poussi√©rage des surfaces et mobiliers",
          "D√©sinfection des points de contact",
          "Sanitaires: nettoyage, d√©sinfection et r√©assort"
        ]},
        {id:"limites_titulaire",label:"Limites √† la charge du titulaire",help:helpByStep.limites_titulaire,options:[
          "Approvisionnement consommables: papier toilette, essuie-mains, savon mains, sacs poubelles, d√©sodorisants",
          "Fourniture mat√©riels et produits de nettoyage",
          "Avis de passage apr√®s intervention"
        ]},
        {id:"limites_entreprise",label:"Limites √† la charge de l‚Äôentreprise",help:helpByStep.limites_entreprise,options:[
          "Mise √† disposition des locaux d‚Äôentretien et points d‚Äôeau",
          "Accompagnement zones √©lectriques par agents habilit√©s",
          "Acc√®s / badges / consignes de s√©curit√©"
        ]},
        {id:"qualite",label:"Qualit√©",help:helpByStep.qualite,options:[
          "Plan qualit√© et fiches techniques produits",
          "Tra√ßabilit√© des interventions (registre / app)",
          "Indicateurs de propret√© et plan d‚Äôam√©lioration"
        ]},
        {id:"conditions",label:"Conditions d‚Äôintervention",help:helpByStep.conditions,options:[
          "Respect s√©curit√© / environnement (tri, stockage produits)",
          "Signalisation des zones en intervention",
          "Interventions en heures ouvrables",
          "D√©cret 92-158 & C. travail (R.237-1 √† R.237-28), normes d‚Äôhygi√®ne"
        ]},
        {id:"resultats",label:"R√©sultats attendus",help:helpByStep.resultats,options:[
          "Sols propres sans traces visibles",
          "Sanitaires propres, d√©sinfect√©s et r√©approvisionn√©s",
          "Mobilier d√©poussi√©r√©, points de contact d√©sinfect√©s"
        ]},
        {id:"reception_ref",label:"R√©ception",help:helpByStep.reception_ref,options:[
          "Rapport semestriel r√©dig√© par le service technique",
          "Proc√®s-verbal sign√© et dat√© par les deux parties",
          "R√©f√©rences: D√©cret 92-158 & C. travail (R.237-1 √† R.237-28), normes d‚Äôhygi√®ne"
        ]}
      ];
    default: return [];
  }
}

// === Cl√©s de r√©ponses (indices OK) selon votre marquage ===
const answerKeys = {
  4: { // COPAYA A
    objet:[0,1,2], contexte:[0,1,2], definition:[0,1,2,3,5,6,7], limites_titulaire:[0,1,2],
    limites_entreprise:[0,1], qualite:[0,1,2], conditions:[0,1,2,3], resultats:[0,1,2], reception_ref:[0,1,2]
  },
  5: { // COPAYA B
    objet:[0], contexte:[0,1,2], definition:[0,1,2], limites_titulaire:[0,1,2], limites_entreprise:[0,1,2],
    qualite:[0,1,2], conditions:[0,1,2], resultats:[0,1,2], reception_ref:[0,1,2]
  },
  6: { // TILESA B
    objet:[0], contexte:[0,3], definition:[0,1,2], limites_titulaire:[0,1,2], limites_entreprise:[0,1,2],
    qualite:[0,1,3], conditions:[0,1], resultats:[0,1,2], reception_ref:[0,1,3]
  },
  3: { // LESATI B
    objet:[0], contexte:[0,1,2], definition:[0,1], limites_titulaire:[0,1,2,3], limites_entreprise:[0],
    qualite:[0,1,2,3], conditions:[0,2,3], resultats:[0,1], reception_ref:[0,1,3]
  },
  1: { // TILESA A
    objet:[0], contexte:[0,1], definition:[0,1,2,3], limites_titulaire:[0,1], limites_entreprise:[0,1,2],
    qualite:[0,1,2], conditions:[0,1,2,3], resultats:[0,1,2], reception_ref:[0,1,2]
  }
};

function startBuilder(gameId, reset){
  const steps = stepsFor(gameId);
  if(!steps.length){ alert("Assistant indisponible pour ce jeu."); return; }

  const container=document.getElementById('builderContainer');
  if(reset){ container.innerHTML=''; }

  const titles={1:"TILESA ‚Äî Jeu A",3:"LESATI ‚Äî Jeu B",4:"COPAYA ‚Äî Jeu A",5:"COPAYA ‚Äî Jeu B",6:"TILESA ‚Äî Jeu B"};
  container.innerHTML = `<h2>${titles[gameId]} ‚Äî Assistant (QCM)</h2>
    <div class="small">Cochez les affirmations correctes (OK) et √©vitez les FAUX.</div>
    <div class="progress"><span id="builderProgress"></span></div>
    <div class="tabs" id="builderTabs"></div>
    <div id="builderPanels"></div>
    <div class="warn" id="builderWarn">Veuillez s√©lectionner au moins un √©l√©ment dans cet onglet pour continuer.</div>
    <div class="step-actions" style="display:flex;gap:.5rem;justify-content:space-between;margin-top:1rem;flex-wrap:wrap">
      <div style="display:flex;gap:.5rem;flex-wrap:wrap">
        <button class="btn secondary" id="prevStep">‚óÄ Pr√©c√©dent</button>
        <button class="btn secondary" onclick="goTo('home')">üè† Retour accueil</button>
      </div>
      <div style="display:flex;gap:.5rem;flex-wrap:wrap">
        <button class="btn secondary" onclick="goTo('game'+gameId)">Sauvegarder & Revenir √† la carte</button>
        <button class="btn" id="nextStep">Suivant ‚ñ∂</button>
        <button class="btn" id="finishBuilder" style="display:none">G√©n√©rer le r√©sum√©</button>
      </div>
    </div>`;

  // selections state
  window._builderSelections = {}; window._builderIndex=0;

  // tabs & panels
  const tabs=document.getElementById('builderTabs');
  const panels=document.getElementById('builderPanels');
  steps.forEach((s,i)=>{
    const b=document.createElement('button'); b.className='tab-btn'+(i===0?' active':''); b.textContent=`${i+1}. ${s.label}`; b.onclick=()=>goStep(i,steps.length); tabs.appendChild(b);
    const p=document.createElement('div'); p.className='tab-panel'+(i===0?' active':''); p.id=`panel-${s.id}`;
    p.innerHTML=`
      <h3>${i+1}. ${s.label}</h3>
      <div class="help"><details><summary>Aide (facultatif)</summary><p>${s.help||""}</p></details></div>
      <div class="helper">S√©lectionnez les √©l√©ments <strong>corrects</strong> pour votre CCTP.</div>
      <div class="option-grid">
        ${s.options.map((opt,idx)=>`
          <div class="option"><label><input type="checkbox" data-step="${s.id}" data-opt="${idx}"> ${opt}</label></div>
        `).join('')}
      </div>`;
    panels.appendChild(p);
  });
  panels.addEventListener('change',(e)=>{
    const box=e.target; if(box && box.type==='checkbox'){
      const stepId=box.dataset.step; const idx=Number(box.dataset.opt);
      if(!window._builderSelections[stepId]) window._builderSelections[stepId]=new Set();
      if(box.checked) window._builderSelections[stepId].add(idx); else window._builderSelections[stepId].delete(idx);
    }
  });
  document.getElementById('prevStep').onclick=()=>goStep(window._builderIndex-1,steps.length);
  document.getElementById('nextStep').onclick=()=>{
    if(!hasAtLeastOne(steps[window._builderIndex].id)){document.getElementById('builderWarn').style.display='block';return;}
    document.getElementById('builderWarn').style.display='none'; goStep(window._builderIndex+1,steps.length);
  };
  document.getElementById('finishBuilder').onclick=()=>{
    if(!hasAtLeastOne(steps[window._builderIndex].id)){document.getElementById('builderWarn').style.display='block';return;}
    document.getElementById('builderWarn').style.display='none'; finishBuilder(gameId, steps);
  };
  goStep(0,steps.length);
  goTo('builder');
}
function hasAtLeastOne(stepId){const set=window._builderSelections[stepId];return set && set.size>0;}
function goStep(i,total){
  if(i<0||i>=total) return; window._builderIndex=i;
  [...document.querySelectorAll('#builderTabs .tab-btn')].forEach((b,k)=>b.classList.toggle('active',k===i));
  [...document.querySelectorAll('#builderPanels .tab-panel')].forEach(p=>p.classList.remove('active'));
  const activeId=document.querySelectorAll('#builderPanels .tab-panel')[i].id;
  document.getElementById(activeId).classList.add('active');
  const pct=Math.round((i)/(total-1)*100); document.getElementById('builderProgress').style.width=pct+'%';
  document.getElementById('prevStep').disabled=(i===0);
  document.getElementById('nextStep').style.display=(i===total-1)?'none':'inline-block';
  document.getElementById('finishBuilder').style.display=(i===total-1)?'inline-block':'none';
}

// Nouvelle √©chelle: D√©butant (0‚Äì49), Avanc√© (50‚Äì74), Expert (75‚Äì89), G√©nie (‚â•90)
function levelBadge(pct){
  if(pct < 50) return {label:"D√©butant",cls:"debutant"};
  if(pct < 75) return {label:"Avanc√©",cls:"avance"};
  if(pct < 90) return {label:"Expert",cls:"expert"};
  return {label:"G√©nie",cls:"genie"};
}

function finishBuilder(gameId, steps){
  let html='<h2>R√©sum√© ‚Äî '+({1:"TILESA ‚Äî Jeu A",3:"LESATI ‚Äî Jeu B",4:"COPAYA ‚Äî Jeu A",5:"COPAYA ‚Äî Jeu B",6:"TILESA ‚Äî Jeu B"}[gameId])+'</h2>';
  steps.forEach((s,i)=>{
    const picked=[...(window._builderSelections[s.id]||[])].sort((a,b)=>a-b);
    if(picked.length){ html+=`<h4>${i+1}. ${s.label}</h4><ul>`; picked.forEach(idx=>html+=`<li>${s.options[idx]}</li>`); html+='</ul>'; }
  });
  if(html==='') html="<p>Aucun √©l√©ment s√©lectionn√©. Revenez dans l‚Äôassistant pour choisir vos options.</p>";

  // Score + erreurs d√©taill√©es (cliquable)
  const keyMap = answerKeys[gameId];
  let totalCorrect=0, selectedCorrect=0; const errors=[];
  for(const step of steps){
    const key=keyMap[step.id]||[]; totalCorrect+=key.length;
    const picked=window._builderSelections[step.id]?Array.from(window._builderSelections[step.id]):[];
    const ok=picked.filter(i=>key.includes(i));
    const wrong=picked.filter(i=>!key.includes(i));
    const missed=key.filter(i=>!picked.includes(i));
    selectedCorrect+=ok.length;
    if(wrong.length||missed.length){
      errors.push({label:step.label, wrong:wrong.map(i=>step.options[i]), missed:missed.map(i=>step.options[i])});
    }
  }
  const pct=totalCorrect?Math.round((selectedCorrect/totalCorrect)*100):0; const level=levelBadge(pct);
  html+=`<div class="score" style="display:block">Score : ${selectedCorrect} sur ${totalCorrect} (${pct}%) <span class="badge ${level.cls}">${level.label}</span></div>`;

  if(errors.length){
    html+=`<button class="btn toggle" id="toggleErrors">Voir mes fautes</button>`;
    html+=`<div class="errors" id="errorsPanel">`+errors.map(e=>{
      let block=`<div style="margin:.4rem 0">`;
      block+=`<h4>${e.label}</h4>`;
      if(e.wrong.length) block+=`<div style="color:#b91c1c"><strong>Choix FAUX :</strong><ul>${e.wrong.map(t=>`<li>${t}</li>`).join('')}</ul></div>`;
      if(e.missed.length) block+=`<div style="color:#92400e"><strong>R√©ponses OK non coch√©es :</strong><ul>${e.missed.map(t=>`<li>${t}</li>`).join('')}</ul></div>`;
      block+=`</div>`; return block;
    }).join('')+`</div>`;
  }

  html+=`<div style="display:flex; gap:.5rem; margin-top:12px; flex-wrap:wrap;">
      <button class="btn secondary" onclick="startBuilder(${gameId},true)">Modifier</button>
      <button class="btn" onclick="goTo('game${gameId}')">Retour √† la carte</button>
      <button class="btn secondary" onclick="goTo('home')">üè† Retour accueil</button>
    </div>`;
  const container=document.getElementById('summaryContainer');
  container.innerHTML=html;
  goTo('summary');
  const t=document.getElementById('toggleErrors'), panel=document.getElementById('errorsPanel');
  if(t && panel){ t.onclick=()=>{ panel.style.display=(panel.style.display==='none' || panel.style.display==='')?'block':'none'; t.textContent=panel.style.display==='none'?'Voir mes fautes':'Masquer mes fautes'; }; panel.style.display='none'; }
}
</script>
</body>
</html>
