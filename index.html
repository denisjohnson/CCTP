<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Plateforme CCTP — Domaines & Jeux (A/B) — Patch QCM Uniques</title>
<style>
  :root{--primary:#0a74da;--primary-dark:#095aba;--bg:#f4f7fb;--card:#fff;--text:#22324a}
  *{box-sizing:border-box}body{font-family:Arial,Helvetica,sans-serif;margin:0;background:var(--bg);color:var(--text)}
  .container{max-width:1100px;margin:0 auto;padding:clamp(16px,4vw,32px)}
  .screen{display:none;animation:fade .25s ease} .active{display:block}
  @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
  h1,h2,h3{margin:0 0 .8rem}
  .muted{color:#64748b}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem}
  .card{background:#fff;border-radius:14px;box-shadow:0 10px 26px rgba(0,0,0,.08);padding:1rem}
  .btn{padding:.7rem 1.1rem;background:#0a74da;color:#fff;border:none;border-radius:10px;font-weight:700;cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .btn:hover{background:#095aba}
  .btn.secondary{background:#e9eef5;color:#1b304a}
  .hero{width:100%;max-width:980px;border-radius:16px;box-shadow:0 10px 26px rgba(0,0,0,.08);display:block;margin:0 auto 12px;object-fit:contain;max-height:60vh}
  .map{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem;margin-top:1rem}
  .location{background:#fff;padding:1rem;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.06);text-align:center;cursor:pointer;transition:transform .15s ease,box-shadow .2s ease}
  .location:hover{transform:translateY(-2px);box-shadow:0 10px 22px rgba(0,0,0,.08)}
  .location img{width:48px;height:48px;margin-bottom:.5rem}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:999}
  .overlay.active{display:block}
  .modal{position:fixed;top:5%;left:50%;transform:translateX(-50%);background:#fff;padding:clamp(16px,3vw,24px);border-radius:14px;box-shadow:0 18px 50px rgba(0,0,0,.25);display:none;z-index:1000;width:min(92vw,820px);max-height:90vh;overflow:auto}
  .modal.active{display:block}
  .modal img{max-width:100%;max-height:40vh;object-fit:contain;display:block;margin:0 auto .6rem}
  .modal p{white-space:pre-wrap;line-height:1.35}
  .notice{background:#f8fafc;border:1px solid #d1d5db;border-radius:12px;padding:1rem;margin-top:1rem;display:none}
  .info-log{margin-top:.6rem;color:#0f7a31}
  /* Builder (QCM) */
  .tabs{display:flex;flex-wrap:wrap;gap:.5rem;margin-bottom:.8rem;}
  .tab-btn{padding:.45rem .7rem;border-radius:10px;border:1px solid #d8e0ea;background:#fff;cursor:pointer;font-size:.92rem;color:#213347;}
  .tab-btn.active{background:#0a74da;color:#fff;border-color:#0a74da;}
  .tab-panel{display:none;background:#fff;padding:1rem;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.06);}
  .tab-panel.active{display:block;}
  .progress{height:10px;background:#e9eef5;border-radius:999px;overflow:hidden;margin:10px 0 18px;}
  .progress>span{display:block;height:100%;background:#0a74da;width:0%;transition:width .25s ease;}
  .option-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:.75rem;margin-top:.75rem;}
  .option{border:1px solid #e6e6e6;border-radius:10px;padding:.75rem;background:#fafafa;}
  .option label{display:block;cursor:pointer;line-height:1.35;}
  .helper{font-size:.92rem;color:#526479;margin:.4rem 0 .1rem}
  .warn{color:#b54708;background:#fff7ed;padding:.5rem .75rem;border-radius:8px;border:1px solid #fde68a;display:none;margin-top:.5rem;}
  .summary{background:#fff;padding:1rem;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.06);}
  .score{margin-top:12px;background:#f0f9ff;border:1px solid #bae6fd;color:#0c4a6e;padding:.75rem 1rem;border-radius:12px;font-weight:600;display:none;}
  .badge{display:inline-block;padding:.35rem .6rem;border-radius:999px;font-size:.9rem;font-weight:700;margin-left:.5rem;}
  .badge.debutant{background:#fef2f2;color:#991b1b;border:1px solid #fecaca;}
  .badge.avance{background:#fff7ed;color:#b45309;border:1px solid #fed7aa;}
  .badge.expert{background:#ecfeff;color:#075985;border:1px solid #bae6fd;}
  .badge.genie{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0;}
  .toggle{margin-top:8px;background:#e9eef5;color:#22324a;}
</style>
</head>
<body>

<script>
(function () { // mini-router
  function show(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));(document.getElementById(id)||document.getElementById('home')).classList.add('active');window.scrollTo(0,0)}
  window.goTo=function(id){show(id); try{history.replaceState(null,'','#'+id)}catch(e){location.hash=id}};
  window.addEventListener('hashchange',()=>show((location.hash||'#home').slice(1)));
  show((location.hash||'#home').slice(1));
})();
</script>

<!-- ACCUEIL -->
<div id="home" class="screen active">
  <div class="container">
    <img class="hero" src="images/accueil_salle_formation.png" alt="">
    <h2>Choisissez votre domaine</h2>
    <div class="grid">
      <div class="card">
        <h3>Domaine Production</h3>
        <p class="muted">Jeux de l'entreprise LESATI (Thermique, Hydraulique, Smart Grids)</p>
        <button class="btn" onclick="goTo('domain_production')">Accéder</button>
      </div>
      <div class="card">
        <h3>Domaine Réseau</h3>
        <p class="muted">Jeux de l'entreprise COPAYA (Réseaux & Exploitation)</p>
        <button class="btn" onclick="goTo('domain_reseau')">Accéder</button>
      </div>
      <div class="card">
        <h3>Domaine Tertiaire</h3>
        <p class="muted">Jeux de l'entreprise TILESA (Tertiaire et Telecom)</p>
        <button class="btn" onclick="goTo('domain_tertiaire')">Accéder</button>
      </div>
    </div>
  </div>
</div>

<!-- DOMAINES -->
<div id="domain_production" class="screen"><div class="container">
  <h2>Domaine Production — LESATI</h2>
  <div class="grid">
    <div class="card">
      <h3>Jeu A — Centrale Thermique (Léa)</h3>
      <p class="muted">Centrale Thermique : explorez les services de la centrale thermique, puis rédigez le cahier des charges.</p>
      <button class="btn" onclick="goTo('game2_intro')">Lancer</button>
    </div>
    <div class="card">
      <h3>Jeu B — Centrale Hydraulique (Léon)</h3>
      <p class="muted">Centrale Hydraulique : explorez les services de la centrale hydraulique, puis rédigez le cahier des charges.</p>
      <button class="btn" onclick="goTo('game3_intro')">Lancer</button>
    </div>
  </div>
  <button class="btn secondary" onclick="goTo('home')">⬅ Retour</button>
</div></div>

<div id="domain_reseau" class="screen"><div class="container">
  <h2>Domaine Réseau — COPAYA</h2>
  <div class="grid">
    <div class="card">
      <h3>Jeu A — Élagage (Sylvie)</h3>
      <p class="muted">Élagage : explorez les services, puis rédigez le cahier des charges.</p>
      <button class="btn" onclick="goTo('game4_intro')">Lancer</button>
    </div>
    <div class="card">
      <h3>Jeu B — Raccordement HTA (Carl)</h3>
      <p class="muted">Raccordement HTA : explorez les services, puis rédigez le cahier des charges.</p>
      <button class="btn" onclick="goTo('game5_intro')">Lancer</button>
    </div>
  </div>
  <button class="btn secondary" onclick="goTo('home')">⬅ Retour</button>
</div></div>

<div id="domain_tertiaire" class="screen"><div class="container">
  <h2>Domaine Tertiaire — TILESA</h2>
  <div class="grid">
    <div class="card">
      <h3>Jeu A — Nettoyage des Sites (Alex)</h3>
      <p class="muted">Nettoyage des sites : Explorez les services, puis rédigez le cahier des charges.</p>
      <button class="btn" onclick="goTo('game1_intro')">Lancer</button>
    </div>
    <div class="card">
      <h3>Jeu B — Véhicules Électriques (Manon)</h3>
      <p class="muted">Véhicules Électriques : Explorez les services, puis rédigez le cahier des charges.</p>
      <button class="btn" onclick="goTo('game6_intro')">Lancer</button>
    </div>
  </div>
  <button class="btn secondary" onclick="goTo('home')">⬅ Retour</button>
</div></div>

<!-- INTROS -->
<div id="game1_intro" class="screen"><div class="container">
  <img class="hero" src="images/tilesia_accueil_alex.png" alt="">
  <h2>TILESA — Jeu A (Nettoyage des sites)</h2>
  <button class="btn" onclick="goTo('game1')">Démarrer</button>
  <button class="btn secondary" onclick="goTo('domain_tertiaire')">⬅ Retour</button>
</div></div>

<div id="game2_intro" class="screen"><div class="container">
  <img class="hero" src="images/lea_centrale_LESATI.png" alt="">
  <h2>LESATI — Jeu A (Centrale Thermique)</h2>
  <p>Léa, chargée d'affaires du service production, est volontaire pour réaliser l'expression du besoin. Il s'agit de l'achat de 3 nouveaux groupes électrogènes.</p>
  <button class="btn" onclick="goTo('game2')">Démarrer</button>
  <button class="btn secondary" onclick="goTo('domain_production')">⬅ Retour</button>
</div></div>

<div id="game3_intro" class="screen"><div class="container">
  <img class="hero" src="images/leon_centrale_LESATI.png" alt="">
  <h2>LESATI — Jeu B (Centrale Hydraulique)</h2>
  <p>Léon, nouveau chef de projet de la centrale hydraulique, est volontaire pour rédiger le cahier des charges concernant l’achat de pièces de rechange.</p>
  <button class="btn" onclick="goTo('game3')">Démarrer</button>
  <button class="btn secondary" onclick="goTo('domain_production')">⬅ Retour</button>
</div></div>

<div id="game4_intro" class="screen"><div class="container">
  <img class="hero" src="images/copaya_accueil.png" alt="">
  <h2>COPAYA — Jeu A (Élagage)</h2>
  <p>Vous incarnez Sylvie, chargée d’affaires au sein de l’entreprise Copaya. Vous avez pour objectif de rédiger le cahier des charges pour les prestations d’élagage. La consultation sera lancée dans 8 mois et vous souhaitez anticiper au maximum cette étape.</p>
  <button class="btn" onclick="goTo('game4')">Démarrer</button>
  <button class="btn secondary" onclick="goTo('domain_reseau')">⬅ Retour</button>
</div></div>

<div id="game5_intro" class="screen"><div class="container">
  <img class="hero" src="images/copaya_intro.png" alt="">
  <h2>COPAYA — Jeu B (Raccordement HTA)</h2>
  <p>Vous incarnez Carl, nouveau chargé d’affaires du service réseau. Vous êtes en charge de la rédaction d’un cahier des charges pour le raccordement HTA d’un village. La consultation sera lancée dans 9 mois et vous anticipez cette étape.</p>
  <button class="btn" onclick="goTo('game5')">Démarrer</button>
  <button class="btn secondary" onclick="goTo('domain_reseau')">⬅ Retour</button>
</div></div>

<div id="game6_intro" class="screen"><div class="container">
  <img class="hero" src="images/accueil_sabrina.png" alt="">
  <h2>TILESA — Jeu B (Véhicules Électriques)</h2>
  <p>Vous incarnez Manon, pilote de la maintenance des véhicules. Vous êtes en charge de la rédaction d’un cahier des charges pour l’achat de véhicules électriques neufs permettant de renouveler la flotte. La consultation sera lancée dans 9 mois et vous anticipez cette étape.</p>
  <button class="btn" onclick="goTo('game6')">Démarrer</button>
  <button class="btn secondary" onclick="goTo('domain_tertiaire')">⬅ Retour</button>
</div></div>

<!-- CARTES / JEUX -->
<div id="game1" class="screen"><div class="container">
  <h2>TILESA — Jeu A (Nettoyage des sites)</h2>
  <div class="map">
    <div class="location" onclick="openModal('Direction',1)"><img src="https://cdn-icons-png.flaticon.com/512/219/219986.png" alt="">Direction</div>
    <div class="location" onclick="openModal('Technique',1)"><img src="https://cdn-icons-png.flaticon.com/512/2621/2621140.png" alt="">Technique</div>
    <div class="location" onclick="openModal('Salaries',1)"><img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="">Salariés</div>
    <div class="location" onclick="openModal('Juridique',1)"><img src="https://cdn-icons-png.flaticon.com/512/2569/2569069.png" alt="">Juridique</div>
  </div>
  <div class="info-log" id="infoLog1"></div>
  <button class="btn secondary" onclick="goTo('domain_tertiaire')">⬅ Retour</button>
</div></div>

<div id="game2" class="screen"><div class="container">
  <h2>LESATI — Jeu A (Centrale Thermique)</h2>
  <div class="map">
    <div class="location" onclick="openModal('Direction',2)"><img src="https://cdn-icons-png.flaticon.com/512/219/219986.png" alt="">Direction</div>
    <div class="location" onclick="openModal('Service production',2)"><img src="https://cdn-icons-png.flaticon.com/512/1995/1995525.png" alt="">Service production</div>
    <div class="location" onclick="openModal('Salaries',2)"><img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="">Salariés</div>
    <div class="location" onclick="openModal('Juridique',2)"><img src="https://cdn-icons-png.flaticon.com/512/2569/2569069.png" alt="">Juridique</div>
  </div>
  <div class="info-log" id="infoLog2"></div>
  <button class="btn secondary" onclick="goTo('domain_production')">⬅ Retour</button>
  <button id="btnCCTP2" class="btn" style="display:none" onclick="document.getElementById('notice2').style.display='block'">Rédiger le cahier des charges</button>
  <div id="notice2" class="notice" style="display:none"><strong>Vous disposez de toutes les informations pour écrire un cahier des charges en 45 minutes.</strong></div>
</div></div>

<div id="game3" class="screen"><div class="container">
  <h2>LESATI — Jeu B (Centrale Hydraulique)</h2>
  <div class="map">
    <div class="location" onclick="openModal('Direction B',3)"><img src="https://cdn-icons-png.flaticon.com/512/219/219986.png" alt="">Direction</div>
    <div class="location" onclick="openModal('Manager',3)"><img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="">Manager</div>
    <div class="location" onclick="openModal('Maintenance',3)"><img src="https://cdn-icons-png.flaticon.com/512/1995/1995525.png" alt="">Maintenance</div>
    <div class="location" onclick="openModal('Juridique B',3)"><img src="https://cdn-icons-png.flaticon.com/512/2569/2569069.png" alt="">Juridique</div>
    <div class="location" onclick="openModal('Sécurité',3)"><img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="">Responsable sécurité</div>
  </div>
  <div class="info-log" id="infoLog3"></div>
  <div style="margin-top:10px;display:flex;gap:.5rem;flex-wrap:wrap">
    <button id="btnWrite3" class="btn" onclick="startBuilder(3,true)">Rédiger le cahier des charges</button>
    <button class="btn secondary" onclick="goTo('domain_production')">⬅ Retour</button>
  </div>
</div></div>

<div id="game4" class="screen"><div class="container">
  <h2>COPAYA — Jeu A (Élagage)</h2>
  <div class="map">
    <div class="location" onclick="openModal('Direction Copaya',4)"><img src="https://cdn-icons-png.flaticon.com/512/219/219986.png" alt="">Direction</div>
    <div class="location" onclick="openModal('Clients Copaya',4)"><img src="https://cdn-icons-png.flaticon.com/512/602/602220.png" alt="">Clients</div>
    <div class="location" onclick="openModal('Maintenance Copaya',4)"><img src="https://cdn-icons-png.flaticon.com/512/1995/1995525.png" alt="">Maintenance</div>
    <div class="location" onclick="openModal('Environnement Copaya',4)"><img src="https://cdn-icons-png.flaticon.com/512/1535/1535791.png" alt="">Environnement</div>
    <div class="location" onclick="openModal('Sécurité Copaya',4)"><img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="">Sécurité</div>
  </div>
  <div class="info-log" id="infoLog4"></div>
  <div style="margin-top:10px;display:flex;gap:.5rem;flex-wrap:wrap">
    <button id="btnWrite4" class="btn" onclick="startBuilder(4,true)">Rédiger le cahier des charges</button>
    <button class="btn secondary" onclick="goTo('domain_reseau')">⬅ Retour</button>
  </div>
</div></div>

<div id="game5" class="screen"><div class="container">
  <h2>COPAYA — Jeu B (Raccordement HTA)</h2>
  <div class="map">
    <div class="location" onclick="openModal('Directrice Carl',5)"><img src="https://cdn-icons-png.flaticon.com/512/219/219986.png" alt="">La Directrice</div>
    <div class="location" onclick="openModal('Équipe Carl',5)"><img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="">Équipe</div>
    <div class="location" onclick="openModal('Manager Carl',5)"><img src="https://cdn-icons-png.flaticon.com/512/1995/1995525.png" alt="">Manager</div>
    <div class="location" onclick="openModal('Habitants Carl',5)"><img src="https://cdn-icons-png.flaticon.com/512/1484/1484825.png" alt="">Habitants</div>
    <div class="location" onclick="openModal('Juriste Carl',5)"><img src="https://cdn-icons-png.flaticon.com/512/2569/2569069.png" alt="">Juriste</div>
    <div class="location" onclick="openModal('Prévention Carl',5)"><img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="">Prévention</div>
  </div>
  <div class="info-log" id="infoLog5"></div>
  <div style="margin-top:10px;display:flex;gap:.5rem;flex-wrap:wrap">
    <button id="btnWrite5" class="btn" onclick="startBuilder(5,true)">Rédiger le cahier des charges</button>
    <button class="btn secondary" onclick="goTo('domain_reseau')">⬅ Retour</button>
  </div>
</div></div>

<div id="game6" class="screen"><div class="container">
  <h2>TILESA — Jeu B (Véhicules Électriques)</h2>
  <div class="map">
    <div class="location" onclick="openModal('Direction Tilesa B',6)"><img src="https://cdn-icons-png.flaticon.com/512/219/219986.png" alt="">Direction</div>
    <div class="location" onclick="openModal('Juriste Tilesa B',6)"><img src="https://cdn-icons-png.flaticon.com/512/2569/2569069.png" alt="">Juriste</div>
    <div class="location" onclick="openModal('Manager Tilesa B',6)"><img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="">Manager</div>
    <div class="location" onclick="openModal('Services Tilesa B',6)"><img src="https://cdn-icons-png.flaticon.com/512/1484/1484825.png" alt="">Services</div>
    <div class="location" onclick="openModal('Technique Tilesa B',6)"><img src="https://cdn-icons-png.flaticon.com/512/1995/1995525.png" alt="">Technique</div>
    <div class="location" onclick="openModal('Environnement Tilesa B',6)"><img src="https://cdn-icons-png.flaticon.com/512/1535/1535791.png" alt="">Responsable environnement</div>
  </div>
  <div class="info-log" id="infoLog6"></div>
  <div style="margin-top:10px;display:flex;gap:.5rem;flex-wrap:wrap">
    <button id="btnWrite6" class="btn" onclick="startBuilder(6,true)">Rédiger le cahier des charges</button>
    <button class="btn secondary" onclick="goTo('domain_tertiaire')">⬅ Retour</button>
  </div>
</div></div>

<!-- MODALE -->
<div class="overlay" id="overlay" onclick="closeModal()"></div>
<div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <h3 id="modalTitle"></h3>
  <img id="modalImage" src="" alt="Illustration">
  <p id="modalText"></p>
  <div style="display:flex;gap:.5rem;margin-top:.7rem">
    <button class="btn" onclick="collectInfo()">Collecter l'information</button>
    <button class="btn secondary" onclick="closeModal()">Retour</button>
  </div>
</div>

<!-- BUILDERS (QCM) -->
<div id="builder" class="screen"><div class="container" id="builderContainer"></div></div>
<div id="summary" class="screen"><div class="container" id="summaryContainer"></div></div>

<script>
/* ---------- Données modales (textes exacts) ---------- */
/* TILESA A */
const data1={
  'Direction':{ text:"Le président vous accueille : « La santé et la sécurité sont mes priorités pour garantir le bon fonctionnement de l’entreprise et le bien-être des salariés. »", image:"images/tilesia_direction.png" },
  'Technique':{ text:`Intervention pendant les heures ouvrables, sauf cas exceptionnel. Pour les locaux électriques, le titulaire sera accompagné d'un employé disposant des habilitations requises.

Les espaces concernés sont les suivants : bureaux, couloirs, escaliers, ascenseur, sanitaires, vestiaires, réfectoires.

Le titulaire remplira un avis de passage. Le rapport semestriel sera rédigé par le service technique.

Les consommables à la charge du prestataire sont les suivants :
- Le papier toilette
- Le papier essuie-mains
- Le savon liquide à mains
- Les sacs poubelles
- Désodorisants.`, image:"images/tilesia_technique.png" },
  'Salaries':{ text:"Il y a 300 salariés dans le bâtiment répartis sur les 4 étages. Le bâtiment dispose d’une superficie de 4100 m². Vous observez une ambiance de coopération et de réunions dans les locaux.", image:"images/tilesia_salaries.png" },
  'Juridique':{ text:"La juriste rappelle les prescriptions du Décret 92-158 du 20 février 1992 reprises dans le Code du travail (articles R.237-1 et R.237-28), applicables aux travaux réalisés dans l’établissement par une entreprise extérieure.", image:"images/tilesia_juridique.png" }
};

/* LESATI A */
const data2={
  'Direction':{ text:'La directrice : "LESATI assure production, distribution et commercialisation à Saint Georges (800 clients). Priorité au service public et à la proximité client."', image:"images/direction_directrice_LESATI.png" },
  'Service production':{ text:'Certains groupes ont atteint leurs limites techniques (dépassement du nombre d’heures limites prévues par le constructeur) et devront être révisés. À ce stade, une révision serait plus onéreuse que l’achat de matériels neufs.', image:"images/production_groupes_LESATI.png" },
  'Salaries':{ text:"Les 30 salariés devant l’entrée du bâtiment principal. Ils sont pleinement investis dans le développement local et la relation client.", image:"images/salaries_30_LESATI.png" },
  'Juridique':{ text:"La juriste rappelle qu'il est indispensable d'ajouter une garantie technique lors de l'achat des 3 groupes électrogènes avec la livraison à Saint Georges. Les groupes seront utilisés en continu dans un milieu humide et chaud.", image:"images/juridique_garantie_LESATI.png" }
};

/* LESATI B */
const data3={
  'Direction B':{ text:`Pour répondre aux besoins énergétiques croissants de la Guyane au début des années 1980, le barrage a été construit au niveau d’un resserrement naturel du fleuve Sinnamary. Grâce à sa retenue d’eau, il alimente deux tiers des foyers du littoral guyanais.`, image:"images/direction_LESATI_B.png" },
  'Manager':{ text:`Ce cahier des charges a pour objet la fourniture d’équipements destinés à l’exploitation et à la maintenance d’une centrale hydraulique (Sinnamary). Ces équipements doivent répondre aux exigences de performance, de durabilité, et de conformité aux normes en vigueur.`, image:"images/manager_LESATI_B.png" },
  'Maintenance':{ text:`Les pièces de rechange sont utilisées sur les équipements suivants :

- Les pompes,
- Les moteurs électriques,
- Les kits de maintenance des pompes,
- Les capteurs analogiques et tout ou rien de niveaux, pressostats, manomètres, 
- Les filtres,
- Les clapets anti-retour,
- Les vannes manuelles et motorisées,
- Les actionneurs (ex. électrovannes).

Les livrables attendus sont les suivants :

- L’ensemble des équipements, accompagnés de leurs certificats de conformité, notices techniques, plans d'installation si nécessaire.
- Rapport d’essais.`, image:"images/maintenance_LESATI_B.png" },
  'Juridique B':{ text:`Le titulaire garantit les fournitures contre tout défaut de fabrication ou de matière pour une durée minimale de 24 mois à compter de la date de mise en service ou 30 mois après la livraison. En cas de défaillance, le remplacement ou la réparation des équipements sera pris en charge par le Titulaire.`, image:"images/juridique_LESATI_B.png" },
  'Sécurité':{ text:`Les équipements devront être livrés avec protections contre l’humidité et les chocs. Une étiquette claire indiquant le contenu et la référence doit être visible sur chaque caisse.

Adresse du site :
Centrale hydraulique de Sinnamary
97315 Sinnamary
Guyane Française

Horaires de livraison :
Du lundi au vendredi de 08h00 à 12h00`, image:"images/securite_LESATI_B.png" }
};

/* COPAYA A */
const data4={
  'Direction Copaya':{ text:`L'élagage est essentiel pour prévenir les coupures d'électricité et assurer la continuité de l'alimentation électrique des clients. Copaya supervise l'élagage des arbres à proximité des lignes électriques pour éviter les dommages sur le réseau.`, image:"images/copaya_direction.png" },
  'Clients Copaya':{ text:`Les propriétaires de terrain doivent veiller à l'entretien et à la taille régulière des arbres situés sur leurs propriétés, conformément à la réglementation. L’élagage à proximité des réseaux électriques doit être géré par des professionnels disposant d’une autorisation AIPR (Autorisation Intervention à Proximité des Réseaux). La pousse rapide de la végétation peut engendrer des problématiques de sécurité des tiers et également des coupures intempestives de la clientèle.`, image:"images/clients_copaya.png" },
  'Maintenance Copaya':{ text:`Distances attendues :

- 405 KM à élaguer par an sur le réseau HTA
- 250 KM à élaguer par an sur le réseau HTB
- 100 pieds de support par an + accès

Nous souhaitons un compte rendu précis de chaque zone élaguée. 
Le compte rendu est agrémenté de photos avant et après passage du Titulaire.

Les procédures d’accès et les plans seront fournis par Copaya.
Les documents d’accès sont de la responsabilité de Copaya.

Les chantiers se réaliseront de préférence entre 6h30 et 17h00. 
Tout chantier planifié en dehors de ces horaires sera réalisé avec l’accord écrit de Copaya.

Avant toute intervention à proximité d’un ouvrage électrique, il est impératif d’envoyer une DT-DICT (Déclaration de Travaux - Déclaration d’Intention de Commencement de Travaux) au moins 15 jours avant le début des travaux.`, image:"images/copaya_maintenance.png" },
  'Environnement Copaya':{ text:`l’intervention dans des zones protégées, la préservation des espèces (périodes de nidification, par exemple) et la gestion des risques d’incendie sont encadrées par une réglementation qui évolue, en même temps que la prise de conscience environnementale`, image:"images/copaya_environnement.png" },
  'Sécurité Copaya':{ text:`Le Titulaire devra s’équiper d'Equipements de Protection Collectifs (EPC) et d’Equipements de Protection Individuels (EPI), à savoir :
- Balisage des zones de travail avec cônes pour matérialiser la zone de travail sur route
- Gyrophare/voyants lumineux
- Panneaux de chantier posés a minima 50m avant le chantier
- Casque
- Gants de manutention
- Protection auditive
- Vêtement de protection
- Chaussures de sécurité
- Matériel d’ascension conforme (contrôle métrologique à jour)`, image:"images/copaya_securite.png" }
};

/* COPAYA B */
const data5={
  'Directrice Carl':{ 
    text:`Ce projet est d’une grande importance pour l’entreprise COPAYA. Nous voulons fournir la même qualité de service à l’ensemble des habitants présents sur le territoire. Tous les moyens seront mis en œuvre pour respecter les délais et limiter les nuisances. Il est important de finaliser les travaux avant la prochaine saison des pluies.`,
    image:"images/copaya_directrice.png"
  },
  'Équipe Carl':{
    text:`Le titulaire transmettra son planning permettant de réaliser la fiche de déroulement des opérations (FDO).
Les communications seront réalisées via un outil dont les modalités de connexion seront transmises ultérieurement.
Copaya fournira les câbles, la boîte de jonction et un local de stockage tandis que le Titulaire devra nous transmettre les chambres de tirage.`,
    image:"images/copaya_equipe.png"
  },
  'Manager Carl':{
    text:`Voici les consignes :

- Mise en souterrain de 20 km de réseau HTA et 15 km de fibres optiques
- Confection de 60 boîtes de jonction HTA
- Fourniture et pose de fourreaux
- Réalisation d’une fouille pour la pose d’une armoire
- Réalisation d’une dalle de propreté autour de l’armoire
- Installation et mise en service de l’armoire
- Raccordement et étiquetage des câbles HTA
- Durée du chantier : 4 mois`,
    image:"images/copaya_manager.png"
  },
  'Habitants Carl':{
    text:`Nous attendons ces travaux avec impatience. Ces travaux permettront de stabiliser le réseau électrique. Nous espérons que les impacts sur la chaussée et sur le volume sonore seront minimisés dans le quartier.`,
    image:"images/copaya_habitants.png"
  },
  'Juriste Carl':{
    text:`Les tranchées devront respecter les conditions imposées par la DGTM (Direction Générale des Territoires et de la Mer) concernant les travaux prévus sur la voie publique.
Avant tous travaux sur le domaine public, le prestataire devra effectuer une déclaration de commencement de travaux. Avant l’ouverture du chantier, il transmettra les éléments au Maître d’Ouvrage.
Le Titulaire réalisera l’ensemble des investigations complémentaires (IC) et opérations de localisation (OL) nécessaires à l’exécution des travaux conformément au décret n°2011-12.`,
    image:"images/copaya_juriste.png"
  },
  'Prévention Carl':{
    text:`Le Titulaire devra prendre toutes les dispositions nécessaires pour assurer la sécurité des biens et des personnes :

- Balisage des zones de travail avec cônes pour matérialiser la zone de travail sur route 
- Gyrophare/voyants lumineux 
- Panneaux de chantier posés a minima 50 m avant le chantier

Des visites régulières de prévention sécurité seront organisées par COPAYA pour s’assurer de la conformité du chantier.`,
    image:"images/copaya_prevention.png"
  }
};

/* TILESA B */
const data6={
  'Direction Tilesa B':{ 
    text:`Dans le cadre de son engagement en faveur du développement durable et de la réduction des émissions de gaz à effet de serre, Tilesa souhaite électrifier sa flotte de véhicules en Guyane Française. La flotte actuelle compte 150 véhicules dont 30% doivent être remplacés par des modèles électriques.`,
    image:"images/direction.png" 
  },
  'Manager Tilesa B':{ 
    text:`Le Titulaire du marché devra assurer :

- La fourniture de véhicules électriques neufs, homologués pour le territoire français et adaptés à l’environnement guyanais 
- La livraison des véhicules sur les différents sites : Cayenne, Kourou, Saint-Laurent-du-Maroni…
- La mise en service complète (immatriculation locale, première charge, vérifications fonctionnelles) 
- La formation des utilisateurs à la conduite de véhicules électriques 
- La fourniture de la documentation complète (certificats de conformité, manuels, garanties)
- Le service après-vente assuré localement ou via un partenaire agréé en Guyane.
- Les véhicules seront livrées lors des jours d’ouverture des sites`,
    image:"images/manager.png" 
  },
  'Services Tilesa B':{ 
    text:`Trois collègues échangent sur les besoins :

- Service réseau : Véhicules tout-chemin électriques ou hybrides rechargeables pour zones d’accès difficile.
- Clientèle :  Petits utilitaires électriques pour transport de matériel et d’équipes techniques
- Finance : Berlines ou citadines électriques pour déplacements professionnels`,
    image:"images/services.png" 
  },
  'Technique Tilesa B':{ 
    text:`Le Titulaire prendra en charge :

- Les frais d’acheminement jusqu’en Guyane (transport maritime, douane, manutention, livraison finale)
- Les formalités administratives d’immatriculation sur le territoire
- La fourniture de tous les équipements de base (câbles de recharge, kit sécurité, roue de secours ou kit anti-crevaison)

L’entreprise assurera :
- La mise à disposition des emplacements nécessaires à la réception et au stationnement des véhicules
- L’assurance des véhicules
- L’installation et l’entretien des bornes de recharge
- Le suivi administratif (cartes grises, fiscalité, contrôles périodiques)`,
    image:"images/technique.png" 
  },
  'Juriste Tilesa B':{ 
    text:`Face à l’urgence climatique, l’Union européenne a mis en place un cadre réglementaire ambitieux pour accélérer l’électrification du parc automobile.  Parmi les mesures phares :

- l’interdiction de la vente des voitures thermiques neuves à partir de 2035
- la norme CAFE, le recyclage des batteries et la mise en place d’un passeport numérique de batterie.`,
    image:"images/juriste.png" 
  },
  'Environnement Tilesa B':{ 
    text:`Nos objectifs sont les suivants :
- Réduction mesurable des émissions de CO₂ et des coûts énergétiques
- Amélioration du confort de conduite et de la sécurité des utilisateurs
- Fonctionnement optimal des véhicules malgré les contraintes territoriales.`,
    image:"images/responsable_environnement.png" 
  }
};

let currentGame=0,currentKey='';const sets={1:new Set(),2:new Set(),3:new Set(),4:new Set(),5:new Set(),6:new Set()};

function openModal(key,game){
  currentGame=game; currentKey=key;
  const src= game===2?data2 : game===3?data3 : game===4?data4 : game===5?data5 : game===6?data6 : data1;
  const it=src[key];
  document.getElementById('modalTitle').textContent=key.replace(' Tilesa B','').replace(' B','').replace(' Copaya','').replace(' Carl','');
  document.getElementById('modalImage').src=it.image;
  document.getElementById('modalText').textContent=it.text;
  document.getElementById('overlay').classList.add('active');
  document.getElementById('modal').classList.add('active');
}
function closeModal(){document.getElementById('overlay').classList.remove('active');document.getElementById('modal').classList.remove('active');}

function collectInfo(){
  const set=sets[currentGame]; set.add(currentKey);
  const clean = s => s.replace(' Tilesa B','').replace(' B','').replace(' Copaya','').replace(' Carl','');
  const el=document.getElementById('infoLog'+currentGame);
  if(el) el.textContent="Infos collectées : "+Array.from(set).map(clean).join(', ');
  closeModal();
}

/* ----------------------- QCM unique par jeu ----------------------- */
const BUILDER = {
  3: { // LESATI B
    steps: [
      {id:'objet',label:'Objet',help:'Couvre l’achat d’équipements pour la centrale hydraulique.',options:[
        'Fourniture d’équipements pour exploitation/maintenance centrale hydraulique (Sinnamary)',
        'Achat de 3 groupes électrogènes neufs',
        'Prestations de nettoyage industriel'
      ]},
      {id:'ctx',label:'Contexte',help:'Rôle et portée du barrage.',options:[
        'Barrage de Sinnamary : retenue ~310 km², alimente 2/3 du littoral',
        'Projet urbain hors énergie',
        'Site isolé sans production électrique'
      ]},
      {id:'def',label:'Définition de la prestation',options:[
        'Pompes, moteurs, kits, capteurs, pressostats/manomètres, filtres, clapets, vannes, actionneurs',
        'Mobilier de bureau',
        'Déploiement national de fibre optique'
      ]},
      {id:'lim_tit',label:'Limites à la charge du titulaire',options:[
        'Remplacement/réparation pendant la garantie en cas de défaillance',
        'Fourniture du personnel d’exploitation 24/7',
        'Approvisionnement en carburant'
      ]},
      {id:'lim_ent',label:'Limites à la charge de l’entreprise',options:[
        'Organisation de la réception (créneaux 8h–12h) & logistique site',
        'Déchargement par transporteur (sauf accord contraire)',
        'Fourniture des plans d’installation interne'
      ]},
      {id:'qual',label:'Qualité',options:[
        'Certificats de conformité, notices, plans d’installation si nécessaire',
        'Aucune exigence documentaire',
        'Tolérance aux pièces non conformes'
      ]},
      {id:'cond',label:'Conditions d’interventions',options:[
        'Préavis 21 jours, protection humidité/chocs, étiquetage clair',
        'Livraison à toute heure sans RDV',
        'Pas de contrôle des colis'
      ]},
      {id:'res',label:'Résultats attendus',options:[
        'Équipements conformes & opérationnels, rapport d’essais fourni',
        'Équipements partiels acceptés',
        'Rapport non nécessaire'
      ]},
      {id:'rec',label:'Réception',options:[
        'Contrôle des documents & essais, PV de réception',
        'Réception tacite sans vérification',
        'Livraison = réception automatique'
      ]}
    ],
    answerKey: { objet:[0], ctx:[0], def:[0], lim_tit:[0], lim_ent:[0,1], qual:[0], cond:[0], res:[0], rec:[0] }
  },
  4: { // COPAYA A
    steps: [
      {id:'objet',label:'Objet',options:[
        'Élagage de la végétation autour des ouvrages HTA/HTB en Guyane',
        'Raccordement HTA d’un village',
        'Nettoyage des locaux'
      ]},
      {id:'ctx',label:'Contexte',options:[
        'Végétation rapide : risques pour tiers et coupures clients',
        'Contexte sans risque identifié',
        'Projet maritime uniquement'
      ]},
      {id:'def',label:'Définition de la prestation',help:'Inclure les distances annuelles.',
       options:[
         'Élagage HTA 405 km/an, HTB 250 km/an, 100 pieds de support/an + accès',
         'Balayage de bureaux',
         'Pose d’armoire HTA'
       ]},
      {id:'lim_tit',label:'Limites à la charge du titulaire',help:'Sans EPC/EPI ici (couverts par Sécurité).',options:[
        'Compte rendu précis avec photos avant/après',
        'Respect procédures (DT-DICT 15 jours) & créneaux 6h30–17h',
        'Utilisation des plans & procédures fournis par Copaya',
        'Respect des EPC/EPI (casque, gants, panneaux 50m, gyrophare, etc.)'
      ]},
      {id:'lim_ent',label:'Limites à la charge de l’entreprise',options:[
        'Procédures d’accès & plans fournis par Copaya',
        'Copaya réalise les élagages',
        'Copaya fournit l’outillage'
      ]},
      {id:'qual',label:'Qualité',options:[
        'Traçabilité par CR zone + photos avant/après',
        'Aucune preuve',
        'CR oral uniquement'
      ]},
      {id:'cond',label:'Conditions d’interventions',options:[
        'Chantiers 6h30–17h ; hors horaires sur accord écrit ; DT-DICT 15 jours',
        'Sans autorisation',
        'Travail de nuit imposé'
      ]},
      {id:'res',label:'Résultats attendus',options:[
        'Élagage conforme, continuité de service améliorée',
        'Aucune contrainte',
        'Résultat non mesuré'
      ]},
      {id:'rec',label:'Réception',options:[
        'Contrôle de chaque zone élaguée + CR/photos',
        'Réception tacite',
        'Auto-réception titulaire'
      ]}
    ],
    answerKey: { objet:[0], ctx:[0], def:[0], lim_tit:[0,1,2], lim_ent:[0], qual:[0], cond:[0], res:[0], rec:[0] }
  },
  5: { // COPAYA B
    steps: [
      {id:'objet',label:'Objet',help:'Choisir l’unique bonne réponse.',options:[
        'Raccordement au réseau électrique d’un village situé en Guyane Française',
        'Réalisation des fouilles et dalle de propreté',
        'Stabilisation du réseau électrique pour les habitants',
        'Respect des normes techniques HTA et DT/DICT'
      ]},
      {id:'ctx',label:'Contexte',options:[
        'Finaliser avant saison des pluies, limiter nuisances, qualité uniforme',
        'Projet sans échéance ni contrainte',
        'Intervention hors réseau électrique'
      ]},
      {id:'def',label:'Définition de la prestation',options:[
        '20 km HTA + 15 km fibre ; 60 boîtes HTA ; fourreaux ; fouille + dalle ; armoire ; raccordement/étiquetage',
        'Élagage de 405 km',
        'Nettoyage de voirie'
      ]},
      {id:'lim_tit',label:'Limites à la charge du titulaire',options:[
        'Transmission planning pour FDO',
        'Fourniture des chambres de tirage',
        'Communication via l’outil spécifié',
        'Fourniture des câbles HTA (fourni par Copaya)'
      ]},
      {id:'lim_ent',label:'Limites à la charge de l’entreprise',options:[
        'Copaya fournit câbles, boîtes de jonction, local de stockage',
        'Copaya réalise le chantier',
        'Copaya s’occupe des DT/DICT uniquement'
      ]},
      {id:'qual',label:'Qualité',options:[
        'Conformité DGTM + IC/OL selon décret n°2011-12',
        'Pas de suivi',
        'Réduction du bruit non vérifiée'
      ]},
      {id:'cond',label:'Conditions d’interventions',options:[
        'Balisage cônes, panneaux 50 m, gyrophare ; visites de prévention',
        'Sans balisage',
        'Travaux de nuit obligatoires'
      ]},
      {id:'res',label:'Résultats attendus',options:[
        'Raccordement conforme, impacts chaussée/bruit minimisés',
        'Durée indéfinie',
        'Livraison partielle'
      ]},
      {id:'rec',label:'Réception',options:[
        'Contrôles réglementaires + PV',
        'Auto-réception',
        'Réception tacite'
      ]}
    ],
    answerKey: { objet:[0], ctx:[0], def:[0], lim_tit:[0,1,2], lim_ent:[0], qual:[0], cond:[0], res:[0], rec:[0] }
  },
  6: { // TILESA B
    steps: [
      {id:'objet',label:'Objet',options:[
        'Achat de véhicules électriques neufs pour renouveler la flotte',
        'Prestations d’élagage HTB',
        'Raccordement HTA'
      ]},
      {id:'ctx',label:'Contexte',options:[
        'Flotte 150 véhicules, 30% à remplacer ; électrification en Guyane',
        'Achat de camions thermiques',
        'Aucun objectif de décarbonation'
      ]},
      {id:'def',label:'Définition de la prestation',options:[
        'VE homologués FR adaptés Guyane ; livraison ; mise en service ; formation ; docs ; SAV local',
        'Livraison sans mise en service',
        'Sans formation utilisateur'
      ]},
      {id:'lim_tit',label:'Limites à la charge du titulaire',options:[
        'Acheminement, immatriculation, équipements de base',
        'Installation & entretien des bornes de recharge',
        'Suivi administratif complet'
      ]},
      {id:'lim_ent',label:'Limites à la charge de l’entreprise',options:[
        'Emplacements de réception & stationnement ; assurance des véhicules',
        'Formation des utilisateurs',
        'Achat de carburant'
      ]},
      {id:'qual',label:'Qualité',options:[
        'Certificats, manuels, garanties ; SAV local/agréé',
        'Aucun document',
        'SAV uniquement hors Guyane'
      ]},
      {id:'cond',label:'Conditions d’interventions',options:[
        'Livraisons les jours d’ouverture des sites',
        'Livraison week-end uniquement',
        'Sans rendez-vous'
      ]},
      {id:'res',label:'Résultats attendus',options:[
        'VE opérationnels, confort/sécurité améliorés, réduction CO₂ et coûts',
        'Aucun indicateur',
        'Performance non mesurée'
      ]},
      {id:'rec',label:'Réception',options:[
        'Contrôle docs + vérifications fonctionnelles, PV de réception',
        'Réception tacite',
        'Sans essai'
      ]}
    ],
    answerKey: { objet:[0], ctx:[0], def:[0], lim_tit:[0], lim_ent:[0], qual:[0], cond:[0], res:[0], rec:[0] }
  }
};

// Gating: collecte obligatoire avant builder
function collectedCountFor(gameId){
  const len = (gameId===3?Object.keys(data3).length:gameId===4?Object.keys(data4).length:gameId===5?Object.keys(data5).length:gameId===6?Object.keys(data6).length:0);
  return { have: sets[gameId].size, need: len };
}

function startBuilder(gameId, reset){
  const gate = collectedCountFor(gameId);
  if(gate.need>0 && gate.have<gate.need){
    alert(`Veuillez d’abord collecter toutes les informations (${gate.have}/${gate.need}).`);
    return;
  }
  const cfg = BUILDER[gameId];
  const container=document.getElementById('builderContainer');
  container.innerHTML = `<h2>${({3:"LESATI — Jeu B",4:"COPAYA — Jeu A",5:"COPAYA — Jeu B",6:"TILESA — Jeu B"})[gameId]} — Assistant (QCM)</h2>
    <div class="muted">Sélectionnez les éléments pertinents à chaque étape. Les aides sont facultatives.</div>
    <div class="progress"><span id="builderProgress"></span></div>
    <div class="tabs" id="builderTabs"></div>
    <div id="builderPanels"></div>
    <div class="warn" id="builderWarn">Veuillez sélectionner au moins un élément dans cet onglet pour continuer.</div>
    <div style="display:flex;gap:.5rem;justify-content:space-between;margin-top:1rem;">
      <button class="btn secondary" onclick="goTo('game'+gameId)">◀ Retour carte</button>
      <div>
        <button class="btn secondary" id="prevStep">◀ Précédent</button>
        <button class="btn" id="nextStep">Suivant ▶</button>
        <button class="btn" id="finishBuilder" style="display:none">Générer le résumé</button>
      </div>
    </div>`;
  window._builderSteps = cfg.steps;
  window._answerKey = cfg.answerKey;
  window._builderSelections = {}; window._builderIndex=0;
  const tabs=document.getElementById('builderTabs');
  const panels=document.getElementById('builderPanels');
  cfg.steps.forEach((s,i)=>{
    const b=document.createElement('button'); b.className='tab-btn'+(i===0?' active':''); b.textContent=`${i+1}. ${s.label}`; b.onclick=()=>goStep(i); tabs.appendChild(b);
    const p=document.createElement('div'); p.className='tab-panel'+(i===0?' active':''); p.id=`panel-${s.id}`;
    p.innerHTML=`<h3>${i+1}. ${s.label}</h3>${s.help?`<details><summary>Aide (facultatif)</summary><p>${s.help}</p></details>`:''}
      <div class="helper">Sélectionnez les éléments pertinents pour votre CCTP.</div>
      <div class="option-grid">${s.options.map((opt,idx)=>`<div class="option"><label><input type="checkbox" data-step="${s.id}" data-opt="${idx}"> ${opt}</label></div>`).join('')}</div>`;
    p.addEventListener('change',(e)=>{
      const box=e.target; if(box && box.type==='checkbox'){
        const sid=box.dataset.step; const idx=Number(box.dataset.opt);
        if(!window._builderSelections[sid]) window._builderSelections[sid]=new Set();
        if(box.checked) window._builderSelections[sid].add(idx); else window._builderSelections[sid].delete(idx);
      }
    });
    panels.appendChild(p);
  });
  document.getElementById('prevStep').onclick=()=>goStep(window._builderIndex-1);
  document.getElementById('nextStep').onclick=()=>{ if(!hasAtLeastOne(window._builderSteps[window._builderIndex].id)){document.getElementById('builderWarn').style.display='block';return;} document.getElementById('builderWarn').style.display='none'; goStep(window._builderIndex+1); };
  document.getElementById('finishBuilder').onclick=()=>{ if(!hasAtLeastOne(window._builderSteps[window._builderIndex].id)){document.getElementById('builderWarn').style.display='block';return;} document.getElementById('builderWarn').style.display='none'; finishBuilder(gameId); };
  goStep(0);
  goTo('builder');
}
function hasAtLeastOne(stepId){const set=window._builderSelections[stepId];return set && set.size>0;}
function goStep(i){
  if(i<0||i>=window._builderSteps.length) return; window._builderIndex=i;
  [...document.querySelectorAll('#builderTabs .tab-btn')].forEach((b,k)=>b.classList.toggle('active',k===i));
  [...document.querySelectorAll('#builderPanels .tab-panel')].forEach(p=>p.classList.remove('active'));
  document.getElementById(`panel-${window._builderSteps[i].id}`).classList.add('active');
  const pct=Math.round((i)/(window._builderSteps.length-1)*100); document.getElementById('builderProgress').style.width=pct+'%';
  document.getElementById('prevStep').disabled=(i===0);
  document.getElementById('nextStep').style.display=(i===window._builderSteps.length-1)?'none':'inline-block';
  document.getElementById('finishBuilder').style.display=(i===window._builderSteps.length-1)?'inline-block':'none';
}
function finishBuilder(gameId){
  let html='<h2>Résumé — '+({3:"LESATI — Jeu B",4:"COPAYA — Jeu A",5:"COPAYA — Jeu B",6:"TILESA — Jeu B"}[gameId])+'</h2>';
  window._builderSteps.forEach((s,i)=>{
    const picked=[...(window._builderSelections[s.id]||[])].sort((a,b)=>a-b);
    if(picked.length){ html+=`<h4>${i+1}. ${s.label}</h4><ul>`+picked.map(idx=>`<li>${s.options[idx]}</li>`).join('')+'</ul>'; }
  });
  if(html==='') html="<p>Aucun élément sélectionné. Revenez dans l’assistant pour choisir vos options.</p>";
  // score
  let total=0, ok=0;
  window._builderSteps.forEach(s=>{
    const key=window._answerKey[s.id]||[]; total+=key.length;
    const picked=window._builderSelections[s.id]?Array.from(window._builderSelections[s.id]):[];
    ok += picked.filter(i=>key.includes(i)).length;
  });
  const pct=total?Math.round((ok/total)*100):0;
  let lvl='Débutant', cls='debutant';
  if(pct>95){lvl='Génie';cls='genie';}
  else if(pct>=71){lvl='Expert';cls='expert';}
  else if(pct>=51){lvl='Avancé';cls='avance';}
  // display
  html+=`<div class="score" style="display:block">Score : ${ok} / ${total} (${pct}%) <span class="badge ${cls}">${lvl}</span></div>`;
  document.getElementById('summaryContainer').innerHTML=html+`<div style="display:flex;gap:.5rem;margin-top:12px"><button class="btn" onclick="goTo('home')">Retour à l'accueil</button><button class="btn secondary" onclick="goTo('game${gameId}')">Revenir à la carte</button></div>`;
  goTo('summary');
}
</script>
</body>
</html>
